<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Store | Gigantic Data Hub</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #0f172a, #020617);
            min-height: 100vh;
            color: #f8fafc;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .accent-gradient {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        }
        .step-inactive { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
        
        #statusModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.9);
            backdrop-filter: blur(12px);
            z-index: 9999;
            align-items: center; justify-content: center; padding: 20px;
        }
        .modal-box {
            background: #1e293b;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 32px;
            max-width: 400px; width: 100%;
            padding: 40px; text-align: center;
            animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes modalPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="p-4 lg:p-8">

    <div id="statusModal">
        <div class="modal-box">
            <div id="modalIcon" class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl"></div>
            <h2 id="modalTitle" class="text-xl font-extrabold mb-2 uppercase tracking-tighter"></h2>
            <p id="modalMsg" class="text-slate-400 text-sm leading-relaxed"></p>
            <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden mt-8">
                <div id="progressBar" class="h-full bg-indigo-500 w-0 transition-all duration-[3000ms]"></div>
            </div>
        </div>
    </div>

    <div class="max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <aside class="lg:col-span-3 space-y-4">
            <div class="glass-card rounded-[2rem] p-6 text-center">
                <div class="w-16 h-16 accent-gradient rounded-2xl mx-auto mb-4 flex items-center justify-center text-2xl shadow-lg shadow-indigo-500/20">
                    <i class="fas fa-bolt"></i>
                </div>
                <h3 class="font-black text-sm uppercase tracking-widest text-indigo-400">Agent Hub</h3>
            </div>

            <nav class="space-y-2">
                <a href="#" class="flex items-center gap-4 p-4 rounded-2xl bg-white/5 border border-white/5 text-sm font-bold text-white transition-all hover:bg-white/10">
                    <i class="fas fa-shopping-cart w-5"></i> Buy Data
                </a>
                <a href="agent_orders.html" class="flex items-center gap-4 p-4 rounded-2xl text-slate-400 text-sm font-bold transition-all hover:text-white hover:bg-white/5">
                    <i class="fas fa-list-ul w-5"></i> Agent Orders
                </a>
                <a href="transactions.html" class="flex items-center gap-4 p-4 rounded-2xl text-slate-400 text-sm font-bold transition-all hover:text-white hover:bg-white/5">
                    <i class="fas fa-exchange-alt w-5"></i> Customer Sales
                </a>
                <a href="withdraw.html" class="flex items-center gap-4 p-4 rounded-2xl text-slate-400 text-sm font-bold transition-all hover:text-white hover:bg-white/5">
                    <i class="fas fa-wallet w-5"></i> Withdraw
                </a>
            </nav>
        </aside>

        <main class="lg:col-span-9">
            <div class="mb-8">
                <div id="greeting" class="text-[10px] font-black uppercase tracking-[0.4em] text-indigo-400 mb-2">Welcome</div>
                <h1 id="storeName" class="text-3xl font-extrabold text-white tracking-tight uppercase italic">Emmanuel Data Store</h1>
                <p class="text-slate-500 text-sm mt-1" id="welcomeMsg">Welcome to our store. We promise you the fastest data delivery in Ghana!</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="glass-card rounded-[2.5rem] p-8">
                    <div class="mb-8">
                        <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4">1. Select Network</label>
                        <div class="grid grid-cols-3 gap-3">
                            <button onclick="selectNet('MTN')" id="net-MTN" class="p-4 rounded-2xl bg-slate-900/50 border border-white/5 flex flex-col items-center gap-2 hover:border-indigo-500 transition-all">
                                <div class="w-8 h-8 bg-[#FFCC00] rounded-lg text-black font-black flex items-center justify-center text-[10px]">MTN</div>
                                <span class="text-[9px] font-black uppercase">MTN</span>
                            </button>
                            <button onclick="selectNet('AIRTELTIGO')" id="net-AIRTELTIGO" class="p-4 rounded-2xl bg-slate-900/50 border border-white/5 flex flex-col items-center gap-2 hover:border-indigo-500 transition-all">
                                <div class="w-8 h-8 bg-[#ED1C24] rounded-lg text-white font-black flex items-center justify-center text-[10px]">AT</div>
                                <span class="text-[9px] font-black uppercase">AirtelTigo</span>
                            </button>
                            <button onclick="selectNet('TELECEL')" id="net-TELECEL" class="p-4 rounded-2xl bg-slate-900/50 border border-white/5 flex flex-col items-center gap-2 hover:border-indigo-500 transition-all">
                                <div class="w-8 h-8 bg-[#E60000] rounded-lg text-white font-black flex items-center justify-center text-[10px]">TEL</div>
                                <span class="text-[9px] font-black uppercase">Telecel</span>
                            </button>
                        </div>
                    </div>

                    <div id="step2" class="step-inactive mb-8">
                        <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4">2. Recipient Number</label>
                        <div class="relative">
                            <input type="tel" id="phoneNumber" maxlength="10" placeholder="024XXXXXXX" 
                                class="w-full bg-slate-950/50 border border-white/10 rounded-2xl py-5 px-6 text-xl font-bold outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                            <div id="simNameBox" class="hidden mt-3 bg-emerald-500/10 border border-emerald-500/20 p-3 rounded-xl flex items-center gap-3">
                                <i class="fas fa-check-circle text-emerald-500 text-xs"></i>
                                <span id="displaySimName" class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest">Searching...</span>
                            </div>
                        </div>
                    </div>

                    <div id="step3" class="step-inactive">
                        <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4">3. Select Plan</label>
                        <select id="dataPlan" onchange="calculateFinalTotal()" 
                            class="w-full bg-slate-950/50 border border-white/10 rounded-2xl py-5 px-6 text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 appearance-none">
                            <option value="" disabled selected>-- Choose Bundle --</option>
                        </select>
                    </div>
                </div>

                <div class="space-y-6">
                    <div id="summaryCard" class="glass-card rounded-[2.5rem] p-8 step-inactive">
                        <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-6">Order Summary</h4>
                        
                        <div class="space-y-4">
                            <div class="flex justify-between text-xs font-bold">
                                <span class="text-slate-500">Bundle Price</span>
                                <span id="summaryBasePrice">₵ 0.00</span>
                            </div>
                            <div class="flex justify-between text-xs font-bold">
                                <span class="text-slate-500">Service Fee (2.5%)</span>
                                <span id="summaryFee">₵ 0.00</span>
                            </div>
                            <div class="border-t border-white/5 pt-4 mt-2 flex justify-between items-center">
                                <span class="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Grand Total</span>
                                <span id="summaryTotal" class="text-3xl font-black italic text-white">₵ 0.00</span>
                            </div>
                        </div>

                        <button id="payBtn" onclick="initPaystackStore()" 
                            class="w-full mt-8 py-5 rounded-2xl accent-gradient text-white font-black text-sm uppercase tracking-[0.2em] shadow-xl shadow-indigo-500/20 active:scale-[0.98] transition-all">
                            Initialize Payment
                        </button>
                    </div>

                    <div class="glass-card rounded-3xl p-6 flex items-center gap-4 border-l-4 border-indigo-500">
                        <div class="text-indigo-500 text-xl"><i class="fas fa-shield-alt"></i></div>
                        <div>
                            <p class="text-[10px] font-black uppercase text-slate-400 tracking-wider">Secure Transaction</p>
                            <p class="text-[11px] text-slate-300">All payments are encrypted by Paystack PCI-DSS systems.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBmu4xukuT0Z7oD_vA9QroeO-1ZuaK8JgA",
            authDomain: "gigantic-data.firebaseapp.com",
            databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
            projectId: "gigantic-data"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        const PAYSTACK_PK = 'pk_live_faecdb3166144fadebd8269829343698dd43de63';
        const FEE_RATE = 0.025;

        let activeAgentUid = "";
        let agentEmail = "";
        let selectedNet = "";
        let simName = "NOT VERIFIED";
        let finalPayAmount = 0;

        // Pricing List
        const agentPlans = {
            MTN:[{plan:"1GB",price:4.45},{plan:"2GB",price:8.85},{plan:"3GB",price:13.25},{plan:"5GB",price:22.05},{plan:"10GB",price:42.25}],
            AIRTELTIGO:[{plan:"1GB",price:4.3},{plan:"2GB",price:8.56},{plan:"5GB",price:21.4},{plan:"10GB",price:44}],
            TELECEL:[{plan:"10GB",price:45},{plan:"20GB",price:84}]
        };

        // Initialize Store Data
        auth.onAuthStateChanged(user => {
            if (user) {
                activeAgentUid = user.uid;
                agentEmail = user.email;
                loadAgentData();
            } else {
                window.location.replace("login.html");
            }
        });

        function loadAgentData() {
            const hour = new Date().getHours();
            let greet = "Good Morning";
            if(hour >= 12) greet = "Good Afternoon";
            if(hour >= 17) greet = "Good Evening";
            document.getElementById('greeting').innerText = greet;

            database.ref(`users/${activeAgentUid}`).once('value', snapshot => {
                const data = snapshot.val();
                if(data && data.fullName) {
                    const firstName = data.fullName.split(' ')[0];
                    document.getElementById('storeName').innerText = `${firstName} Data Store`;
                    document.getElementById('welcomeMsg').innerText = `Welcome ${firstName} to your professional store. We provide quality services to all customers.`;
                }
            });
        }

        window.selectNet = (net) => {
            selectedNet = net;
            document.querySelectorAll('.network-option').forEach(b => b.classList.remove('border-indigo-500', 'bg-indigo-500/10'));
            document.getElementById(`net-${net}`).classList.add('border-indigo-500', 'bg-indigo-500/10');
            
            // Populate Plans
            const select = document.getElementById('dataPlan');
            select.innerHTML = '<option value="" disabled selected>-- Choose Bundle --</option>';
            agentPlans[net].forEach(p => {
                select.innerHTML += `<option value="${p.price}" data-plan="${p.plan}">${p.plan} Bundle - ₵${p.price}</option>`;
            });

            document.getElementById('step2').classList.remove('step-inactive');
        };

        // SIM NAME LOGIC
        document.getElementById('phoneNumber').oninput = async function(e) {
            const num = e.target.value;
            const box = document.getElementById('simNameBox');
            const nameSpan = document.getElementById('displayAccName');
            
            if(num.length === 10) {
                box.classList.remove('hidden');
                nameSpan.innerText = "VERIFYING SIM...";
                document.getElementById('step3').classList.remove('step-inactive');
                
                const bankCode = { 'MTN': 'MTN', 'AIRTELTIGO': 'ATL', 'TELECEL': 'VOD' }[selectedNet];
                try {
                    const k = atob("YmVhcmVyIA==") + atob("c2tfbGl2ZV8=") + atob("YmZkMjhmYmJlM2NhNDU1YmExNTQ1NWViZWQ3MTM4YjI0MDA5ZDEzNA==");
                    const response = await fetch(`https://api.paystack.co/bank/resolve?account_number=${num}&bank_code=${bankCode}`, {
                        headers: { 'Authorization': k }
                    });
                    const res = await response.json();
                    simName = res.status ? res.data.account_name : "NETWORK VERIFIED";
                    nameSpan.innerText = simName;
                } catch (err) { 
                    simName = "SYNCED";
                    nameSpan.innerText = simName; 
                }
            } else { box.classList.add('hidden'); }
        };

        function calculateFinalTotal() {
            const select = document.getElementById('dataPlan');
            const basePrice = parseFloat(select.value);
            const fee = basePrice * FEE_RATE;
            const total = basePrice + fee;
            finalPayAmount = total;

            document.getElementById('summaryBasePrice').innerText = `₵ ${basePrice.toFixed(2)}`;
            document.getElementById('summaryFee').innerText = `₵ ${fee.toFixed(2)}`;
            document.getElementById('summaryTotal').innerText = `₵ ${total.toFixed(2)}`;
            document.getElementById('summaryCard').classList.remove('step-inactive');
        }

        function showStatusModal(title, msg, type = 'success') {
            const modal = document.getElementById('statusModal');
            const icon = document.getElementById('modalIcon');
            const progress = document.getElementById('progressBar');
            
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalMsg').innerText = msg;
            
            if(type === 'success') {
                icon.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl bg-emerald-500/20 text-emerald-500";
                icon.innerHTML = '<i class="fas fa-check"></i>';
                progress.className = "h-full bg-emerald-500 w-0 transition-all duration-[3000ms]";
            } else {
                icon.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl bg-rose-500/20 text-rose-500";
                icon.innerHTML = '<i class="fas fa-times"></i>';
            }

            modal.style.display = 'flex';
            setTimeout(() => { progress.style.width = '100%'; }, 100);
        }

        function initPaystackStore() {
            const amount = finalPayAmount;
            const phone = document.getElementById('phoneNumber').value;
            const planSelect = document.getElementById('dataPlan');
            const planName = planSelect.options[planSelect.selectedIndex].getAttribute('data-plan');

            let handler = PaystackPop.setup({
                key: PAYSTACK_PK,
                email: agentEmail,
                amount: Math.round(amount * 100),
                currency: 'GHS',
                ref: 'AGT-' + Date.now(),
                callback: (response) => {
                    placeOrder(response.reference, phone, planName, planSelect.value);
                }
            });
            handler.openIframe();
        }

        async function placeOrder(ref, phone, plan, baseAmount) {
            const orderId = 'ORD-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            const timestamp = Date.now();
            
            const orderObj = {
                orderId: orderId,
                uid: activeAgentUid,
                recipient: phone,
                network: selectedNet,
                plan: plan,
                amount: parseFloat(baseAmount),
                paidAmount: finalPayAmount,
                simName: simName,
                status: "Pending",
                paymentStatus: "Success",
                paymentRef: ref,
                timestamp: timestamp
            };

            const updates = {};
            updates[`orders/${orderId}`] = orderObj;
            updates[`pending_orders/${orderId}`] = orderObj;
            updates[`user_orders/${activeAgentUid}/${orderId}`] = orderObj;

            try {
                await database.ref().update(updates);
                showStatusModal("Order Placed", `Payment of ₵${finalPayAmount.toFixed(2)} successful. Your data for ${phone} is being processed.`, 'success');
                setTimeout(() => { location.reload(); }, 3500);
            } catch(e) {
                showStatusModal("Database Error", "Payment success but order failed to log. Contact support with Ref: " + ref, 'error');
            }
        }
    </script>
</body>
</html>
