<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gigantic Data Store</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #0f172a, #020617);
            min-height: 100vh;
            color: #f8fafc;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .accent-gradient {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        }
        .step-inactive { opacity: 0.2; pointer-events: none; filter: grayscale(1); }
        
        #statusModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.95);
            backdrop-filter: blur(12px);
            z-index: 9999;
            align-items: center; justify-content: center; padding: 20px;
        }
        .modal-box {
            background: #1e293b;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 32px;
            max-width: 400px; width: 100%;
            padding: 40px; text-align: center;
            animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes modalPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div id="statusModal">
        <div class="modal-box shadow-2xl shadow-indigo-500/10">
            <div id="modalIcon" class="status-icon"></div>
            <h2 id="modalTitle" class="text-xl font-extrabold mb-2 uppercase tracking-tighter"></h2>
            <p id="modalMsg" class="text-slate-400 text-sm leading-relaxed"></p>
            <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden mt-8">
                <div id="progressBar" class="h-full bg-indigo-500 w-0 transition-all duration-[3000ms]"></div>
            </div>
        </div>
    </div>

    <div class="max-w-md w-full">
        <div class="text-center mb-10">
            <div id="greeting" class="text-[10px] font-black uppercase tracking-[0.4em] text-indigo-400 mb-2">Good Day</div>
            <h1 id="storeName" class="text-3xl font-extrabold text-white tracking-tight uppercase italic">Gigantic Store</h1>
            <p class="text-slate-400 text-sm mt-3 px-4 leading-relaxed" id="welcomeMsg">
                Welcome to our premium data portal.
            </p>
        </div>

        <div class="glass-card rounded-[3rem] p-8 shadow-2xl">
            <div class="mb-8">
                <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 ml-1">1. Choose Network</label>
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="selectNet('MTN')" id="net-MTN" class="p-4 rounded-2xl bg-slate-900/50 border border-white/5 flex flex-col items-center gap-2 hover:border-indigo-500 transition-all">
                        <div class="w-8 h-8 bg-[#FFCC00] rounded-lg text-black font-black flex items-center justify-center text-[10px]">MTN</div>
                        <span class="text-[9px] font-black uppercase">MTN</span>
                    </button>
                    <button onclick="selectNet('AIRTELTIGO')" id="net-AIRTELTIGO" class="p-4 rounded-2xl bg-slate-900/50 border border-white/5 flex flex-col items-center gap-2 hover:border-indigo-500 transition-all">
                        <div class="w-8 h-8 bg-[#ED1C24] rounded-lg text-white font-black flex items-center justify-center text-[10px]">AT</div>
                        <span class="text-[9px] font-black uppercase">AirtelTigo</span>
                    </button>
                    <button onclick="selectNet('TELECEL')" id="net-TELECEL" class="p-4 rounded-2xl bg-slate-900/50 border border-white/5 flex flex-col items-center gap-2 hover:border-indigo-500 transition-all">
                        <div class="w-8 h-8 bg-[#E60000] rounded-lg text-white font-black flex items-center justify-center text-[10px]">TEL</div>
                        <span class="text-[9px] font-black uppercase">Telecel</span>
                    </button>
                </div>
            </div>

            <div id="step2" class="step-inactive mb-8">
                <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 ml-1">2. Recipient Number</label>
                <div class="relative">
                    <input type="tel" id="phoneNumber" maxlength="10" placeholder="024XXXXXXX" 
                        class="w-full bg-slate-950/50 border border-white/10 rounded-2xl py-5 px-6 text-xl font-bold outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-white">
                    <div id="simNameBox" class="hidden mt-3 bg-emerald-500/10 border border-emerald-500/20 p-4 rounded-2xl flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                        <span id="displaySimName" class="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Searching...</span>
                    </div>
                </div>
            </div>

            <div id="step3" class="step-inactive mb-10">
                <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 ml-1">3. Select Data Plan</label>
                <div class="relative">
                    <select id="dataPlan" onchange="calculateFinalTotal()" 
                        class="w-full bg-slate-950/50 border border-white/10 rounded-2xl py-5 px-6 text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 appearance-none text-white">
                        <option value="" disabled selected>-- Choose Bundle --</option>
                    </select>
                </div>
            </div>

            <div id="summaryCard" class="hidden space-y-4 mb-8 p-6 bg-indigo-500/5 rounded-[2rem] border border-indigo-500/10">
                <div class="flex justify-between text-[10px] font-bold uppercase tracking-widest text-slate-500">
                    <span>Bundle Cost</span>
                    <span id="summaryBasePrice" class="text-white font-black">₵ 0.00</span>
                </div>
                <div class="flex justify-between text-[10px] font-bold uppercase tracking-widest text-slate-500">
                    <span>Service Fee (2.5%)</span>
                    <span id="summaryFee" class="text-rose-400 font-black">₵ 0.00</span>
                </div>
                <div class="border-t border-white/5 pt-4 flex justify-between items-center">
                    <span class="text-[10px] font-black text-indigo-400 uppercase tracking-[0.2em]">Total To Pay</span>
                    <span id="summaryTotal" class="text-3xl font-black italic text-white">₵ 0.00</span>
                </div>
            </div>

            <button id="payBtn" onclick="initPaystackStore()" disabled
                class="w-full py-6 rounded-3xl accent-gradient text-white font-black text-sm uppercase tracking-[0.2em] shadow-2xl shadow-indigo-500/30 active:scale-[0.98] transition-all disabled:opacity-20">
                Pay & Receive Data
            </button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBmu4xukuT0Z7oD_vA9QroeO-1ZuaK8JgA",
            authDomain: "gigantic-data.firebaseapp.com",
            databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
            projectId: "gigantic-data"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const PAYSTACK_PK = 'pk_live_faecdb3166144fadebd8269829343698dd43de63';
        const FEE_RATE = 0.025;

        const urlParams = new URLSearchParams(window.location.search);
        const storeSlug = urlParams.get('s');
        
        let agentUid = "";
        let agentEmail = "";
        let selectedNet = "";
        let simName = "NOT VERIFIED";
        let finalPayAmount = 0;

        const agentPlans = {
            MTN:[{plan:"1GB",price:4.45},{plan:"2GB",price:8.85},{plan:"3GB",price:13.25},{plan:"5GB",price:22.05},{plan:"10GB",price:42.25}],
            AIRTELTIGO:[{plan:"1GB",price:4.3},{plan:"2GB",price:8.56},{plan:"5GB",price:21.4},{plan:"10GB",price:44}],
            TELECEL:[{plan:"10GB",price:45},{plan:"20GB",price:84}]
        };

        async function initStore() {
            const hour = new Date().getHours();
            let greet = hour < 12 ? "Good Morning" : hour < 17 ? "Good Afternoon" : "Good Evening";
            document.getElementById('greeting').innerText = greet;
            try {
                const slugSnap = await database.ref(`slugs/${storeSlug}`).once('value');
                if(slugSnap.exists()) {
                    agentUid = slugSnap.val();
                    const userSnap = await database.ref(`users/${agentUid}`).once('value');
                    const u = userSnap.val();
                    document.getElementById('storeName').innerText = u.storeSettings.storeName;
                    document.getElementById('welcomeMsg').innerText = `Welcome to ${u.storeSettings.storeName}! Experience instant data fulfillment.`;
                    agentEmail = u.email;
                }
            } catch(e) {}
        }
        initStore();

        window.selectNet = (net) => {
            selectedNet = net;
            document.querySelectorAll('button[id^="net-"]').forEach(b => b.classList.remove('border-indigo-500', 'bg-indigo-500/10'));
            document.getElementById(`net-${net}`).classList.add('border-indigo-500', 'bg-indigo-500/10');
            const select = document.getElementById('dataPlan');
            select.innerHTML = '<option value="" disabled selected>-- Choose Bundle --</option>';
            agentPlans[net].forEach(p => {
                select.innerHTML += `<option value="${p.price}" data-plan="${p.plan}">${p.plan} Bundle - ₵${p.price}</option>`;
            });
            document.getElementById('step2').classList.remove('step-inactive');
        };

        document.getElementById('phoneNumber').oninput = async function(e) {
            const num = e.target.value;
            if(num.length === 10) {
                document.getElementById('simNameBox').classList.remove('hidden');
                document.getElementById('displaySimName').innerText = "SYNCING SIM...";
                const bankCode = { 'MTN': 'MTN', 'AIRTELTIGO': 'ATL', 'TELECEL': 'VOD' }[selectedNet];
                try {
                    const k = atob("YmVhcmVyIA==") + atob("c2tfbGl2ZV8=") + atob("YmZkMjhmYmJlM2NhNDU1YmExNTQ1NWViZWQ3MTM4YjI0MDA5ZDEzNA==");
                    const response = await fetch(`https://api.paystack.co/bank/resolve?account_number=${num}&bank_code=${bankCode}`, {
                        headers: { 'Authorization': k }
                    });
                    const res = await response.json();
                    simName = res.status ? res.data.account_name : "NAME VERIFIED";
                    document.getElementById('displaySimName').innerText = simName;
                    document.getElementById('step3').classList.remove('step-inactive');
                } catch (err) { simName = "SYNCED"; document.getElementById('displaySimName').innerText = simName; }
            }
        };

        function calculateFinalTotal() {
            const basePrice = parseFloat(document.getElementById('dataPlan').value);
            const fee = basePrice * FEE_RATE;
            finalPayAmount = basePrice + fee;
            document.getElementById('summaryBasePrice').innerText = `₵ ${basePrice.toFixed(2)}`;
            document.getElementById('summaryFee').innerText = `₵ ${fee.toFixed(2)}`;
            document.getElementById('summaryTotal').innerText = `₵ ${finalPayAmount.toFixed(2)}`;
            document.getElementById('summaryCard').classList.remove('hidden');
            document.getElementById('payBtn').disabled = false;
        }

        function showStatusModal(title, msg, type = 'success') {
            const modal = document.getElementById('statusModal');
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalMsg').innerText = msg;
            const icon = document.getElementById('modalIcon');
            const progress = document.getElementById('progressBar');
            
            if(type === 'success') {
                icon.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl bg-emerald-500/20 text-emerald-500";
                icon.innerHTML = '<i class="fas fa-check"></i>';
                progress.className = "h-full bg-indigo-500";
            } else {
                icon.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl bg-rose-500/20 text-rose-500";
                icon.innerHTML = '<i class="fas fa-times"></i>';
                progress.className = "h-full bg-rose-500";
            }
            modal.style.display = 'flex';
            setTimeout(() => { progress.style.width = '100%'; }, 50);
        }

        function initPaystackStore() {
            const planSelect = document.getElementById('dataPlan');
            const planName = planSelect.options[planSelect.selectedIndex].getAttribute('data-plan');
            const phone = document.getElementById('phoneNumber').value;

            let handler = PaystackPop.setup({
                key: PAYSTACK_PK,
                email: agentEmail || 'store-customer@giganticdata.com',
                amount: Math.round(finalPayAmount * 100),
                currency: 'GHS',
                ref: 'ST-' + Date.now(),
                callback: (response) => {
                    executeAutoOrder(response.reference, phone, planName, planSelect.value);
                }
            });
            handler.openIframe();
        }

        

        async function executeAutoOrder(reference, phone, plan, baseAmount) {
            const btn = document.getElementById('payBtn');
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin mr-2"></i> VERIFYING...`;
            btn.disabled = true;

            const orderId = 'ORD-' + reference;
            const timestamp = Date.now();

            // 1. Log the order as "Processing" immediately
            const orderObj = {
                orderId: orderId,
                agentId: agentUid,
                recipient: phone,
                network: selectedNet,
                plan: plan,
                amount: parseFloat(baseAmount),
                paidAmount: finalPayAmount,
                simName: simName,
                status: "Processing",
                paymentStatus: "Success",
                paymentRef: reference,
                timestamp: timestamp
            };

            const updates = {};
            updates[`orders/${orderId}`] = orderObj;
            updates[`pending_orders/${orderId}`] = orderObj;
            updates[`user_orders/${agentUid}/${orderId}`] = orderObj;

            try {
                await database.ref().update(updates);

                // 2. Trigger Cloud Function for Verification & API call
                const response = await fetch('https://us-central1-gigantic-data.cloudfunctions.net/verifyPayment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        reference: reference, 
                        userId: agentUid,
                        isStoreOrder: true 
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showStatusModal("Success", "Data bundle provisioned successfully!", "success");
                    setTimeout(() => location.reload(), 4000);
                } else {
                    showStatusModal("Queued", "Payment verified. Delivery is being processed by the network.", "success");
                    setTimeout(() => location.reload(), 4500);
                }
            } catch (e) {
                // If fetch times out, the "pending_orders" trigger in index.js will still handle it
                showStatusModal("Order Logged", "Transaction secure. Bundle will arrive in 1-3 minutes.", "success");
                setTimeout(() => location.reload(), 5000);
            }
        }
    </script>
</body>
</html>
