<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store | Gigantic Data Hub</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #0f172a, #020617);
            min-height: 100vh;
            color: #f8fafc;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .accent-gradient {
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
        }
        .network-option {
            border: 2px solid rgba(255,255,255,0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .network-option.selected {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }
        
        /* Modal Animation */
        #statusModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.9);
            backdrop-filter: blur(10px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-box {
            background: #1e293b;
            border-radius: 32px;
            max-width: 400px;
            width: 100%;
            padding: 40px 24px;
            text-align: center;
            animation: modalPop 0.4s ease-out forwards;
        }
        @keyframes modalPop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="flex flex-col items-center justify-start p-4 pt-10">

    <div id="statusModal">
        <div class="modal-box border border-white/10">
            <div id="modalIcon" class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl"></div>
            <h2 id="modalTitle" class="text-2xl font-black mb-2 uppercase italic tracking-tighter"></h2>
            <p id="modalMsg" class="text-slate-400 text-sm leading-relaxed mb-8"></p>
            <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden">
                <div id="progressBar" class="h-full bg-blue-500 w-0 transition-all duration-1000"></div>
            </div>
        </div>
    </div>

    <div class="max-w-md w-full">
        <div class="text-center mb-10">
            <div id="greetingText" class="text-[10px] font-black text-blue-400 uppercase tracking-[0.3em] mb-2">Good Day</div>
            <h1 id="storeName" class="text-4xl font-extrabold tracking-tighter italic uppercase text-white">
                Store Loading...
            </h1>
            <p class="text-slate-500 mt-2 text-sm font-medium" id="welcomeNote">Connecting to secure data server...</p>
        </div>

        <div class="glass-card rounded-[3rem] p-8">
            <div class="mb-8">
                <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 ml-1">1. Choose Network</label>
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="selectNet('MTN')" id="net-MTN" class="network-option bg-slate-900/50 rounded-2xl p-4 flex flex-col items-center">
                        <div class="w-8 h-8 bg-[#FFCC00] rounded-lg mb-2 flex items-center justify-center font-black text-black text-[10px]">MTN</div>
                        <span class="text-[10px] font-bold">MTN</span>
                    </button>
                    <button onclick="selectNet('AIRTELTIGO')" id="net-AIRTELTIGO" class="network-option bg-slate-900/50 rounded-2xl p-4 flex flex-col items-center">
                        <div class="w-8 h-8 bg-[#ED1C24] rounded-lg mb-2 flex items-center justify-center font-black text-white text-[10px]">AT</div>
                        <span class="text-[10px] font-bold">AirtelTigo</span>
                    </button>
                    <button onclick="selectNet('TELECEL')" id="net-TELECEL" class="network-option bg-slate-900/50 rounded-2xl p-4 flex flex-col items-center">
                        <div class="w-8 h-8 bg-[#E60000] rounded-lg mb-2 flex items-center justify-center font-black text-white text-[10px]">TEL</div>
                        <span class="text-[10px] font-bold">Telecel</span>
                    </button>
                </div>
            </div>

            <div class="mb-8 opacity-40 transition-opacity duration-500" id="step2">
                <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3 ml-1">2. Recipient Number</label>
                <input type="tel" id="phoneNumber" maxlength="10" placeholder="024XXXXXXX" 
                    class="w-full bg-slate-900/60 border border-white/5 rounded-2xl py-5 px-6 text-xl font-bold focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                <div id="simNameBox" class="hidden mt-3 bg-emerald-500/10 border border-emerald-500/20 p-3 rounded-xl flex items-center gap-3">
                    <i class="fas fa-check-circle text-emerald-500 text-xs"></i>
                    <span id="displaySimName" class="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Searching...</span>
                </div>
            </div>

            <div class="mb-8 opacity-40 transition-opacity duration-500" id="step3">
                <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3 ml-1">3. Select Bundle</label>
                <select id="planSelect" onchange="calculatePrice()" class="w-full bg-slate-900/60 border border-white/5 rounded-2xl py-5 px-6 text-sm font-bold appearance-none outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="" disabled selected>-- Select Bundle --</option>
                </select>
            </div>

            <div id="pricingBox" class="hidden bg-slate-900/50 rounded-[2rem] p-6 mb-8 border border-white/5 space-y-3">
                <div class="flex justify-between text-[10px] font-black uppercase tracking-widest">
                    <span class="text-slate-500">Data Cost</span>
                    <span class="text-white" id="basePrice">0.00</span>
                </div>
                <div class="flex justify-between text-[10px] font-black uppercase tracking-widest">
                    <span class="text-slate-500">Service Fee (2.5%)</span>
                    <span class="text-white" id="feePrice">0.00</span>
                </div>
                <div class="flex justify-between items-center border-t border-white/5 pt-4 mt-2">
                    <span class="text-[11px] font-black text-blue-400 uppercase tracking-[0.2em]">Total GHS</span>
                    <span class="text-3xl font-black text-white italic" id="totalPrice">₵ 0.00</span>
                </div>
            </div>

            <button onclick="startStorePayment()" id="payBtn" disabled 
                class="w-full py-6 rounded-2xl accent-gradient text-white font-black text-sm uppercase tracking-[0.2em] shadow-2xl shadow-blue-500/30 disabled:opacity-20 transition-all active:scale-[0.97]">
                Pay & Receive Data
            </button>
        </div>

        <div class="mt-10 text-center">
            <p class="text-[10px] text-slate-600 font-bold uppercase tracking-widest mb-4">Secured by Paystack Integration</p>
            <div class="flex justify-center gap-6 opacity-20">
                <i class="fab fa-cc-visa text-2xl"></i>
                <i class="fab fa-cc-mastercard text-2xl"></i>
                <i class="fas fa-mobile-alt text-2xl"></i>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBmu4xukuT0Z7oD_vA9QroeO-1ZuaK8JgA",
            authDomain: "gigantic-data.firebaseapp.com",
            databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
            projectId: "gigantic-data"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const PAYSTACK_PK = 'pk_live_faecdb3166144fadebd8269829343698dd43de63';
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('s') || 'official';
        
        let agentUid = "";
        let agentEmail = "";
        let selectedNetwork = "";
        let finalPayAmount = 0;

        // Pricing - using your Agent price list
        const bundleData = {
            MTN:[{p:"1GB",v:"4.45"},{p:"2GB",v:"8.85"},{p:"3GB",v:"13.25"},{p:"5GB",v:"22.05"},{p:"10GB",v:"42.25"}],
            AIRTELTIGO:[{p:"1GB",v:"4.30"},{p:"2GB",v:"8.56"},{p:"5GB",v:"21.40"},{p:"10GB",v:"44.00"}],
            TELECEL:[{p:"10GB",v:"45.00"},{p:"20GB",v:"84.00"}]
        };

        // Initialize Store Branding
        async function initStore() {
            const hour = new Date().getHours();
            let g = "Good Morning";
            if(hour >= 12) g = "Good Afternoon";
            if(hour >= 17) g = "Good Evening";
            document.getElementById('greetingText').innerText = g;

            try {
                const slugSnap = await database.ref(`slugs/${slug}`).once('value');
                if(!slugSnap.exists()) {
                    document.getElementById('storeName').innerText = "GIGANTIC DATA HUB";
                    document.getElementById('welcomeNote').innerText = "Official Corporate Store";
                    agentUid = "OFFICIAL"; 
                } else {
                    agentUid = slugSnap.val();
                    const userSnap = await database.ref(`users/${agentUid}`).once('value');
                    const uData = userSnap.val();
                    const storeDisplayName = uData.storeSettings ? uData.storeSettings.storeName : "The Hub";
                    document.getElementById('storeName').innerText = storeDisplayName;
                    document.getElementById('welcomeNote').innerText = `Welcome to ${storeDisplayName}! Expect nothing but fast and reliable data services.`;
                    agentEmail = uData.email;
                }
            } catch(e) { console.error(e); }
        }
        initStore();

        function selectNet(net) {
            selectedNetwork = net;
            document.querySelectorAll('.network-option').forEach(b => b.classList.remove('selected'));
            document.getElementById(`net-${net}`).classList.add('selected');
            document.getElementById('step2').classList.remove('opacity-40');
            
            const pSel = document.getElementById('planSelect');
            pSel.innerHTML = '<option value="" disabled selected>-- Select Bundle --</option>';
            bundleData[net].forEach(item => {
                pSel.innerHTML += `<option value="${item.v}" data-name="${item.p}">${item.p} Bundle - GH₵ ${item.v}</option>`;
            });
            document.getElementById('step3').classList.remove('opacity-40');
        }

        // SIM Verification
        document.getElementById('phoneNumber').oninput = async function(e) {
            const num = e.target.value;
            const box = document.getElementById('simNameBox');
            const nameDisp = document.getElementById('displayAccName');
            
            if(num.length === 10) {
                box.classList.remove('hidden');
                nameDisp.innerText = "Verifying Sim...";
                
                const bankCode = { 'MTN': 'MTN', 'AIRTELTIGO': 'ATL', 'TELECEL': 'VOD' }[selectedNetwork];
                try {
                    const k = atob("YmVhcmVyIA==") + atob("c2tfbGl2ZV8=") + atob("YmZkMjhmYmJlM2NhNDU1YmExNTQ1NWViZWQ3MTM4YjI0MDA5ZDEzNA==");
                    const response = await fetch(`https://api.paystack.co/bank/resolve?account_number=${num}&bank_code=${bankCode}`, {
                        headers: { 'Authorization': k }
                    });
                    const res = await response.json();
                    nameDisp.innerText = res.status ? res.data.account_name : "NETWORK VERIFIED";
                } catch (err) { nameDisp.innerText = "READY"; }
            } else { box.classList.add('hidden'); }
        };

        function calculatePrice() {
            const val = parseFloat(document.getElementById('planSelect').value) || 0;
            if(val > 0) {
                const fee = val * 0.025;
                const total = val + fee;
                finalPayAmount = total;
                
                document.getElementById('pricingBox').classList.remove('hidden');
                document.getElementById('basePrice').innerText = val.toFixed(2);
                document.getElementById('feePrice').innerText = fee.toFixed(2);
                document.getElementById('totalPrice').innerText = '₵ ' + total.toFixed(2);
                document.getElementById('payBtn').disabled = false;
            }
        }

        function showStatus(title, msg, isSuccess) {
            const modal = document.getElementById('statusModal');
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalMsg').innerText = msg;
            const icon = document.getElementById('modalIcon');
            
            if(isSuccess) {
                icon.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl bg-emerald-500/20 text-emerald-500";
                icon.innerHTML = '<i class="fas fa-check"></i>';
            } else {
                icon.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl bg-rose-500/20 text-rose-500";
                icon.innerHTML = '<i class="fas fa-times"></i>';
            }
            modal.style.display = 'flex';
            setTimeout(() => { document.getElementById('progressBar').style.width = '100%'; }, 100);
        }

        function startStorePayment() {
            const planSel = document.getElementById('planSelect');
            const planName = planSel.options[planSel.selectedIndex].getAttribute('data-name');
            const phone = document.getElementById('phoneNumber').value;
            const amount = parseFloat(planSel.value);

            let handler = PaystackPop.setup({
                key: PAYSTACK_PK,
                email: agentEmail || 'store-customer@giganticdata.com',
                amount: Math.round(finalPayAmount * 100),
                currency: 'GHS',
                ref: 'ST-' + Date.now(),
                callback: (response) => {
                    logOrder(response.reference, phone, planName, amount);
                }
            });
            handler.openIframe();
        }

        async function logOrder(ref, phone, plan, amount) {
            const timestamp = Date.now();
            const orderId = 'ORD-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            
            const orderObj = {
                network: selectedNetwork,
                plan: plan,
                recipient: phone,
                amount: amount,
                status: "Pending", // Payment successful, order fulfillment pending
                timestamp: timestamp,
                agentId: agentUid,
                reference: ref,
                orderId: orderId,
                simName: document.getElementById('displayAccName').innerText
            };

            const updates = {};
            updates[`orders/${orderId}`] = orderObj;
            updates[`pending_orders/${orderId}`] = orderObj;
            // Also log to agent history
            if(agentUid !== "OFFICIAL") {
                updates[`user_orders/${agentUid}/${orderId}`] = orderObj;
            }

            try {
                await database.ref().update(updates);
                showStatus("Order Received", `Payment verified! Your data for ${phone} is being processed.`, true);
                setTimeout(() => { location.reload(); }, 4000);
            } catch(e) {
                showStatus("Error", "Payment recorded but order failed to log. Contact support with ref: " + ref, false);
            }
        }
    </script>
</body>
</html>
