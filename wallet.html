<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Wallet — GiganticDataHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --deep-blue: #003366;
            --primary-blue: #0052cc;
            --orange-gradient: linear-gradient(135deg, #ff8c00 0%, #ff4500 100%);
            --light-bg: #f4f7fe;
            --white: #ffffff;
            --success: #10b981;
            --danger: #ef4444;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        body { background: var(--light-bg); color: #1e293b; min-height: 100vh; display: flex; flex-direction: column; }

        /* Sidebar Styling */
        .sidebar { 
            position: fixed; top: 0; left: 0; width: 260px; height: 100vh; 
            background: var(--deep-blue); color: #fff; padding: 30px 20px; 
            z-index: 1000; transition: 0.3s; 
        }
        
        .sidebar h2 { font-size: 1.2rem; margin-bottom: 40px; text-align: center; color: #ff8c00; font-weight: 800; }
        
        .sidebar ul { list-style: none; }
        .sidebar ul li { margin-bottom: 10px; }
        .sidebar ul li a { 
            color: #cbd5e1; text-decoration: none; padding: 12px 15px; 
            border-radius: 10px; display: flex; align-items: center; gap: 12px; font-weight: 600; transition: 0.3s; 
        }
        
        .sidebar ul li a:hover, .sidebar ul li a.active { background: rgba(255,255,255,0.1); color: #fff; }
        .sidebar ul li a i { width: 20px; text-align: center; }

        /* Header & Content */
        header { 
            background: var(--white); height: 70px; margin-left: 260px; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 900;
        }

        .container { margin-left: 260px; padding: 40px; flex-grow: 1; }

        /* Stats & Forms */
        .status-bar {
            background: white; padding: 15px 25px; border-radius: 15px; 
            display: flex; gap: 30px; margin-bottom: 30px; border: 1px solid #edf2f7;
        }
        .status-item { font-size: 0.85rem; font-weight: 700; color: var(--deep-blue); }
        .status-item span { font-weight: 400; color: #64748b; margin-left: 5px; }

        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .card h3 { font-size: 1.1rem; margin-bottom: 20px; color: var(--deep-blue); display: flex; align-items: center; gap: 10px; }

        /* Custom Form Layout */
        .wallet-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        
        input { 
            padding: 12px 15px; border-radius: 10px; border: 2px solid #e2e8f0; 
            font-size: 0.9rem; outline: none; transition: 0.3s; width: 100%;
        }
        input:focus { border-color: #ff8c00; }

        .btn-update { 
            background: var(--orange-gradient); color: white; border: none; 
            padding: 12px 25px; border-radius: 10px; font-weight: 700; cursor: pointer; 
            box-shadow: 0 5px 15px rgba(255, 69, 0, 0.2); transition: 0.3s; 
        }
        .btn-update:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255, 69, 0, 0.3); }

        /* Table */
        .table-responsive { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #f8fafc; color: #64748b; padding: 15px; text-align: left; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }
        td { padding: 15px; font-size: 0.85rem; border-bottom: 1px solid #f1f5f9; color: var(--deep-blue); }
        tr:hover { background: #fcfdfe; }

        .type-credit { color: var(--success); font-weight: 700; }
        .type-deduct { color: var(--danger); font-weight: 700; }

        .btn-delete { 
            background: #fee2e2; color: var(--danger); border: none; 
            padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.75rem;
        }

        .menu-toggle { display: none; font-size: 1.5rem; cursor: pointer; color: var(--deep-blue); }

        footer { margin-left: 260px; padding: 20px; text-align: center; font-size: 0.8rem; color: #94a3b8; border-top: 1px solid #e2e8f0; }

        @media (max-width: 992px) {
            .sidebar { left: -260px; }
            .sidebar.active { left: 0; }
            header, .container, footer { margin-left: 0; }
            .menu-toggle { display: block; }
            header { padding: 0 20px; }
        }
    </style>
</head>
<body>

<aside class="sidebar" id="sidebar">
    <h2>GIGANTIC ADMIN</h2>
    <ul>
        <li><a href="admin_dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a></li>
        <li><a href="users.html"><i class="fas fa-users"></i> User Management</a></li>
        <li><a href="orders.html"><i class="fas fa-shopping-cart"></i> All Orders</a></li>
        <li><a href="wallet.html" class="active"><i class="fas fa-wallet"></i> Wallet Control</a></li>
    </ul>
</aside>

<header>
    <div class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></div>
    <div style="font-weight: 800; color: var(--deep-blue);">WALLET MANAGEMENT</div>
    <div class="status-item">Admin: <span id="adminEmail">Loading...</span></div>
</header>

<div class="container">
    <div class="status-bar">
        <div class="status-item">System Status: <span style="color: #10b981;">● Online</span></div>
        <div class="status-item">Admin Privileges: <span id="adminStatus" style="color:var(--primary-blue)">Master Admin</span></div>
    </div>

    <div class="card">
        <h3><i class="fas fa-pen-to-square"></i> Modify User Balance</h3>
        <form id="walletForm">
            <div class="wallet-grid">
                <input type="text" id="userUid" placeholder="Paste User UID here" required>
                <input type="number" id="creditAmount" placeholder="Amount to Add (₵)" step="0.01">
                <input type="number" id="deductAmount" placeholder="Amount to Deduct (₵)" step="0.01">
                <button type="submit" class="btn-update">Update Wallet</button>
            </div>
        </form>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
            <h3 style="margin-bottom: 0;"><i class="fas fa-history"></i> Global Transaction Logs</h3>
            <input type="text" id="searchUser" placeholder="Search by Email or UID..." style="max-width: 300px;">
        </div>

        <div class="table-responsive">
            <table id="walletTable">
                <thead>
                    <tr>
                        <th>User UID</th>
                        <th>Email</th>
                        <th>Type</th>
                        <th>Amount (₵)</th>
                        <th>Balance After (₵)</th>
                        <th>Date & Time</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="txBody">
                    <tr><td colspan="7" style="text-align: center; padding: 40px;">Establishing secure connection...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<footer>
    <p>© 2026 GIGANTIC DATA HUB ADMIN CONTROL. All rights reserved.</p>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, onValue, update, push, remove, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBmiippVd5uyAb51U9upNNpSvJk0lXSNg4",
    authDomain: "gigantic-data.firebaseapp.com",
    databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
    projectId: "gigantic-data"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const ADMIN_EMAIL = "alenacloft0@gmail.com";
const txBody = document.getElementById("txBody");
const searchUser = document.getElementById("searchUser");

let usersList = [];
let transactionsList = [];

// Sidebar Toggle
document.getElementById("menuToggle").addEventListener("click", () => {
    document.getElementById("sidebar").classList.toggle("active");
});

onAuthStateChanged(auth, async user => {
    if (!user || user.email !== ADMIN_EMAIL) {
        window.location.href = "login.html";
        return;
    }
    document.getElementById("adminEmail").textContent = user.email;
    initDataLoad();
});

function initDataLoad() {
    // Sync Users for UID verification
    onValue(ref(db, 'users'), snapshot => {
        const data = snapshot.val();
        usersList = data ? Object.entries(data).map(([uid, u]) => ({ uid, ...u })) : [];
    });

    // Sync Global Transactions
    onValue(ref(db, 'transactions'), snapshot => {
        const data = snapshot.val();
        transactionsList = data ? Object.entries(data).map(([id, t]) => ({ id, ...t })) : [];
        transactionsList.sort((a, b) => b.date - a.date);
        renderLogs(searchUser.value);
    });
}

function renderLogs(query = "") {
    txBody.innerHTML = "";
    const filtered = transactionsList.filter(t => 
        (t.email && t.email.toLowerCase().includes(query.toLowerCase())) || 
        (t.uid && t.uid.includes(query))
    );

    if (filtered.length === 0) {
        txBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px; color:#94a3b8;">No transaction records match your search.</td></tr>';
        return;
    }

    filtered.forEach(tx => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td style="font-family: monospace; font-size: 0.7rem; color: #64748b;">${tx.uid}</td>
            <td style="font-weight: 700;">${tx.email || 'System User'}</td>
            <td><span class="type-${tx.type.toLowerCase()}">${tx.type.toUpperCase()}</span></td>
            <td style="font-weight: 800;">₵${parseFloat(tx.amount || 0).toFixed(2)}</td>
            <td style="font-weight: 800; color: var(--deep-blue);">₵${parseFloat(tx.newBalance || 0).toFixed(2)}</td>
            <td style="font-size: 0.8rem; color: #64748b;">${new Date(tx.date).toLocaleString()}</td>
            <td><button class="btn-delete" onclick="removeLog('${tx.id}')"><i class="fas fa-trash"></i></button></td>
        `;
        txBody.appendChild(tr);
    });
}

window.removeLog = function(id) {
    if (confirm("Delete this log permanently? This will not revert the user's balance.")) {
        remove(ref(db, `transactions/${id}`));
    }
}

// Wallet Update Logic
const walletForm = document.getElementById("walletForm");
walletForm.addEventListener("submit", async e => {
    e.preventDefault();
    const uid = document.getElementById("userUid").value.trim();
    const credit = parseFloat(document.getElementById("creditAmount").value) || 0;
    const deduct = parseFloat(document.getElementById("deductAmount").value) || 0;

    const user = usersList.find(u => u.uid === uid);
    if (!user) {
        alert("CRITICAL ERROR: UID does not exist in the database.");
        return;
    }

    const currentBal = parseFloat(user.wallet || 0);
    let finalBal = currentBal + credit - deduct;
    if (finalBal < 0) finalBal = 0;

    try {
        // 1. Update User Wallet
        await update(ref(db, `users/${uid}`), { wallet: finalBal });

        // 2. Generate Transaction Log
        if (credit > 0) {
            push(ref(db, 'transactions'), {
                uid: uid,
                email: user.email,
                type: "Credit",
                amount: credit,
                newBalance: finalBal,
                date: Date.now()
            });
        }
        if (deduct > 0) {
            push(ref(db, 'transactions'), {
                uid: uid,
                email: user.email,
                type: "Deduct",
                amount: deduct,
                newBalance: finalBal,
                date: Date.now()
            });
        }

        walletForm.reset();
        alert(`SUCCESS: ₵${(credit || deduct).toFixed(2)} processed for ${user.fullname}`);
    } catch (err) {
        alert("DATABASE ERROR: " + err.message);
    }
});

searchUser.addEventListener("input", e => renderLogs(e.target.value));
</script>

</body>
</html>
