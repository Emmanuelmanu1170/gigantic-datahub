<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Wallet Admin — GiganticDataHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --deep-blue: #003366;
            --primary-blue: #0052cc;
            --orange-gradient: linear-gradient(135deg, #ff8c00 0%, #ff4500 100%);
            --light-bg: #f4f7fe;
            --white: #ffffff;
            --success: #10b981;
            --danger: #ef4444;
            --purple: #a855f7;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--light-bg); color: #1e293b; min-height: 100vh; display: flex; flex-direction: column; }

        .sidebar { 
            position: fixed; top: 0; left: 0; width: 260px; height: 100vh; 
            background: var(--deep-blue); color: #fff; padding: 30px 20px; 
            z-index: 1000; transition: 0.3s; 
        }
        .sidebar h2 { font-size: 1.2rem; margin-bottom: 40px; text-align: center; color: #ff8c00; font-weight: 800; }
        .sidebar ul { list-style: none; }
        .sidebar ul li { margin-bottom: 10px; }
        .sidebar ul li a { 
            color: #cbd5e1; text-decoration: none; padding: 12px 15px; 
            border-radius: 10px; display: flex; align-items: center; gap: 12px; font-weight: 600; transition: 0.3s; 
        }
        .sidebar ul li a:hover, .sidebar ul li a.active { background: rgba(255,255,255,0.1); color: #fff; }

        header { 
            background: var(--white); height: 70px; margin-left: 260px; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 900;
        }
        .container { margin-left: 260px; padding: 40px; flex-grow: 1; }

        .status-bar {
            background: white; padding: 15px 25px; border-radius: 15px; 
            display: flex; gap: 30px; margin-bottom: 30px; border: 1px solid #edf2f7;
        }
        .status-item { font-size: 0.85rem; font-weight: 700; color: var(--deep-blue); }

        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .card h3 { font-size: 1.1rem; margin-bottom: 20px; color: var(--deep-blue); }

        .wallet-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        input { padding: 12px; border-radius: 10px; border: 2px solid #e2e8f0; outline: none; width: 100%; }
        .btn-update { background: var(--orange-gradient); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 700; cursor: pointer; }

        .table-responsive { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; }
        th { background: #f8fafc; color: #64748b; padding: 15px; text-align: left; font-size: 0.7rem; text-transform: uppercase; border-bottom: 2px solid #f1f5f9; }
        td { padding: 15px; font-size: 0.8rem; border-bottom: 1px solid #f1f5f9; }

        .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: 900; text-transform: uppercase; }
        .bg-purchase { background: #fee2e2; color: #b91c1c; }
        .bg-topup { background: #dcfce7; color: #15803d; }
        .bg-admin { background: #e0f2fe; color: #0369a1; }
        .bg-agent { background: #f3e8ff; color: #7e22ce; }

        .status-indicator { display: flex; align-items: center; gap: 5px; font-weight: 800; }
        .text-credit { color: var(--success); }
        .text-deduct { color: var(--danger); }

        .btn-delete { color: #cbd5e1; cursor: pointer; transition: 0.3s; }
        .btn-delete:hover { color: var(--danger); }
        .menu-toggle { display: none; cursor: pointer; font-size: 1.5rem; }

        @media (max-width: 992px) {
            .sidebar { left: -260px; }
            .sidebar.active { left: 0; }
            header, .container { margin-left: 0; }
            .menu-toggle { display: block; }
        }
    </style>
</head>
<body>

<aside class="sidebar" id="sidebar">
    <h2>GIGANTIC ADMIN</h2>
    <ul>
        <li><a href="admin_dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a></li>
        <li><a href="users.html"><i class="fas fa-users"></i> User Management</a></li>
        <li><a href="wallet.html" class="active"><i class="fas fa-wallet"></i> Wallet Control</a></li>
        <li><a href="agent.html"><i class="fas fa-user-tie"></i> Agent Panel</a></li>
    </ul>
</aside>

<header>
    <div class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></div>
    <div style="font-weight: 800; letter-spacing: 1px;">GLOBAL FINANCIAL TERMINAL</div>
    <div class="status-item">Admin: <span id="adminEmail">...</span></div>
</header>

<div class="container">
    <div class="status-bar">
        <div class="status-item">Sync Status: <span style="color: var(--success);">● UNIFIED BALANCE ACTIVE</span></div>
        <div class="status-item">Total Logs: <span id="logCounter">0</span></div>
    </div>

    <div class="card">
        <h3><i class="fas fa-coins"></i> Admin Wallet Modification</h3>
        <form id="walletForm" class="wallet-grid">
            <input type="text" id="userUid" placeholder="Paste User UID" required>
            <input type="number" id="creditAmount" placeholder="Credit (+) Amount" step="0.01">
            <input type="number" id="deductAmount" placeholder="Deduct (-) Amount" step="0.01">
            <button type="submit" class="btn-update">Update Balance</button>
        </form>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap: wrap; gap:10px;">
            <h3><i class="fas fa-history"></i> Master Financial Ledger</h3>
            <input type="text" id="searchLog" placeholder="Search Email / Reference / Action..." style="max-width:280px; padding: 10px; border-radius: 10px; border: 1px solid #ddd; outline: none;">
        </div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Type</th>
                        <th>User Account</th>
                        <th>Reference ID</th>
                        <th>Transaction Info</th>
                        <th>Amount</th>
                        <th>New Balance</th>
                        <th>Date & Time</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="masterLogBody">
                    <tr><td colspan="9" style="text-align:center; padding:50px;"><i class="fas fa-sync fa-spin"></i> Loading Ledger Records...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, onValue, update, push, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyCLl30c9nc09dZrkodA80hj5KSe9_B_aho",
    authDomain: "gigantic-data.firebaseapp.com",
    databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
    projectId: "gigantic-data"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const ADMIN_EMAIL = "alenacloft0@gmail.com";
let usersData = {};
let masterLogs = [];

onAuthStateChanged(auth, user => {
    if (user && user.email === ADMIN_EMAIL) {
        document.getElementById("adminEmail").textContent = user.email;
        loadGlobalData();
    } else {
        window.location.href = "admin_login.html";
    }
});

function loadGlobalData() {
    onValue(ref(db, 'users'), snap => { 
        usersData = snap.val() || {}; 
        syncLedger();
    });
}

function syncLedger() {
    const txRef = ref(db, 'transactions'); 
    const ordersRef = ref(db, 'orders'); // Pulling from central orders node

    onValue(txRef, (txSnap) => {
        onValue(ordersRef, (orderSnap) => {
            
            // Stream A: Admin Adjustments, Paystack Topups, Agent Upgrades (via Cloud Functions)
            const txs = txSnap.exists() ? Object.entries(txSnap.val()).map(([id, v]) => {
                const isCredit = v.type === 'Credit' || v.type === 'Top-up';
                let sourceTag = 'ADMIN';
                let infoMsg = v.description || v.info || `System ${v.type}`;
                
                if (infoMsg.toLowerCase().includes('top-up')) sourceTag = 'TOPUP';
                if (infoMsg.toLowerCase().includes('agent')) sourceTag = 'AGENT';

                return { 
                    id, ...v, 
                    ts: v.timestamp || v.date, 
                    src: sourceTag,
                    direction: isCredit ? 'CREDIT' : 'DEDUCT',
                    info: infoMsg,
                    email: v.email || usersData[v.uid]?.email || 'N/A'
                };
            }) : [];
            
            // Stream B: Unified Data Purchases
            let orders = [];
            if(orderSnap.exists()){
                Object.entries(orderSnap.val()).forEach(([id, o]) => {
                    orders.push({ 
                        id, ...o, ts: o.timestamp, src: 'PURCHASE', direction: 'DEDUCT', 
                        email: usersData[o.uid]?.email || 'N/A', 
                        info: `Data: ${o.network} ${o.plan}` 
                    });
                });
            }

            // MERGE & SORT
            masterLogs = [...txs, ...orders].sort((a, b) => b.ts - a.ts);
            document.getElementById('logCounter').innerText = masterLogs.length;
            renderTable(document.getElementById('searchLog').value);
        });
    });
}

function renderTable(filter = "") {
    const tbody = document.getElementById("masterLogBody");
    tbody.innerHTML = "";
    
    const filtered = masterLogs.filter(l => 
        (l.email && l.email.toLowerCase().includes(filter.toLowerCase())) || 
        (l.id && l.id.toLowerCase().includes(filter.toLowerCase())) ||
        (l.info && l.info.toLowerCase().includes(filter.toLowerCase()))
    );

    filtered.forEach(log => {
        let badgeClass = 'bg-admin';
        if(log.src === 'PURCHASE') badgeClass = 'bg-purchase';
        else if(log.src === 'TOPUP') badgeClass = 'bg-topup';
        else if(log.src === 'AGENT') badgeClass = 'bg-agent';

        const isCredit = log.direction === 'CREDIT';

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td><span class="badge ${badgeClass}">${log.src}</span></td>
            <td>
                <div class="status-indicator ${isCredit ? 'text-credit' : 'text-deduct'}">
                    <i class="fas ${isCredit ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                    ${log.direction}
                </div>
            </td>
            <td><b>${log.email}</b><br><small style="color:#94a3b8; font-size:9px;">${log.uid || '---'}</small></td>
            <td style="font-family:monospace; font-size:10px;">${log.id.substring(0,14)}...</td>
            <td style="font-size:11px; font-weight:700;">${log.info}</td>
            <td style="font-weight:800; color:${isCredit ? '#10b981' : '#ef4444'};">
                ${isCredit ? '+' : '-'}₵${parseFloat(log.amount || 0).toFixed(2)}
            </td>
            <td style="font-weight:700;">₵${parseFloat(log.newBalance || 0).toFixed(2)}</td>
            <td style="font-size:11px; color:#64748b;">${new Date(log.ts).toLocaleString()}</td>
            <td><i class="fas fa-trash-alt btn-delete" onclick="deleteEntry('${log.id}', '${log.src}', '${log.uid}')"></i></td>
        `;
        tbody.appendChild(tr);
    });
}

window.deleteEntry = (id, src, uid) => {
    if(!confirm("Warning: Deleting financial records can break your balance history. Continue?")) return;
    let path = `transactions/${id}`;
    if(src === 'PURCHASE') path = `orders/${id}`; // Matches updated orders node
    
    remove(ref(db, path)).then(() => alert("Entry removed."));
};

document.getElementById('walletForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const uid = document.getElementById('userUid').value.trim();
    const credit = parseFloat(document.getElementById('creditAmount').value) || 0;
    const deduct = parseFloat(document.getElementById('deductAmount').value) || 0;

    if(!usersData[uid]) return alert("UID Error: User not found in database.");

    const currentBal = parseFloat(usersData[uid].balance || usersData[uid].wallet || 0);
    const change = credit - deduct;
    const newBal = parseFloat((currentBal + change).toFixed(2));

    const updates = {};
    updates[`users/${uid}/balance`] = newBal;
    updates[`users/${uid}/wallet`] = newBal; // Safety sync

    await update(ref(db), updates);
    
    const type = change >= 0 ? 'Credit' : 'Deduct';
    const txRef = push(ref(db, 'transactions'));
    
    await update(txRef, {
        uid, 
        email: usersData[uid].email, 
        type: type, 
        amount: Math.abs(change), 
        newBalance: newBal, 
        timestamp: Date.now(), 
        description: `Admin Adjustment (${type})`
    });

    document.getElementById('walletForm').reset();
    alert(`Success: User balance updated to ₵${newBal}`);
});

document.getElementById('searchLog').addEventListener('input', (e) => renderTable(e.target.value));
document.getElementById('menuToggle').onclick = () => document.getElementById('sidebar').classList.toggle('active');

</script>
</body>
</html>
