<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Wallet Admin — GiganticDataHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --deep-blue: #003366;
            --primary-blue: #0052cc;
            --orange-gradient: linear-gradient(135deg, #ff8c00 0%, #ff4500 100%);
            --light-bg: #f4f7fe;
            --white: #ffffff;
            --success: #10b981;
            --danger: #ef4444;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        body { background: var(--light-bg); color: #1e293b; min-height: 100vh; display: flex; flex-direction: column; }

        /* Sidebar */
        .sidebar { 
            position: fixed; top: 0; left: 0; width: 260px; height: 100vh; 
            background: var(--deep-blue); color: #fff; padding: 30px 20px; 
            z-index: 1000; transition: 0.3s; 
        }
        .sidebar h2 { font-size: 1.2rem; margin-bottom: 40px; text-align: center; color: #ff8c00; font-weight: 800; }
        .sidebar ul { list-style: none; }
        .sidebar ul li { margin-bottom: 10px; }
        .sidebar ul li a { 
            color: #cbd5e1; text-decoration: none; padding: 12px 15px; 
            border-radius: 10px; display: flex; align-items: center; gap: 12px; font-weight: 600; transition: 0.3s; 
        }
        .sidebar ul li a:hover, .sidebar ul li a.active { background: rgba(255,255,255,0.1); color: #fff; }

        header { 
            background: var(--white); height: 70px; margin-left: 260px; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 900;
        }
        .container { margin-left: 260px; padding: 40px; flex-grow: 1; }

        .status-bar {
            background: white; padding: 15px 25px; border-radius: 15px; 
            display: flex; gap: 30px; margin-bottom: 30px; border: 1px solid #edf2f7;
        }
        .status-item { font-size: 0.85rem; font-weight: 700; color: var(--deep-blue); }

        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .card h3 { font-size: 1.1rem; margin-bottom: 20px; color: var(--deep-blue); }

        .wallet-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        input { padding: 12px; border-radius: 10px; border: 2px solid #e2e8f0; outline: none; width: 100%; }
        .btn-update { background: var(--orange-gradient); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 700; cursor: pointer; }

        .table-responsive { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; }
        th { background: #f8fafc; color: #64748b; padding: 15px; text-align: left; font-size: 0.7rem; text-transform: uppercase; border-bottom: 2px solid #f1f5f9; }
        td { padding: 15px; font-size: 0.8rem; border-bottom: 1px solid #f1f5f9; }

        .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: 900; text-transform: uppercase; }
        .bg-purchase { background: #fee2e2; color: #b91c1c; }
        .bg-topup { background: #dcfce7; color: #15803d; }
        .bg-admin { background: #e0f2fe; color: #0369a1; }

        .status-indicator { display: flex; align-items: center; gap: 5px; font-weight: 800; }
        .text-credit { color: var(--success); }
        .text-deduct { color: var(--danger); }

        .btn-delete { color: #cbd5e1; cursor: pointer; transition: 0.3s; }
        .btn-delete:hover { color: var(--danger); }
        .menu-toggle { display: none; cursor: pointer; font-size: 1.5rem; }

        @media (max-width: 992px) {
            .sidebar { left: -260px; }
            .sidebar.active { left: 0; }
            header, .container { margin-left: 0; }
            .menu-toggle { display: block; }
        }
    </style>
</head>
<body>

<aside class="sidebar" id="sidebar">
    <h2>GIGANTIC ADMIN</h2>
    <ul>
        <li><a href="admin_dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a></li>
        <li><a href="users.html"><i class="fas fa-users"></i> User Management</a></li>
        <li><a href="wallet.html" class="active"><i class="fas fa-wallet"></i> Wallet Control</a></li>
    </ul>
</aside>

<header>
    <div class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></div>
    <div style="font-weight: 800; letter-spacing: 1px;">GLOBAL FINANCIAL TERMINAL</div>
    <div class="status-item">Admin: <span id="adminEmail">...</span></div>
</header>

<div class="container">
    <div class="status-bar">
        <div class="status-item">Cloud Sync: <span style="color: var(--success);">● REAL-TIME</span></div>
        <div class="status-item">Total Logs: <span id="logCounter">0</span></div>
    </div>

    <div class="card">
        <h3><i class="fas fa-coins"></i> Quick Wallet Modification</h3>
        <form id="walletForm" class="wallet-grid">
            <input type="text" id="userUid" placeholder="Paste User UID" required>
            <input type="number" id="creditAmount" placeholder="Credit (+) Amount" step="0.01">
            <input type="number" id="deductAmount" placeholder="Deduct (-) Amount" step="0.01">
            <button type="submit" class="btn-update">Submit Transaction</button>
        </form>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap: wrap; gap:10px;">
            <h3><i class="fas fa-history"></i> Sorted Financial Ledger</h3>
            <input type="text" id="searchLog" placeholder="Search Email / UID / Ref..." style="max-width:280px; padding: 10px; border-radius: 10px; border: 1px solid #ddd; outline: none;">
        </div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Direction</th>
                        <th>User Email</th>
                        <th>Reference ID</th>
                        <th>Amount</th>
                        <th>New Balance</th>
                        <th>Date & Time</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="masterLogBody">
                    <tr><td colspan="8" style="text-align:center; padding:50px;"><i class="fas fa-sync fa-spin"></i> Organizing database records...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, onValue, update, push, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBmiippVd5uyAb51U9upNNpSvJk0lXSNg4",
    authDomain: "gigantic-data.firebaseapp.com",
    databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
    projectId: "gigantic-data"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const ADMIN_EMAIL = "alenacloft0@gmail.com";
let usersData = {};
let masterLogs = [];

onAuthStateChanged(auth, user => {
    if (user && user.email === ADMIN_EMAIL) {
        document.getElementById("adminEmail").textContent = user.email;
        loadGlobalData();
    } else {
        window.location.href = "login.html";
    }
});

function loadGlobalData() {
    onValue(ref(db, 'users'), snap => { usersData = snap.val() || {}; });

    const txRef = ref(db, 'transactions'); 
    const topupRef = ref(db, 'topupNotes'); 

    onValue(txRef, (txSnap) => {
        onValue(topupRef, (topSnap) => {
            const txs = txSnap.exists() ? Object.entries(txSnap.val()).map(([id, v]) => {
                const isDeduct = v.type === 'Deduct' || (!v.type && v.src !== 'TOPUP');
                const isCredit = v.type === 'Credit' || v.src === 'BONUS';
                return { 
                    id, ...v, 
                    ts: v.date || v.timestamp, 
                    src: (v.type === 'Credit' || v.type === 'Deduct') ? 'ADMIN' : 'PURCHASE',
                    direction: isCredit ? 'CREDIT' : 'DEDUCT'
                };
            }) : [];
            
            let tops = [];
            if(topSnap.exists()){
                Object.entries(topSnap.val()).forEach(([uid, notes]) => {
                    Object.entries(notes).forEach(([id, v]) => {
                        tops.push({ id, ...v, uid, ts: v.timestamp, src: 'TOPUP', direction: 'CREDIT', email: usersData[uid]?.email || 'User Not Found' });
                    });
                });
            }

            // NEAREST AT TOP SORTING
            masterLogs = [...txs, ...tops].sort((a, b) => b.ts - a.ts);
            document.getElementById('logCounter').innerText = masterLogs.length;
            renderTable(document.getElementById('searchLog').value);
        });
    });
}

function renderTable(filter = "") {
    const tbody = document.getElementById("masterLogBody");
    tbody.innerHTML = "";
    
    const filtered = masterLogs.filter(l => 
        (l.email && l.email.toLowerCase().includes(filter.toLowerCase())) || 
        (l.uid && l.uid.includes(filter)) || 
        (l.id && l.id.includes(filter))
    );

    filtered.forEach(log => {
        const badgeClass = log.src === 'PURCHASE' ? 'bg-purchase' : (log.src === 'TOPUP' ? 'bg-topup' : 'bg-admin');
        const userEmail = log.email || usersData[log.uid]?.email || 'N/A';
        const isCredit = log.direction === 'CREDIT';

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td><span class="badge ${badgeClass}">${log.src}</span></td>
            <td>
                <div class="status-indicator ${isCredit ? 'text-credit' : 'text-deduct'}">
                    <i class="fas ${isCredit ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                    ${log.direction}
                </div>
            </td>
            <td><b>${userEmail}</b><br><small style="color:#94a3b8; font-family:monospace; font-size:9px;">${log.uid || '---'}</small></td>
            <td style="font-family:monospace; font-size:10px;">${log.id.substring(0,12)}...</td>
            <td style="font-weight:800; color:${isCredit ? '#10b981' : '#ef4444'};">
                ${isCredit ? '+' : '-'}₵${parseFloat(log.amount || 0).toFixed(2)}
            </td>
            <td style="font-weight:700;">₵${parseFloat(log.newBalance || 0).toFixed(2)}</td>
            <td style="font-size:11px; color:#64748b;">${new Date(log.ts).toLocaleString()}</td>
            <td><i class="fas fa-trash-alt btn-delete" onclick="deleteEntry('${log.id}', '${log.src}', '${log.uid}')"></i></td>
        `;
        tbody.appendChild(tr);
    });
}

window.deleteEntry = (id, src, uid) => {
    if(!confirm("Erase this financial record?")) return;
    let path = src === 'TOPUP' ? `topupNotes/${uid}/${id}` : `transactions/${id}`;
    remove(ref(db, path)).then(() => alert("Record Erased."));
};

document.getElementById('walletForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const uid = document.getElementById('userUid').value.trim();
    const credit = parseFloat(document.getElementById('creditAmount').value) || 0;
    const deduct = parseFloat(document.getElementById('deductAmount').value) || 0;

    if(!usersData[uid]) return alert("Error: UID not found in database.");

    const currentBal = parseFloat(usersData[uid].wallet || 0);
    const newBal = Math.max(0, currentBal + credit - deduct);

    await update(ref(db, `users/${uid}`), { wallet: newBal });
    
    const type = credit > 0 ? 'Credit' : 'Deduct';
    const amount = credit > 0 ? credit : deduct;

    push(ref(db, 'transactions'), {
        uid, email: usersData[uid].email, type, amount, newBalance: newBal, date: Date.now()
    });

    document.getElementById('walletForm').reset();
    alert("User wallet synced and logged.");
});

document.getElementById('searchLog').addEventListener('input', (e) => renderTable(e.target.value));
document.getElementById('menuToggle').onclick = () => document.getElementById('sidebar').classList.toggle('active');

</script>
</body>
</html>
