<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Gigantic Data Hub</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:"Poppins", sans-serif; }
    body { background:#f0f4f9; color:#0a2a66; min-height:100vh; }

    header { 
        background:#0a2a66; 
        color:#fff; 
        display:flex; 
        justify-content:space-between; 
        align-items:center; 
        padding:15px 5%; 
        position:fixed; 
        width:100%; 
        top:0; 
        z-index:1000; 
        box-shadow:0 4px 12px rgba(0,0,0,0.15); 
    }
    header h1 { font-size:1.2rem; font-weight:700; letter-spacing:0.5px; }

    .nav-buttons { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
    .nav-buttons button, .admin-btn, .withdraw-admin-btn { 
        padding:10px 16px; 
        border:none; 
        border-radius:8px; 
        background:#1e90ff; 
        color:#fff; 
        font-weight:600; 
        font-size: 13px;
        cursor:pointer; 
        transition:0.3s; 
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }
    .nav-buttons button:hover, .admin-btn:hover, .withdraw-admin-btn:hover { 
        background:#0d6efd; 
        transform: translateY(-2px); 
    }
    
    .btn-withdraw { background-color: #475569 !important; }
    .btn-pass { background-color: #003366 !important; }

    .container { padding: 160px 5% 40px; max-width:1300px; margin:auto; }

    .summary-boxes { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:25px; }
    .summary-box { 
        background:#fff; 
        padding:25px; 
        border-radius:12px; 
        box-shadow:0 4px 15px rgba(0,0,0,0.05); 
        border-bottom: 4px solid #1e90ff;
    }
    .summary-box:nth-child(4) { border-bottom-color: #ff8c00; background: #fff9f0; }
    .summary-box h3 { margin-bottom:8px; font-size:0.75rem; color:#64748b; text-transform: uppercase; letter-spacing: 1px; }
    .summary-box p { font-size:1.6rem; font-weight:700; color: #0a2a66; }

    .status-box { background:#fff; padding:15px 25px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.05); margin-bottom:25px; display:flex; justify-content:space-between; align-items: center; font-size: 14px; }

    .row { display:flex; gap:25px; flex-wrap:wrap; }
    .col { flex:1; min-width:320px; }

    .card { background:#fff; padding:25px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.05); margin-bottom:25px; }
    .card h3 { margin-bottom:20px; font-size: 1.1rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 12px; display: flex; align-items: center; gap: 10px; }

    .referral-list { max-height:450px; overflow-y:auto; }
    .referral-item { display:flex; justify-content:space-between; align-items:center; padding:15px; border:1px solid #f1f5f9; border-radius: 10px; margin-bottom: 10px; }

    .action-btn { padding:8px 14px; border-radius:8px; cursor:pointer; border:none; font-weight: 600; font-size: 12px; transition: 0.2s; }
    .action-approve { background:#28c76f; color:white; }
    .action-reject { background:#ff4d4f; color:white; }
    .action-approve:hover { background: #21a35c; }

    .input { padding:12px; border-radius:8px; border:1px solid #e2e8f0; outline:none; font-size: 14px; }
    .btn-danger { background:#ff4d4f; color:#fff; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight: 700; }

    .footer { background:#0a2a66; color:#fff; text-align:center; padding:30px; margin-top:30px; font-size: 14px; }
    .toast { position:fixed; right:30px; bottom:30px; background:#0a2a66; color:#fff; padding:15px 25px; border-radius:10px; display:none; z-index:9999; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
</style>
</head>
<body>

<header>
  <h1>Gigantic Data Hub — Admin</h1>
  <div class="nav-buttons">
    <button onclick="location.reload()"><i class="fas fa-chart-line"></i> Stats</button>
    <button onclick="location.href='users.html'"><i class="fas fa-users"></i> Users</button>
    <button onclick="location.href='orders.html'"><i class="fas fa-shopping-cart"></i> Orders</button>
    <a href="admin_withdraw.html" class="withdraw-admin-btn btn-withdraw"><i class="fas fa-money-bill-transfer"></i> Withdrawals</a>
    <a href="admin-password.html" class="admin-btn btn-pass"><i class="fas fa-lock"></i> Passwords</a>
    <button id="logoutBtn" class="btn-danger">Logout</button>
  </div>
</header>

<div class="container">
  <div class="status-box">
    <span>Admin: <strong id="adminEmail" style="color:#1e90ff">Loading...</strong></span>
    <span>Server: <strong id="adminStatus" style="color:#28c76f"><i class="fas fa-circle"></i> Online</strong></span>
  </div>

  <div class="summary-boxes">
    <div class="summary-box"><h3>Total Users</h3><p id="totalUsers">0</p></div>
    <div class="summary-box"><h3>Total Orders</h3><p id="totalOrders">0</p></div>
    <div class="summary-box"><h3>Total Sales (₵)</h3><p id="totalSales">0.00</p></div>
    <div class="summary-box"><h3>Today Sales (5%)</h3><p id="todaySales">0.00</p></div>
    <div class="summary-box"><h3>System Wallet (₵)</h3><p id="totalWallet">0.00</p></div>
  </div>

  <div class="row">
    <div class="col">
      <div class="card">
        <h3><i class="fas fa-clock" style="color:#ff8c00"></i> Pending Referral Credits</h3>
        <div id="referralList" class="referral-list">Loading transactions...</div>
      </div>
      <div class="card">
        <h3><i class="fas fa-chart-line" style="color:#1e90ff"></i> Sales Performance (Last 7 Days)</h3>
        <canvas id="salesChart" height="140"></canvas>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h3><i class="fas fa-search"></i> User Profile Lookup</h3>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
          <input id="searchUid" class="input" style="flex:1" placeholder="Paste User UID..." />
          <button id="searchBtn" class="action-btn" style="background:#0a2a66; color:white; padding: 0 20px;">Lookup</button>
        </div>
        <div id="userResult" style="padding:20px; background:#f8fbff; border-radius:10px; font-size:13px; min-height: 100px;">
          <div style="color:#94a3b8">Enter a UID to fetch wallet and order details...</div>
        </div>
      </div>

      <div class="card" style="border: 1px solid #e2e8f0;">
        <h3><i class="fas fa-cog"></i> Quick Links</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <a href="admin-ads.html" style="text-decoration:none; background:#f1f5f9; padding:15px; border-radius:8px; color:#0a2a66; font-weight:600; text-align:center;"><i class="fas fa-ad"></i> Manage Ads</a>
            <a href="topup.html" style="text-decoration:none; background:#f1f5f9; padding:15px; border-radius:8px; color:#0a2a66; font-weight:600; text-align:center;"><i class="fas fa-plus"></i> Manual Topup</a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="footer">© 2025 Gigantic Data Hub. Professional Admin Dashboard</div>
<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getDatabase, ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBmiippVd5uyAb51U9upNNpSvJk0lXSNg4",
  authDomain: "gigantic-data.firebaseapp.com",
  databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
  projectId: "gigantic-data",
  storageBucket: "gigantic-data.firebasestorage.app",
  appId: "1:727845403550:web:e3c3a40ce615aaaca9748f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const ADMIN_EMAIL = "alenacloft0@gmail.com";
let salesChart = null;

function toast(msg){ 
    const t = document.getElementById("toast");
    t.textContent=msg; t.style.display="block"; 
    setTimeout(()=>t.style.display="none",3000); 
}

onAuthStateChanged(auth, user => {
  if(!user || user.email !== ADMIN_EMAIL){
    location.href="admin_login.html";
    return;
  }
  document.getElementById("adminEmail").textContent = user.email;
  initDashboard();
});

async function initDashboard() {
    loadRealtimeStats();
    loadReferralRequests();
}

function loadRealtimeStats() {
    onValue(ref(db, "orders"), async (snap) => {
        const ordersData = snap.exists() ? snap.val() : {};
        const orders = Object.values(ordersData);
        
        const usersSnap = await get(ref(db, "users"));
        const users = usersSnap.exists() ? usersSnap.val() : {};
        
        // Stats
        document.getElementById("totalUsers").textContent = Object.keys(users).length;
        document.getElementById("totalOrders").textContent = orders.length;
        
        const successOrders = orders.filter(o => ["completed","success","successfull"].includes(String(o.status).toLowerCase()));
        const totalSales = successOrders.reduce((sum, o) => sum + Number(o.amountGHS || o.price || 0), 0);
        document.getElementById("totalSales").textContent = totalSales.toLocaleString();
        document.getElementById("todaySales").textContent = (totalSales * 0.05).toFixed(2);
        
        const totalWallet = Object.values(users).reduce((sum, u) => sum + Number(u.wallet || u.balance || 0), 0);
        document.getElementById("totalWallet").textContent = totalWallet.toLocaleString();

        updateSalesChart(successOrders);
    });
}

function updateSalesChart(orders) {
    const ctx = document.getElementById('salesChart').getContext('2d');
    const last7Days = [...Array(7)].map((_, i) => {
        const d = new Date();
        d.setDate(d.getDate() - i);
        return d.toISOString().split('T')[0];
    }).reverse();

    const chartData = last7Days.map(date => {
        return orders.filter(o => o.timestamp && new Date(o.timestamp).toISOString().split('T')[0] === date)
                     .reduce((sum, o) => sum + Number(o.amountGHS || o.price || 0), 0);
    });

    if(salesChart) salesChart.destroy();
    
    salesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: last7Days.map(d => d.split('-').slice(1).join('/')),
            datasets: [{
                label: 'Revenue (₵)',
                data: chartData,
                borderColor: '#1e90ff',
                backgroundColor: 'rgba(30, 144, 255, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } }
        }
    });
}

async function loadReferralRequests() {
    const usersSnap = await get(ref(db, "users"));
    const ordersSnap = await get(ref(db, "orders"));
    const users = usersSnap.exists() ? usersSnap.val() : {};
    const orders = ordersSnap.exists() ? ordersSnap.val() : {};
    
    const referralListEl = document.getElementById("referralList");
    referralListEl.innerHTML = "";
    let count = 0;

    // Signup Referrals
    for (const uid in users) {
        const u = users[uid];
        if (u.referralGiven && !u.referralGiven.approved && !u.referralGiven.rejected) {
            createReferralItem(referralListEl, uid, u.fullName, u.referralGiven.referrer, u.referralGiven.credited, "Signup", "signup", uid);
            count++;
        }
    }

    // Purchase Commissions
    for (const orderId in orders) {
        const order = orders[orderId];
        if (["completed", "success"].includes(String(order.status).toLowerCase()) && !order.commissionPaid) {
            const buyer = users[order.userUid || order.uid];
            if (buyer && buyer.referredBy) {
                const commission = (Number(order.amountGHS || order.price) * 0.02);
                if (commission > 0) {
                    createReferralItem(referralListEl, order.userUid, buyer.fullName, buyer.referredBy, commission.toFixed(2), "2% Comm", "commission", orderId);
                    count++;
                }
            }
        }
    }

    if (count === 0) referralListEl.innerHTML = "<div style='text-align:center; padding:20px; color:#94a3b8;'>All clear! No pending tasks.</div>";
}

function createReferralItem(container, buyerUid, name, referrer, amt, label, type, id) {
    const div = document.createElement("div");
    div.className = "referral-item";
    div.innerHTML = `
        <div style="flex:1">
            <div style="font-weight:600;">${name} <span style="font-size:10px; padding:2px 6px; border-radius:4px; background:#e0f2fe; color:#0369a1; margin-left:5px;">${label}</span></div>
            <div style="font-size:11px; color:#64748b;">To: ${referrer} • ₵${amt}</div>
        </div>
        <div style="display:flex; gap:5px;">
            <button class="action-btn action-approve" onclick="approveAction('${id}', '${referrer}', '${amt}', '${type}', '${buyerUid}')">Approve</button>
            <button class="action-btn action-reject" onclick="rejectAction('${id}', '${type}', '${buyerUid}')">Reject</button>
        </div>
    `;
    container.appendChild(div);
}

window.approveAction = async (id, referrer, amt, type, buyerUid) => {
    try {
        const usersSnap = await get(ref(db, "users"));
        const users = usersSnap.val();
        let refUid = null;
        for (const uid in users) {
            if (uid === referrer || users[uid].referralCode === referrer) { refUid = uid; break; }
        }
        if (!refUid) return toast("Referrer not found!");
        
        const oldBal = Number(users[refUid].referralBonus || 0);
        await update(ref(db, `users/${refUid}`), { referralBonus: (oldBal + Number(amt)).toFixed(2) });

        if (type === "signup") {
            await update(ref(db, `users/${buyerUid}/referralGiven`), { approved: true, approvedAt: Date.now() });
        } else {
            await update(ref(db, `orders/${id}`), { commissionPaid: true });
        }
        toast("Credit Approved!");
        loadReferralRequests();
    } catch (e) { toast("Error: " + e.message); }
};

window.rejectAction = async (id, type, buyerUid) => {
    if(!confirm("Reject?")) return;
    if (type === "signup") {
        await update(ref(db, `users/${buyerUid}/referralGiven`), { rejected: true });
    } else {
        await update(ref(db, `orders/${id}`), { commissionPaid: "rejected" });
    }
    toast("Rejected.");
    loadReferralRequests();
};

document.getElementById("searchBtn").onclick = async () => {
    const uid = document.getElementById("searchUid").value.trim();
    if(!uid) return;
    const snap = await get(ref(db, `users/${uid}`));
    const res = document.getElementById("userResult");
    if(snap.exists()){
        const u = snap.val();
        res.innerHTML = `<strong>Name:</strong> ${u.fullName}<br><strong>Email:</strong> ${u.email}<br><strong>Wallet:</strong> ₵${(u.wallet || 0).toFixed(2)}<br><strong>Bonus:</strong> ₵${(u.referralBonus || 0).toFixed(2)}`;
    } else {
        res.innerHTML = "<span style='color:red'>User Not Found</span>";
    }
};

document.getElementById("logoutBtn").onclick = () => signOut(auth).then(() => location.href="admin_login.html");
</script>
</body>
</html>
