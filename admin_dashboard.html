<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Gigantic Data Hub</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:"Poppins", sans-serif; }
body { background:#f0f4f9; color:#0a2a66; min-height:100vh; }

header { 
    background:#0a2a66; 
    color:#fff; 
    display:flex; 
    justify-content:space-between; 
    align-items:center; 
    padding:15px 5%; 
    position:fixed; 
    width:100%; 
    top:0; 
    z-index:100; 
    box-shadow:0 4px 12px rgba(0,0,0,0.15); 
}
header h1 { font-size:1.2rem; font-weight:700; letter-spacing:0.5px; }

.nav-buttons { display:flex; gap:8px; margin-top:10px; flex-wrap: wrap; }
.nav-buttons button, .nav-buttons a button { 
    padding:8px 14px; 
    border:none; 
    border-radius:6px; 
    background:#1e90ff; 
    color:#fff; 
    font-weight:600; 
    font-size: 13px;
    cursor:pointer; 
    transition:0.2s; 
    display: flex;
    align-items: center;
    gap: 6px;
}
.nav-buttons button:hover { background:#0d6efd; transform: translateY(-1px); }
.nav-buttons .btn-withdraw { background-color: #1e293b !important; }
.nav-buttons .btn-withdraw:hover { background-color: #334155 !important; }

.container { padding: 140px 5% 40px; max-width:1300px; margin:auto; }

.summary-boxes { display:flex; flex-wrap:wrap; gap:15px; margin-bottom:25px; }
.summary-box { 
    background:#fff; 
    padding:20px; 
    border-radius:12px; 
    box-shadow:0 4px 15px rgba(0,0,0,0.05); 
    flex:1; 
    min-width:180px; 
    border-bottom: 4px solid #1e90ff;
    transition: 0.3s;
}
.summary-box:nth-child(4) { border-bottom-color: #ff8c00; } /* Today Sales color */
.summary-box h3 { margin-bottom:8px; font-size:0.85rem; color:#64748b; text-transform: uppercase; letter-spacing: 1px; }
.summary-box p { font-size:1.5rem; font-weight:700; color: #0a2a66; }

.status-box { background:#fff; padding:12px 20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.05); margin-bottom:20px; display:flex; justify-content:space-between; font-size: 14px; }

.row { display:flex; gap:20px; flex-wrap:wrap; }
.col { flex:1; min-width:300px; }

.card { background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.05); margin-bottom:20px; }
.card h3 { margin-bottom:15px; font-size: 1.1rem; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }

.referral-list { max-height:400px; overflow-y:auto; }
.referral-item { display:flex; justify-content:space-between; align-items:center; padding:12px; border:1px solid #f0f4f9; border-radius: 8px; margin-bottom: 8px; transition: 0.2s; }
.referral-item:hover { background: #f8fbff; }

.action-btn { padding:7px 12px; border-radius:6px; cursor:pointer; border:none; font-weight: 600; font-size: 12px; }
.action-approve { background:#28c76f; color:white; margin-right: 5px; }
.action-reject { background:#ff4d4f; color:white; }

.badge-commission { background:#fff4e5; color:#ff8c00; padding:2px 8px; border-radius:4px; font-size:0.7rem; font-weight: 700; }
.badge-signup { background:#e5f9f0; color:#28c76f; padding:2px 8px; border-radius:4px; font-size:0.7rem; font-weight: 700; }

.input { padding:10px; border-radius:8px; border:1px solid #ddd; outline:none; }
.btn-danger { background:#ff4d4f; color:#fff; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; font-weight: 600; }

.footer { background:#0a2a66; color:#fff; text-align:center; padding:20px; margin-top:30px; font-size: 14px; }
.toast { position:fixed; right:20px; bottom:20px; background:#0a2a66; color:#fff; padding:12px 20px; border-radius:8px; display:none; z-index:9999; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
</style>
</head>
<body>

<header>
  <div>
    <h1>Gigantic Data Hub — Admin</h1>
    <div class="nav-buttons">
      <button onclick="location.href='admin_dashboard.html'"><i class="fas fa-chart-line"></i> Dashboard</button>
      <button onclick="window.location.href='topup.html'"><i class="fas fa-plus-circle"></i> Top-Up</button>
      <button onclick="location.href='users.html'"><i class="fas fa-users"></i> Users</button>
      <button onclick="location.href='orders.html'"><i class="fas fa-shopping-cart"></i> Orders</button>
      <button onclick="location.href='wallet.html'"><i class="fas fa-wallet"></i> Wallet</button>
      <a href="admin_withdraw.html" style="text-decoration: none;">
        <button class="btn-withdraw">
            <i class="fas fa-university"></i>
<a href="admin_withdraw.html" class="wide-btn withdraw-admin-btn">
    <i class="fas fa-money-bill-transfer"></i> Manage Withdrawals
</a>

<style>
    .withdraw-admin-btn {
        background: #475569; /* Slate Gray */
        color: white;
        margin: 10px 15px;
        padding: 15px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-weight: 700;
        text-decoration: none;
        font-size: 14px;
        border: none;
        width: calc(100% - 30px);
        transition: 0.3s;
    }
    .withdraw-admin-btn:hover {
        background: #1e293b;
    }
</style>

        </button>

<br>
<a href="admin-password.html" class="wide-btn admin-btn">
    <i class="fas fa-lock-open"></i> Manage User Passwords
</a>

<style>
    .admin-btn {
        background: #003366;
        color: white;
        margin: 10px 15px;
        padding: 15px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-weight: 700;
        text-decoration: none;
        font-size: 14px;
        border: none;
        width: calc(100% - 30px);
    }
</style>

      </a>
    </div>
  </div>
  <button id="logoutBtn" class="btn-danger">Logout</button>
</header>

<div class="container">
  <div class="status-box">
    <span>Admin: <strong id="adminEmail" style="color:#1e90ff">Loading...</strong></span>
    <span>System Status: <strong id="adminStatus" style="color:#28c76f">Online</strong></span>
  </div>

  <div class="summary-boxes">
    <div class="summary-box">
      <h3>Total Users</h3>
      <p id="totalUsers">0</p>
    </div>
    <div class="summary-box">
      <h3>Total Orders</h3>
      <p id="totalOrders">0</p>
    </div>
    <div class="summary-box">
      <h3>Total Sales (₵)</h3>
      <p id="totalSales">0.00</p>
    </div>
    <div class="summary-box" style="background: #fff9f0;">
        <h3>Today Sales (5%)</h3>
        <p id="todaySales" style="color: #ff8c00;">0.00</p>
    </div>
    <div class="summary-box">
      <h3>System Wallet (₵)</h3>
      <p id="totalWallet">0.00</p>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <div class="card">
        <h3><i class="fas fa-clock" style="color:#ff8c00"></i> Pending Referral Credits</h3>
        <div id="referralList" class="referral-list">Loading transactions...</div>
      </div>
      <div class="card">
        <h3><i class="fas fa-chart-bar" style="color:#1e90ff"></i> Sales Analytics</h3>
        <canvas id="salesChart" height="140"></canvas>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h3><i class="fas fa-search"></i> User Lookup</h3>
        <div style="display:flex; gap:8px; margin-bottom:15px;">
          <input id="searchUid" class="input" style="flex:1" placeholder="Enter User UID" />
          <button id="searchBtn" class="action-btn" style="background:#0a2a66; color:white;">Search</button>
        </div>
        <div id="userResult" style="padding:15px; background:#f8fbff; border-radius:8px; font-size:13px;">
          <div class="small-muted">Enter UID to see profile details...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="footer">© 2025 Gigantic Data Hub. Admin Control Panel</div>
<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getDatabase, ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBmiippVd5uyAb51U9upNNpSvJk0lXSNg4",
  authDomain: "gigantic-data.firebaseapp.com",
  databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
  projectId: "gigantic-data",
  storageBucket: "gigantic-data.firebasestorage.app",
  messagingSenderId: "727845403550",
  appId: "1:727845403550:web:e3c3a40ce615aaaca9748f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const ADMIN_EMAIL = "alenacloft0@gmail.com";
const toastEl = document.getElementById("toast");
function toast(msg){ toastEl.textContent=msg; toastEl.style.display="block"; setTimeout(()=>toastEl.style.display="none",3000); }

onAuthStateChanged(auth, async user => {
  if(!user || user.email !== ADMIN_EMAIL){
    location.href="admin_login.html";
    return;
  }
  document.getElementById("adminEmail").textContent = user.email;
  initDashboard();
});

function initDashboard() {
    loadSummary();
    loadReferralRequests();
}

async function loadSummary() {
    onValue(ref(db, "orders"), async (snap) => {
        const orders = snap.exists() ? Object.values(snap.val()) : [];
        const usersSnap = await get(ref(db, "users"));
        const users = usersSnap.exists() ? usersSnap.val() : {};
        
        document.getElementById("totalUsers").textContent = Object.keys(users).length;
        document.getElementById("totalOrders").textContent = orders.length;
        
        const successOrders = orders.filter(o => ["completed","success"].includes(String(o.status).toLowerCase()));
        const totalSales = successOrders.reduce((sum, o) => sum + Number(o.amountGHS || o.price || 0), 0);
        document.getElementById("totalSales").textContent = totalSales.toFixed(2);
        
        // Calculate 5% of Total Sales for Today Sales field
        const fivePercent = totalSales * 0.05;
        document.getElementById("todaySales").textContent = fivePercent.toFixed(2);
        
        const totalWallet = Object.values(users).reduce((sum, u) => sum + Number(u.wallet || u.walletBalance || 0), 0);
        document.getElementById("totalWallet").textContent = totalWallet.toFixed(2);
    });
}

async function loadReferralRequests() {
    const usersSnap = await get(ref(db, "users"));
    const ordersSnap = await get(ref(db, "orders"));
    const users = usersSnap.exists() ? usersSnap.val() : {};
    const orders = ordersSnap.exists() ? ordersSnap.val() : {};
    
    const referralListEl = document.getElementById("referralList");
    referralListEl.innerHTML = "";
    let count = 0;

    for (const uid in users) {
        const u = users[uid];
        if (u.referralGiven && !u.referralGiven.approved && !u.referralGiven.rejected) {
            addReferralUI(referralListEl, uid, u.fullName, u.referralGiven.referrer, u.referralGiven.credited, "Signup Reward", "signup", uid);
            count++;
        }
    }

    for (const orderId in orders) {
        const order = orders[orderId];
        const status = String(order.status).toLowerCase();
        if (["completed", "success"].includes(status) && !order.commissionPaid) {
            const buyerUid = order.userUid || order.uid;
            const buyer = users[buyerUid];
            if (buyer && buyer.referredBy) {
                const commission = (Number(order.amountGHS || order.price) * 0.02);
                if (commission > 0) {
                    addReferralUI(referralListEl, buyerUid, buyer.fullName, buyer.referredBy, commission.toFixed(2), `2% Comm`, "commission", orderId);
                    count++;
                }
            }
        }
    }

    if (count === 0) referralListEl.innerHTML = "<div style='text-align:center; padding:20px; color:#94a3b8;'>No pending transactions</div>";
}

function addReferralUI(container, buyerUid, buyerName, referrerCode, amount, typeLabel, typeClass, targetId) {
    const item = document.createElement("div");
    item.className = "referral-item";
    item.innerHTML = `
        <div style="flex:1">
            <div style="font-size:14px; font-weight:600;">${buyerName || 'User'} <span class="badge-${typeClass}">${typeLabel}</span></div>
            <div style="font-size:11px; color:#64748b;">Referrer: ${referrerCode} • ₵${amount}</div>
        </div>
        <div>
            <button class="action-btn action-approve" onclick="approveAction('${targetId}', '${referrerCode}', '${amount}', '${typeClass}')">Approve</button>
            <button class="action-btn action-reject" onclick="rejectAction('${targetId}', '${typeClass}')">Reject</button>
        </div>
    `;
    container.appendChild(item);
}

window.approveAction = async (targetId, referrerCode, amount, type) => {
    try {
        const usersSnap = await get(ref(db, "users"));
        const users = usersSnap.val();
        let referrerUid = null;
        for (const uid in users) {
            if (uid === referrerCode || users[uid].referralCode === referrerCode) {
                referrerUid = uid;
                break;
            }
        }
        if (!referrerUid) return toast("Referrer not found!");
        const currentBal = Number(users[referrerUid].referralBonus || users[referrerUid].referralBalance || 0);
        await update(ref(db, `users/${referrerUid}`), { referralBonus: (currentBal + Number(amount)).toFixed(2) });

        if (type === "signup") {
            await update(ref(db, `users/${targetId}/referralGiven`), { approved: true, approvedAt: Date.now() });
        } else {
            await update(ref(db, `orders/${targetId}`), { commissionPaid: true });
        }
        toast("Approved Successfully!");
        loadReferralRequests();
    } catch (e) { toast("Error: " + e.message); }
};

window.rejectAction = async (targetId, type) => {
    if(!confirm("Reject this request?")) return;
    if (type === "signup") {
        await update(ref(db, `users/${targetId}/referralGiven`), { rejected: true });
    } else {
        await update(ref(db, `orders/${targetId}`), { commissionPaid: "rejected" });
    }
    toast("Request Rejected");
    loadReferralRequests();
};

document.getElementById("logoutBtn").onclick = () => {
    signOut(auth).then(() => location.href="admin_login.html");
};
</script>
<div style="padding: 20px 15px;">
    <a href="admin-ads.html" class="wide-btn" style="background: #1e293b; color: white; border: 1px solid #334155; opacity: 0.8;">
        <i class="fas fa-lock"></i> MANAGE DASHBOARD ADS
<a href="admin.html">
  <button>Go to Admin</button>
</a>
    
   
</div>

<style>
    .admin-portal-btn {
        background: #0f172a; /* Dark professional blue */
        color: white;
        border: 2px solid #3b82f6;
        transition: transform 0.2s;
    }
    .admin-portal-btn:active {
        transform: scale(0.98);
    }
</style>

    </a>
</div>

</body>
</html>
