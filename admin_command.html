<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin - Gigantic Data Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --bg: #f8fafc; --card: #ffffff; }
        [data-theme="dark"] { --bg: #020617; --card: #0f172a; --primary: #1e293b; }
        body { background: var(--bg); color: #1e293b; font-family: 'Inter', sans-serif; transition: 0.3s; }
        [data-theme="dark"] body { color: #f1f5f9; }
        .node-item { border-left: 2px solid #e2e8f0; margin-left: 10px; padding-left: 15px; }
        [data-theme="dark"] .node-item { border-left-color: #334155; }
        .json-key { color: #ef4444; font-weight: bold; font-family: monospace; }
        .json-val { color: #10b981; font-family: monospace; }
        .btn-action { font-size: 10px; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; font-weight: bold; }
    </style>
</head>
<body class="min-h-screen">

<header class="bg-[#0f172a] text-white p-5 sticky top-0 z-50 flex justify-between items-center shadow-lg">
    <div class="flex items-center gap-3">
        <i class="fas fa-database text-blue-400"></i>
        <h1 class="text-lg font-black uppercase tracking-tighter">Master Real-Time Console</h1>
    </div>
    <div class="flex gap-4">
        <button onclick="location.reload()" class="bg-blue-600 px-4 py-1 rounded text-xs font-bold"><i class="fas fa-sync"></i> Refresh</button>
        <a href="dashboard.html" class="bg-slate-700 px-4 py-1 rounded text-xs font-bold">Exit</a>
    </div>
</header>

<div class="max-w-6xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <div class="lg:col-span-2 space-y-4">
        <div class="bg-[var(--card)] rounded-2xl p-6 shadow-sm border border-slate-200 dark:border-slate-800">
            <h2 class="text-xs font-black text-slate-400 uppercase mb-4 tracking-widest"><i class="fas fa-sitemap mr-2"></i> Database Nodes</h2>
            <div id="dbTree" class="space-y-2 overflow-x-auto">
                <p class="text-xs text-slate-500 italic">Connecting to gigantic-data-default-rtdb...</p>
            </div>
        </div>
    </div>

    <div class="space-y-6">
        <div class="bg-[var(--card)] rounded-3xl p-6 shadow-xl border-2 border-purple-500/20 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10">
                <i class="fas fa-key fa-4x text-purple-500"></i>
            </div>
            <h2 class="text-sm font-black text-purple-500 uppercase mb-4 flex items-center gap-2">
                <i class="fas fa-bell animate-bounce"></i> Security Requests
            </h2>
            <div id="passwordRequests" class="space-y-3">
                <div class="text-center py-10 text-slate-400">
                    <i class="fas fa-check-double fa-2x mb-2"></i>
                    <p class="text-[10px] font-bold uppercase">All Clean</p>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl p-6 text-white shadow-lg">
            <h3 class="text-[10px] font-black uppercase opacity-60 mb-4 tracking-widest">System Health</h3>
            <div class="flex justify-between items-end">
                <div>
                    <p class="text-3xl font-black" id="totalUsersStat">0</p>
                    <p class="text-[10px] font-bold opacity-80 uppercase">Active Users</p>
                </div>
                <i class="fas fa-users fa-2x opacity-20"></i>
            </div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBmu4xukuT0Z7oD_vA9QroeO-1ZuaK8JgA",
    authDomain: "gigantic-data.firebaseapp.com",
    databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
    projectId: "gigantic-data"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const ADMIN_EMAIL = "alenacloft0@gmail.com";

onAuthStateChanged(auth, (user) => {
    if (user && user.email === ADMIN_EMAIL) {
        startConsole();
    } else {
        window.location.replace("login.html");
    }
});

function startConsole() {
    // 1. Listen for ALL Nodes
    onValue(ref(db, '/'), (snapshot) => {
        const data = snapshot.val();
        renderTree(data);
        if(data.users) document.getElementById('totalUsersStat').innerText = Object.keys(data.users).length;
        
        // Filter Password Requests (Users who updated their profile password recently)
        processSecurityAlerts(data.users);
    });
}

function renderTree(data) {
    const tree = document.getElementById('dbTree');
    tree.innerHTML = "";
    
    Object.keys(data).forEach(nodeName => {
        const details = data[nodeName];
        const count = typeof details === 'object' ? Object.keys(details).length : 1;
        
        const nodeDiv = document.createElement('div');
        nodeDiv.className = "mb-2 p-3 bg-slate-50 dark:bg-slate-900/50 rounded-lg group transition-all";
        nodeDiv.innerHTML = `
            <div class="flex justify-between items-center cursor-pointer" onclick="this.nextElementSibling.classList.toggle('hidden')">
                <div class="flex items-center gap-2">
                    <i class="fas fa-folder text-yellow-500"></i>
                    <span class="json-key text-sm">${nodeName}</span>
                    <span class="text-[9px] bg-slate-200 dark:bg-slate-800 px-2 py-0.5 rounded-full font-bold">${count} items</span>
                </div>
                <button class="text-rose-500 opacity-0 group-hover:opacity-100 transition-all" onclick="confirmPurge('${nodeName}')">
                    <i class="fas fa-trash-alt text-xs"></i>
                </button>
            </div>
            <div class="hidden mt-3 node-item space-y-1">
                <pre class="text-[10px] text-slate-400 overflow-x-auto">${JSON.stringify(details, null, 2).substring(0, 500)}...</pre>
                <a href="admin_audit.html" class="text-blue-500 text-[10px] font-bold uppercase underline">Manage Full Node</a>
            </div>
        `;
        tree.appendChild(nodeDiv);
    });
}

function processSecurityAlerts(users) {
    const container = document.getElementById('passwordRequests');
    container.innerHTML = "";
    
    const alerts = Object.entries(users).filter(([uid, data]) => data.password).slice(-5); // Show latest 5

    if (alerts.length === 0) {
        container.innerHTML = `<div class="text-center py-10 text-slate-400 text-xs">No active requests</div>`;
        return;
    }

    alerts.forEach(([uid, uData]) => {
        const div = document.createElement('div');
        div.className = "p-3 bg-purple-50 dark:bg-purple-900/20 rounded-xl border border-purple-200 dark:border-purple-800 flex justify-between items-center";
        div.innerHTML = `
            <div class="overflow-hidden">
                <p class="text-[10px] font-black text-purple-600 truncate uppercase">${uData.fullName || 'User'}</p>
                <p class="text-[11px] font-mono text-slate-500">PASS: ${uData.password}</p>
            </div>
            <button onclick="clearPassRequest('${uid}')" class="bg-purple-500 text-white p-2 rounded-lg hover:bg-purple-600 transition">
                <i class="fas fa-check text-xs"></i>
            </button>
        `;
        container.appendChild(div);
    });
}

window.clearPassRequest = (uid) => {
    if(confirm("Mark this security update as audited?")) {
        // Here we just acknowledge it, or we could move the password to a 'secure' field
        alert("Security update audited for: " + uid);
    }
}

window.confirmPurge = (node) => {
    const pass = prompt(`DANGER: Type 'DELETE ${node.toUpperCase()}' to wipe this node.`);
    if (pass === `DELETE ${node.toUpperCase()}`) {
        remove(ref(db, node)).then(() => alert("Node Purged"));
    }
}
</script>
</body>
</html>
