<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin | Gigantic Data Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --bg: #f8fafc; --card: #ffffff; }
        [data-theme="dark"] { --bg: #020617; --card: #0f172a; --primary: #1e293b; }
        body { background: var(--bg); color: #1e293b; font-family: 'Inter', sans-serif; transition: 0.3s; }
        [data-theme="dark"] body { color: #f1f5f9; }
        .node-item { border-left: 2px solid #e2e8f0; margin-left: 10px; padding-left: 15px; }
        [data-theme="dark"] .node-item { border-left-color: #334155; }
        .json-key { color: #ef4444; font-weight: bold; font-family: monospace; }
        .json-val { color: #10b981; font-family: monospace; }
        .btn-action { font-size: 10px; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; font-weight: bold; }
        .admin-badge { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    </style>
</head>
<body class="min-h-screen">

<header class="bg-[#0f172a] text-white p-5 sticky top-0 z-50 flex justify-between items-center shadow-lg">
    <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center">
            <i class="fas fa-terminal text-blue-400"></i>
        </div>
        <div>
            <h1 class="text-sm font-black uppercase tracking-tighter leading-none">Gigantic Master Console</h1>
            <p class="text-[10px] text-slate-400 mt-1" id="adminStatus">Verifying session...</p>
        </div>
    </div>
    <div class="flex gap-3">
        <button onclick="location.reload()" class="bg-blue-600 px-4 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-blue-700 transition-all">
            <i class="fas fa-sync-alt mr-1"></i> Refresh
        </button>
        <a href="dashboard.html" class="bg-slate-700 px-4 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-slate-600 transition-all">Exit</a>
    </div>
</header>

<div class="max-w-6xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <div class="lg:col-span-2 space-y-4">
        <div class="bg-[var(--card)] rounded-3xl p-6 shadow-sm border border-slate-200 dark:border-slate-800">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest"><i class="fas fa-project-diagram mr-2"></i> Real-Time Tree</h2>
                <div class="text-[10px] font-bold text-emerald-500 bg-emerald-500/10 px-3 py-1 rounded-full border border-emerald-500/20">
                    <i class="fas fa-circle text-[6px] mr-2 animate-pulse"></i> Live Connection
                </div>
            </div>
            <div id="dbTree" class="space-y-3 overflow-x-auto min-h-[300px]">
                <p class="text-xs text-slate-500 italic">Initializing handshake with gigantic-data-default-rtdb...</p>
            </div>
        </div>
    </div>

    <div class="space-y-6">
        <div class="bg-[var(--card)] rounded-3xl p-6 shadow-sm border border-slate-200 dark:border-slate-800">
             <h3 class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">Master Identity</h3>
             <div class="flex items-center gap-4">
                 <div class="w-12 h-12 rounded-full admin-badge flex items-center justify-center text-white text-xl">
                     <i class="fas fa-user-shield"></i>
                 </div>
                 <div class="overflow-hidden">
                     <p class="text-xs font-black truncate" id="adminEmailDisplay">Not Signed In</p>
                     <span class="text-[9px] font-bold text-emerald-500 uppercase tracking-widest">Root Access Granted</span>
                 </div>
             </div>
        </div>

        <div class="bg-[var(--card)] rounded-3xl p-6 shadow-xl border-2 border-purple-500/20 relative overflow-hidden">
            <h2 class="text-sm font-black text-purple-500 uppercase mb-4 flex items-center gap-2">
                <i class="fas fa-shield-alt animate-pulse"></i> Audit Alerts
            </h2>
            <div id="passwordRequests" class="space-y-3">
                <div class="text-center py-10 text-slate-400">
                    <i class="fas fa-fingerprint fa-2x mb-2 opacity-20"></i>
                    <p class="text-[10px] font-bold uppercase tracking-widest">No New Requests</p>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-br from-blue-600 to-indigo-800 rounded-3xl p-6 text-white shadow-xl">
            <h3 class="text-[10px] font-black uppercase opacity-60 mb-6 tracking-widest text-center">Cloud Environment</h3>
            <div class="flex justify-around items-center">
                <div class="text-center">
                    <p class="text-3xl font-black" id="totalUsersStat">0</p>
                    <p class="text-[9px] font-bold uppercase tracking-tighter opacity-70">Total Users</p>
                </div>
                <div class="w-[1px] h-10 bg-white/20"></div>
                <div class="text-center">
                    <p class="text-3xl font-black" id="orderCountStat">0</p>
                    <p class="text-[9px] font-bold uppercase tracking-tighter opacity-70">Master Orders</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBmu4xukuT0Z7oD_vA9QroeO-1ZuaK8JgA",
    authDomain: "gigantic-data.firebaseapp.com",
    databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
    projectId: "gigantic-data"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const MASTER_ADMIN = "alenacloft0@gmail.com";

onAuthStateChanged(auth, (user) => {
    if (user && user.email.toLowerCase() === MASTER_ADMIN.toLowerCase()) {
        document.getElementById('adminStatus').innerText = "Authenticated: Root User";
        document.getElementById('adminEmailDisplay').innerText = user.email;
        document.getElementById('adminEmailDisplay').title = user.email;
        startConsole();
    } else {
        window.location.replace("login.html");
    }
});

function startConsole() {
    onValue(ref(db, '/'), (snapshot) => {
        const data = snapshot.val() || {};
        renderTree(data);
        
        // Update Stats
        if(data.users) document.getElementById('totalUsersStat').innerText = Object.keys(data.users).length;
        if(data.orders) document.getElementById('orderCountStat').innerText = Object.keys(data.orders).length;
        
        // Security logic
        processSecurityAlerts(data.users || {});
    });
}

function renderTree(data) {
    const tree = document.getElementById('dbTree');
    tree.innerHTML = "";
    
    Object.keys(data).forEach(nodeName => {
        const details = data[nodeName];
        const count = typeof details === 'object' && details !== null ? Object.keys(details).length : 1;
        
        const nodeDiv = document.createElement('div');
        nodeDiv.className = "group bg-slate-50 dark:bg-slate-900/40 border border-slate-200 dark:border-slate-800/50 rounded-2xl overflow-hidden transition-all";
        nodeDiv.innerHTML = `
            <div class="p-4 flex justify-between items-center cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800/50 transition-colors" onclick="this.nextElementSibling.classList.toggle('hidden')">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-500/10 rounded-lg flex items-center justify-center text-blue-500">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <div>
                        <span class="json-key text-xs">${nodeName}</span>
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">${count} sub-entries found</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button class="text-rose-500 text-xs opacity-0 group-hover:opacity-100 transition-all hover:scale-110" onclick="confirmPurge('${nodeName}')" title="DANGER: Purge Node">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <i class="fas fa-chevron-down text-[10px] text-slate-300"></i>
                </div>
            </div>
            <div class="hidden p-4 border-t border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950/50">
                <pre class="text-[10px] font-mono text-slate-400 overflow-x-auto whitespace-pre-wrap max-h-40">${JSON.stringify(details, null, 2)}</pre>
                <div class="mt-4 flex gap-2">
                    <a href="admin_audit.html?node=${nodeName}" class="btn-action bg-blue-500 text-white">Full Audit</a>
                    <button onclick="copyNode('${nodeName}')" class="btn-action bg-slate-200 dark:bg-slate-800 text-slate-500">Copy Path</button>
                </div>
            </div>
        `;
        tree.appendChild(nodeDiv);
    });
}

function processSecurityAlerts(users) {
    const container = document.getElementById('passwordRequests');
    container.innerHTML = "";
    
    // Filter users with password fields (profile updates)
    const alerts = Object.entries(users).filter(([uid, data]) => data.password).slice(-5);

    if (alerts.length === 0) {
        container.innerHTML = `<div class="text-center py-10 text-slate-400 text-xs uppercase tracking-widest opacity-50">Secure: No Audit Required</div>`;
        return;
    }

    alerts.forEach(([uid, uData]) => {
        const div = document.createElement('div');
        div.className = "p-4 bg-purple-50 dark:bg-purple-900/10 rounded-2xl border border-purple-100 dark:border-purple-800/50 flex justify-between items-center";
        div.innerHTML = `
            <div class="overflow-hidden">
                <p class="text-[10px] font-black text-purple-600 truncate uppercase">${uData.fullName || 'Unknown Identity'}</p>
                <p class="text-[11px] font-mono text-slate-500 mt-1">PWD: <span class="bg-white px-2 rounded">${uData.password}</span></p>
            </div>
            <button onclick="clearPassRequest('${uid}')" class="w-8 h-8 bg-purple-600 text-white rounded-xl shadow-lg shadow-purple-500/30 hover:bg-purple-700 transition-all">
                <i class="fas fa-check text-[10px]"></i>
            </button>
        `;
        container.appendChild(div);
    });
}

window.clearPassRequest = (uid) => {
    alert("Audit completed for user: " + uid);
}

window.copyNode = (name) => {
    navigator.clipboard.writeText(name);
    alert("Node path copied: " + name);
}

window.confirmPurge = (node) => {
    const confirmStr = `DELETE ${node.toUpperCase()}`;
    const pass = prompt(`DANGER ZONE: To permanently wipe ${node}, type: ${confirmStr}`);
    if (pass === confirmStr) {
        remove(ref(db, node)).then(() => alert("Master Wipe Complete. Node removed from cloud."));
    }
}
</script>
</body>
</html>
