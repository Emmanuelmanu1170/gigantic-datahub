<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdraw Bonus - Gigantic Data Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #6a5af9; --deep: #0a2a66; --error: #ef4444; --accent: #ff8c00; --success: #10b981; }
        body { background: #f4f7ff; font-family: 'Segoe UI', sans-serif; margin: 0; color: var(--deep); }
        header { background: var(--deep); color: white; padding: 18px; display: flex; align-items: center; gap: 15px; position: sticky; top: 0; z-index: 100; }
        header h3 { margin: 0; font-size: 1.1rem; }
        
        .card { background: white; margin: 20px auto; padding: 25px; border-radius: 20px; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        .balance-box { background: linear-gradient(135deg, #6a5af9 0%, #4a3aff 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; color: white; text-align: center; }
        .balance-box span { font-size: 0.8rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
        .balance-box h2 { font-size: 2.2rem; margin: 10px 0 0; font-weight: 800; }

        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #64748b; }
        
        input, select { 
            width: 100%; padding: 14px; border: 1px solid #e2e8f0; border-radius: 10px; 
            box-sizing: border-box; font-size: 1rem; outline: none; transition: 0.3s;
            background: #f8fafc;
        }
        input:focus, select:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(106, 90, 249, 0.1); }

        .info-note { font-size: 0.75rem; color: #64748b; margin-top: 5px; display: flex; align-items: center; gap: 5px; }
        
        .btn-withdraw { 
            background: var(--primary); color: white; border: none; width: 100%; 
            padding: 16px; border-radius: 12px; font-weight: 700; cursor: pointer; 
            font-size: 1rem; margin-top: 10px; transition: 0.3s;
        }
        .btn-withdraw:hover { background: #5649d8; transform: translateY(-2px); }
        .btn-withdraw:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; }

        .status-msg { margin-top: 15px; padding: 10px; border-radius: 8px; font-size: 12px; font-weight: 600; display: none; text-align: center; }
        .msg-success { background: #dcfce7; color: var(--success); }

        .leaderboard { margin-top: 30px; border-top: 1px solid #edf2f7; padding-top: 20px; }
        .leader-title { font-size: 0.9rem; font-weight: 800; display: flex; align-items: center; gap: 8px; margin-bottom: 15px; color: var(--accent); }
        .leader-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f8fafc; }
        .leader-rank { width: 24px; height: 24px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900; }
        .rank-1 { background: #ffd700; color: #000; }
        .leader-name { font-size: 13px; font-weight: 600; flex: 1; margin-left: 10px; }
        .leader-count { font-size: 12px; font-weight: 800; color: #10b981; }
    </style>
</head>
<body>

<header>
    <a href="referral.html" style="color:white; text-decoration:none;"><i class="fas fa-arrow-left"></i></a>
    <h3>Withdraw to MoMo</h3>
</header>

<div class="card">
    <div class="balance-box">
        <span>Approved Rewards</span>
        <h2 id="bonusBalance">₵0.00</h2>
    </div>

    <div id="successNote" class="status-msg msg-success">
        <i class="fas fa-check-circle"></i> Request sent! Admin will pay to your MoMo soon.
    </div>

    <div class="form-group">
        <label>Withdrawal Amount</label>
        <input type="number" id="withdrawAmt" placeholder="Minimum ₵27.00">
        <div class="info-note"><i class="fas fa-shield-alt"></i> Only Admin-approved bonuses can be withdrawn.</div>
    </div>

    <div class="form-group">
        <label>Network</label>
        <select id="momoNetwork">
            <option value="MTN">MTN Mobile Money</option>
            <option value="Telecel">Telecel Cash</option>
            <option value="AT">AT Money</option>
        </select>
    </div>

    <div class="form-group">
        <label>MoMo Number</label>
        <input type="tel" id="momoNumber" placeholder="05XXXXXXXX">
    </div>

    <div class="form-group">
        <label>Account Name</label>
        <input type="text" id="momoName" placeholder="Full name on account">
    </div>

    <button class="btn-withdraw" id="submitBtn">PROCEED WITHDRAWAL</button>

    <div class="leaderboard">
        <div class="leader-title"><i class="fas fa-trophy"></i> Top 5 Referrers</div>
        <div id="leaderList">
            <p style="font-size: 12px; color: #94a3b8; text-align: center;">Syncing Hall of Fame...</p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { getDatabase, ref, onValue, push, set, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBmiippVd5uyAb51U9upNNpSvJk0lXSNg4",
        authDomain: "gigantic-data.firebaseapp.com",
        databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
        projectId: "gigantic-data"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentApprovedBonus = 0;

    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = "login.html";
            return;
        }

        // 1. SYNC APPROVED BONUS BALANCE
        const userRef = ref(db, `users/${user.uid}`);
        onValue(userRef, (snap) => {
            const data = snap.val() || {};
            currentApprovedBonus = parseFloat(data.referralBonus || 0);
            document.getElementById('bonusBalance').innerText = "₵" + currentApprovedBonus.toFixed(2);
        }, (error) => console.error("Balance Load Error:", error));

        // 2. SYNC LEADERBOARD (REAL-TIME)
        const topRefQuery = query(ref(db, 'users'), orderByChild('referralCount'), limitToLast(20));
        onValue(topRefQuery, (snap) => {
            const list = document.getElementById('leaderList');
            list.innerHTML = "";
            let users = [];
            
            snap.forEach(child => { 
                const u = child.val();
                if(u.referralCount > 0) users.push(u); 
            });

            users.sort((a,b) => (b.referralCount || 0) - (a.referralCount || 0));

            if(users.length === 0) {
                list.innerHTML = "<p style='font-size:11px; text-align:center; color:#94a3b8;'>No referrals approved yet.</p>";
                return;
            }

            users.slice(0, 5).forEach((u, i) => {
                const name = u.fullName || "Member";
                const row = `
                    <div class="leader-item">
                        <div class="leader-rank ${i === 0 ? 'rank-1' : ''}">${i + 1}</div>
                        <div class="leader-name">${name.split(' ')[0]}***</div>
                        <div class="leader-count">${u.referralCount || 0} refs</div>
                    </div>`;
                list.innerHTML += row;
            });
        }, (error) => console.error("Leaderboard Sync Error:", error));

        // 3. WITHDRAWAL LOGIC
        document.getElementById('submitBtn').onclick = async () => {
            const amt = parseFloat(document.getElementById('withdrawAmt').value);
            const net = document.getElementById('momoNetwork').value;
            const num = document.getElementById('momoNumber').value.trim();
            const name = document.getElementById('momoName').value.trim();
            const btn = document.getElementById('submitBtn');
            
            if (!amt || amt < 27) { 
                alert("Minimum withdrawal is GH₵ 27.00."); 
                return; 
            }
            if (amt > currentApprovedBonus) { 
                alert("Insufficient balance! Approved: GH₵ " + currentApprovedBonus.toFixed(2)); 
                return; 
            }
            if (num.length < 10 || name === "") {
                alert("Please check your MoMo number or name.");
                return;
            }

            if(!confirm(`Send withdrawal request for GH₵ ${amt.toFixed(2)}?`)) return;

            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Sending Request...`;

            try {
                // Generate a request in the global queue for Admin Panel
                const requestRef = push(ref(db, 'withdrawal_requests'));
                await set(requestRef, {
                    uid: user.uid,
                    email: user.email,
                    amount: amt,
                    network: net,
                    momoNumber: num,
                    accountName: name,
                    status: "Pending",
                    timestamp: Date.now()
                });

                document.getElementById('withdrawAmt').value = "";
                document.getElementById('successNote').style.display = "block";
                alert("Success! Your request has been sent to the Admin for payout.");
                
            } catch (err) {
                alert("Request Failed: " + err.message);
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.innerText = "PROCEED WITHDRAWAL";
            }
        };
    });
</script>
</body>
</html>
