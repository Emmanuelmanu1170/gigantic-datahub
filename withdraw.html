<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdraw Bonus - Gigantic Data Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #6a5af9; --deep: #0a2a66; --error: #ef4444; --accent: #ff8c00; }
        body { background: #f4f7ff; font-family: 'Segoe UI', sans-serif; margin: 0; color: var(--deep); }
        header { background: var(--deep); color: white; padding: 18px; display: flex; align-items: center; gap: 15px; position: sticky; top: 0; z-index: 100; }
        header h3 { margin: 0; font-size: 1.1rem; }
        
        .card { background: white; margin: 20px auto; padding: 25px; border-radius: 20px; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        .balance-box { background: linear-gradient(135deg, #6a5af9 0%, #4a3aff 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; color: white; text-align: center; }
        .balance-box span { font-size: 0.8rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
        .balance-box h2 { font-size: 2.2rem; margin: 10px 0 0; font-weight: 800; }

        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #64748b; }
        
        input, select { 
            width: 100%; padding: 14px; border: 1px solid #e2e8f0; border-radius: 10px; 
            box-sizing: border-box; font-size: 1rem; outline: none; transition: 0.3s;
            background: #f8fafc;
        }
        input:focus, select:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(106, 90, 249, 0.1); }

        .info-note { font-size: 0.75rem; color: #64748b; margin-top: 5px; display: flex; align-items: center; gap: 5px; }
        
        .btn-withdraw { 
            background: var(--primary); color: white; border: none; width: 100%; 
            padding: 16px; border-radius: 12px; font-weight: 700; cursor: pointer; 
            font-size: 1rem; margin-top: 10px; transition: 0.3s;
        }
        .btn-withdraw:hover { background: #5649d8; transform: translateY(-2px); }
        .btn-withdraw:active { transform: translateY(0); }

        /* Top Referrers Styles */
        .leaderboard { margin-top: 30px; border-top: 1px solid #edf2f7; padding-top: 20px; }
        .leader-title { font-size: 0.9rem; font-weight: 800; display: flex; align-items: center; gap: 8px; margin-bottom: 15px; color: var(--accent); }
        .leader-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f8fafc; }
        .leader-rank { width: 24px; height: 24px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900; }
        .rank-1 { background: #ffd700; color: #000; }
        .leader-name { font-size: 13px; font-weight: 600; flex: 1; margin-left: 10px; }
        .leader-count { font-size: 12px; font-weight: 800; color: #10b981; }
    </style>
</head>
<body>

<header>
    <a href="dashboard.html" style="color:white; text-decoration:none;"><i class="fas fa-arrow-left"></i></a>
    <h3>Withdraw to MoMo</h3>
</header>

<div class="card">
    <div class="balance-box">
        <span>Referral Rewards</span>
        <h2 id="bonusBalance">₵0.00</h2>
    </div>

    <div class="form-group">
        <label>Withdrawal Amount</label>
        <input type="number" id="withdrawAmt" placeholder="Minimum ₵27.00">
        <div class="info-note"><i class="fas fa-info-circle"></i> Minimum withdrawal is GH₵ 27.00</div>
    </div>

    <div class="form-group">
        <label>Network</label>
        <select id="momoNetwork">
            <option value="MTN">MTN Mobile Money</option>
            <option value="Telecel">Telecel Cash</option>
            <option value="AT">AT Money</option>
        </select>
    </div>

    <div class="form-group">
        <label>MoMo Number</label>
        <input type="tel" id="momoNumber" placeholder="05XXXXXXXX">
    </div>

    <div class="form-group">
        <label>Account Name</label>
        <input type="text" id="momoName" placeholder="Full name on account">
    </div>

    <button class="btn-withdraw" id="submitBtn">PROCEED WITHDRAWAL</button>

    <div class="leaderboard">
        <div class="leader-title"><i class="fas fa-trophy"></i> Top 5 Referrers</div>
        <div id="leaderList">
            <p style="font-size: 12px; color: #94a3b8; text-align: center;">Loading leaderboard...</p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { getDatabase, ref, onValue, push, set, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBmiippVd5uyAb51U9upNNpSvJk0lXSNg4",
        authDomain: "gigantic-data.firebaseapp.com",
        databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
        projectId: "gigantic-data",
        storageBucket: "gigantic-data.firebasestorage.app",
        messagingSenderId: "727845403550",
        appId: "1:727845403550:web:e3c3a40ce615aaaca9748f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentBonus = 0;

    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = "login.html";
            return;
        }

        // Real-time listener for referral wallet
        onValue(ref(db, `users/${user.uid}`), (snap) => {
            const data = snap.val();
            currentBonus = parseFloat(data.referralBonus || 0);
            document.getElementById('bonusBalance').innerText = "₵" + currentBonus.toFixed(2);
        });

        // Load Top Referrers
        const topRefQuery = query(ref(db, 'users'), orderByChild('referralCount'), limitToLast(5));
        onValue(topRefQuery, (snap) => {
            const list = document.getElementById('leaderList');
            list.innerHTML = "";
            let users = [];
            snap.forEach(child => { users.push(child.val()); });
            users.sort((a,b) => (b.referralCount || 0) - (a.referralCount || 0));

            if(users.length === 0) {
                list.innerHTML = "<p style='font-size:11px; text-align:center; color:#94a3b8;'>No data available.</p>";
                return;
            }

            users.forEach((u, i) => {
                const name = u.fullName || "Member";
                const row = `
                    <div class="leader-item">
                        <div class="leader-rank ${i === 0 ? 'rank-1' : ''}">${i + 1}</div>
                        <div class="leader-name">${name.split(' ')[0]}***</div>
                        <div class="leader-count">${u.referralCount || 0} refs</div>
                    </div>`;
                list.innerHTML += row;
            });
        });

        document.getElementById('submitBtn').onclick = () => {
            const amt = parseFloat(document.getElementById('withdrawAmt').value);
            const net = document.getElementById('momoNetwork').value;
            const num = document.getElementById('momoNumber').value.trim();
            const name = document.getElementById('momoName').value.trim();
            
            if (!amt || amt < 27) { 
                alert("Minimum withdrawal amount is GH₵ 27.00"); 
                return; 
            }
            if (amt > currentBonus) { 
                alert("Insufficient Referral Bonus! You only have GH₵ " + currentBonus.toFixed(2)); 
                return; 
            }
            if (num.length < 10 || name === "") {
                alert("Please provide valid MoMo details.");
                return;
            }

            if(!confirm(`Withdraw GH₵ ${amt.toFixed(2)} to ${num} (${net})?`)) return;

            const reqRef = push(ref(db, 'withdrawal_requests'));
            set(reqRef, {
                uid: user.uid,
                email: user.email,
                amount: amt,
                method: "Mobile Money",
                network: net,
                momoNumber: num,
                accountName: name,
                status: "Pending",
                timestamp: Date.now()
            }).then(() => {
                alert("Success! Your withdrawal request has been sent to Admin for payment.");
                document.getElementById('withdrawAmt').value = "";
                document.getElementById('momoNumber').value = "";
                document.getElementById('momoName').value = "";
            }).catch(err => {
                alert("Error: " + err.message);
            });
        };
    });
</script>
</body>
</html>
