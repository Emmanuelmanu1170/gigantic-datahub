<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard - Gigantic Data Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #001f3f; --accent: #ff8c00; --bg: #f8fafc;
            --card-bg: #ffffff; --text: #1e293b;
        }
        [data-theme="dark"] {
            --bg: #0b0e14; --card-bg: #161b22; --text: #c9d1d9; --primary: #010409;
        }

        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--card-bg); padding: 15px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05); text-align: center; }
        
        .rank-pill { width: 30px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 0.8rem; }
        .gold { background: linear-gradient(135deg, #ffd700, #b8860b); color: white; }
        .silver { background: linear-gradient(135deg, #c0c0c0, #708090); color: white; }
        .bronze { background: linear-gradient(135deg, #cd7f32, #8b4513); color: white; }
        .normal { background: #f1f5f9; color: #64748b; }
        [data-theme="dark"] .normal { background: #30363d; color: #8b949e; }

        .user-row { 
            background: var(--card-bg); border-radius: 16px; padding: 12px 16px; 
            margin-bottom: 10px; display: flex; align-items: center; gap: 15px;
            border: 1px solid rgba(0,0,0,0.05); transition: transform 0.2s; cursor: pointer;
        }
        .user-row:hover { transform: scale(1.01); }
        
        .uid-tag { font-family: 'Roboto Mono', monospace; font-size: 10px; color: #94a3b8; background: rgba(0,0,0,0.03); padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body>

<header class="p-5 bg-[#001f3f] text-white sticky top-0 z-50 flex justify-between items-center">
    <div class="flex items-center gap-4">
        <a href="dashboard.html"><i class="fas fa-arrow-left text-white"></i></a>
        <h1 class="text-lg font-black tracking-tight">TOP USERS</h1>
    </div>
    <div class="bg-orange-500 px-3 py-1 rounded-full text-xs font-bold">
        ADMIN AUDIT
    </div>
</header>

<div class="max-w-xl mx-auto p-4">
    <div class="stats-grid">
        <div class="stat-card">
            <p class="text-[10px] font-bold text-slate-400 uppercase">System Liquidity</p>
            <h2 id="totalVault" class="text-xl font-black text-blue-600">₵0.00</h2>
        </div>
        <div class="stat-card">
            <p class="text-[10px] font-bold text-slate-400 uppercase">Tracked Users</p>
            <h2 id="userCount" class="text-xl font-black text-orange-500">0</h2>
        </div>
    </div>

    <div id="leaderboardList">
        <div id="auth-status" class="text-center py-20 text-slate-400">
            <i class="fas fa-lock fa-2x mb-3"></i>
            <p class="font-bold">Verifying Admin Permissions...</p>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBmu4xukuT0Z7oD_vA9QroeO-1ZuaK8JgA",
    authDomain: "gigantic-data.firebaseapp.com",
    databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
    projectId: "gigantic-data"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const ADMIN_EMAIL = "alenacloft0@gmail.com";

onAuthStateChanged(auth, (user) => {
    if (user && user.email === ADMIN_EMAIL) {
        // User is the master admin, proceed to load data
        loadLeaderboard();
    } else if (user) {
        // Logged in but not the master admin
        document.getElementById('leaderboardList').innerHTML = `
            <div class="text-center py-20 text-red-500">
                <i class="fas fa-shield-alt fa-3x mb-3"></i>
                <h3 class="font-black">ACCESS DENIED</h3>
                <p class="text-sm">Only the Master Admin can view the global leaderboard.</p>
            </div>`;
    } else {
        window.location.replace("login.html");
    }
});

function loadLeaderboard() {
    // Queries the top 50 users by balance as allowed by admin rules
    const topUsersQuery = query(ref(db, 'users'), orderByChild('balance'), limitToLast(50));

    onValue(topUsersQuery, (snapshot) => {
        const listDiv = document.getElementById('leaderboardList');
        let users = [];
        let totalSystemBalance = 0;

        snapshot.forEach((child) => {
            const data = child.val();
            users.push({ uid: child.key, ...data });
            totalSystemBalance += parseFloat(data.balance || 0);
        });

        users.reverse(); // Highest balance first

        document.getElementById('totalVault').innerText = `₵${totalSystemBalance.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('userCount').innerText = users.length;

        listDiv.innerHTML = "";
        
        users.forEach((user, index) => {
            const rank = index + 1;
            let rankClass = "normal";
            if (rank === 1) rankClass = "gold";
            else if (rank === 2) rankClass = "silver";
            else if (rank === 3) rankClass = "bronze";

            const card = document.createElement('div');
            card.className = "user-row";
            card.innerHTML = `
                <div class="rank-pill ${rankClass}">${rank}</div>
                <div class="flex-1">
                    <div class="flex justify-between items-start">
                        <h4 class="font-black text-sm uppercase">${user.name || 'Anonymous'}</h4>
                        <span class="font-black text-blue-600">₵${parseFloat(user.balance || 0).toFixed(2)}</span>
                    </div>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="uid-tag">ID: ${user.uid}</span>
                        <span class="text-[9px] font-bold text-slate-400 uppercase">${user.role || 'Member'}</span>
                    </div>
                </div>
                <div class="text-slate-300">
                    <i class="fas fa-chevron-right text-xs"></i>
                </div>
            `;
            
            card.onclick = () => {
                sessionStorage.setItem('impersonate_uid', user.uid);
                sessionStorage.setItem('isAdminImpersonating', 'true');
                window.location.href = 'activity.html';
            };

            listDiv.appendChild(card);
        });
    }, (error) => {
        console.error(error);
        document.getElementById('leaderboardList').innerHTML = `<div class="text-center py-20 text-slate-400">Permission error: ${error.message}</div>`;
    });
}
</script>
</body>
</html>
