<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Audit - Gigantic Data</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #001f3f; --accent: #ff8c00; --bg: #f8fafc;
            --card-bg: #ffffff; --text: #1e293b;
        }
        [data-theme="dark"] {
            --bg: #0b0e14; --card-bg: #161b22; --text: #c9d1d9; --primary: #010409;
        }

        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--card-bg); padding: 15px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05); text-align: center; }
        
        .section-title { font-size: 0.7rem; font-weight: 900; color: #94a3b8; text-transform: uppercase; letter-spacing: 1.5px; margin: 25px 0 12px 5px; display: flex; align-items: center; gap: 8px; }

        .rank-pill { width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 0.75rem; color: white; }
        .gold { background: linear-gradient(135deg, #ffd700, #b8860b); }
        .silver { background: linear-gradient(135deg, #c0c0c0, #708090); }
        .bronze { background: linear-gradient(135deg, #cd7f32, #8b4513); }
        .normal { background: #94a3b8; }

        .user-row { 
            background: var(--card-bg); border-radius: 16px; padding: 12px 16px; 
            margin-bottom: 10px; display: flex; align-items: center; gap: 15px;
            border: 1px solid rgba(0,0,0,0.05); transition: 0.2s; cursor: pointer;
        }
        .user-row:hover { border-color: var(--accent); transform: translateY(-2px); }
        
        .uid-tag { font-family: 'Roboto Mono', monospace; font-size: 9px; color: #6366f1; background: #eef2ff; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        [data-theme="dark"] .uid-tag { background: #1e293b; color: #818cf8; }
        
        .email-text { font-size: 0.7rem; color: #64748b; display: block; margin-top: 1px; }
    </style>
</head>
<body>

<header class="p-5 bg-[#001f3f] text-white sticky top-0 z-50 flex justify-between items-center">
    <div class="flex items-center gap-4">
        <a href="dashboard.html"><i class="fas fa-arrow-left text-white"></i></a>
        <h1 class="text-lg font-black tracking-tight">USER AUDIT</h1>
    </div>
    <div class="bg-orange-500 px-3 py-1 rounded-full text-[10px] font-bold uppercase">Master Admin</div>
</header>

<div class="max-w-xl mx-auto p-4">
    <div class="stats-grid">
        <div class="stat-card">
            <p class="text-[10px] font-bold text-slate-400 uppercase">Total Liquidity</p>
            <h2 id="totalVault" class="text-xl font-black text-blue-600">₵0.00</h2>
        </div>
        <div class="stat-card">
            <p class="text-[10px] font-bold text-slate-400 uppercase">Total Users</p>
            <h2 id="userCount" class="text-xl font-black text-orange-500">0</h2>
        </div>
    </div>

    <div class="section-title"><i class="fas fa-trophy text-yellow-500"></i> Top 10 Rankings</div>
    <div id="topRankings"></div>

    <div class="section-title"><i class="fas fa-users"></i> Full User Directory</div>
    <div id="fullDirectory">
        <div class="text-center py-20 text-slate-400">
            <i class="fas fa-circle-notch fa-spin fa-2x mb-3"></i>
            <p class="font-bold">Syncing Database...</p>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBmu4xukuT0Z7oD_vA9QroeO-1ZuaK8JgA",
    authDomain: "gigantic-data.firebaseapp.com",
    databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
    projectId: "gigantic-data"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const ADMIN_EMAIL = "alenacloft0@gmail.com";

onAuthStateChanged(auth, (user) => {
    if (user && user.email === ADMIN_EMAIL) {
        loadAuditData();
    } else if (user) {
        document.body.innerHTML = `<div class="h-screen flex items-center justify-center text-red-500 font-bold">Unauthorized Access</div>`;
    } else {
        window.location.replace("login.html");
    }
});

function loadAuditData() {
    const usersRef = ref(db, 'users');

    onValue(usersRef, (snapshot) => {
        const topDiv = document.getElementById('topRankings');
        const fullDiv = document.getElementById('fullDirectory');
        
        let allUsers = [];
        let totalSystemBalance = 0;

        snapshot.forEach((child) => {
            const data = child.val();
            allUsers.push({ uid: child.key, ...data });
            totalSystemBalance += parseFloat(data.balance || 0);
        });

        // Update Stats
        document.getElementById('totalVault').innerText = `₵${totalSystemBalance.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('userCount').innerText = allUsers.length;

        // Sort for Top 10
        let top10 = [...allUsers].sort((a, b) => (parseFloat(b.balance) || 0) - (parseFloat(a.balance) || 0)).slice(0, 10);
        
        // Sort Full Directory (Alphabetical or by Role)
        let directory = [...allUsers].sort((a, b) => (a.name || '').localeCompare(b.name || ''));

        // Render Top 10
        topDiv.innerHTML = "";
        top10.forEach((user, index) => {
            topDiv.appendChild(createUserCard(user, index + 1, true));
        });

        // Render Full Directory
        fullDiv.innerHTML = "";
        directory.forEach((user) => {
            fullDiv.appendChild(createUserCard(user, null, false));
        });

    }, (error) => {
        fullDiv.innerHTML = `<p class="text-center text-red-500">${error.message}</p>`;
    });
}

function createUserCard(user, rank, isRanked) {
    const card = document.createElement('div');
    card.className = "user-row";
    
    let rankHtml = "";
    if (isRanked) {
        let rankClass = rank === 1 ? "gold" : rank === 2 ? "silver" : rank === 3 ? "bronze" : "normal";
        rankHtml = `<div class="rank-pill ${rankClass}">${rank}</div>`;
    } else {
        rankHtml = `<div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400"><i class="fas fa-user text-xs"></i></div>`;
    }

    card.innerHTML = `
        ${rankHtml}
        <div class="flex-1 overflow-hidden">
            <div class="flex justify-between items-start">
                <h4 class="font-black text-sm truncate uppercase">${user.name || 'Anonymous'}</h4>
                <span class="font-black text-blue-600 text-sm">₵${parseFloat(user.balance || 0).toFixed(2)}</span>
            </div>
            <span class="email-text truncate">${user.email || 'No Email'}</span>
            <div class="flex items-center gap-2 mt-2">
                <span class="uid-tag">ID: ${user.uid.substring(0, 12)}...</span>
                <span class="text-[8px] font-black text-slate-400 uppercase tracking-tighter">${user.role || 'Member'}</span>
            </div>
        </div>
    `;
    
    card.onclick = () => {
        sessionStorage.setItem('impersonate_uid', user.uid);
        sessionStorage.setItem('isAdminImpersonating', 'true');
        window.location.href = 'activity.html';
    };
    
    return card;
}
</script>
</body>
</html>
