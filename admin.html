<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GiganticData Admin Hub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --admin-blue: #0f172a;
            --accent-blue: #3b82f6;
            --success-green: #22c55e;
            --warning-orange: #f59e0b;
            --bg-gray: #f8fafc;
            --card-white: #ffffff;
        }

        body {
            margin: 0; font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-gray); color: var(--admin-blue); padding: 20px;
        }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-white); padding: 20px; border-radius: 15px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border-top: 4px solid var(--accent-blue);
        }

        .stat-card h3 { margin: 0; font-size: 11px; text-transform: uppercase; color: #64748b; letter-spacing: 0.5px; }
        .stat-card .value { font-size: 26px; font-weight: 800; margin: 10px 0; display: block; }
        .stat-card .sub-text { font-size: 11px; color: #94a3b8; }

        .revenue-card { border-top-color: var(--success-green); }
        .warning-card { border-top-color: var(--warning-orange); }

        .admin-section {
            background: var(--card-white); padding: 25px; border-radius: 15px;
            margin-bottom: 30px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }

        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        input[type="text"] {
            flex: 1; padding: 14px; border: 1px solid #e2e8f0; border-radius: 12px; outline: none; font-size: 14px;
        }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 15px; background: #f8fafc; color: #64748b; font-weight: 600; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; }

        .badge { padding: 5px 10px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .badge-user { background: #e0f2fe; color: #0369a1; }
        .badge-agent { background: #fef3c7; color: #92400e; }

        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div style="text-align:center;">
            <i class="fas fa-circle-notch fa-spin fa-2x" style="color: var(--accent-blue);"></i>
            <p>Verifying Admin Access...</p>
        </div>
    </div>

    <div class="header">
        <div>
            <h1 style="margin:0;">Admin Control Center</h1>
            <p style="color: #64748b; margin: 5px 0 0; font-size: 14px;">Managing GiganticData Ecosystem</p>
        </div>
        <button class="refresh-btn" onclick="location.reload()" style="padding: 10px 20px; background: var(--admin-blue); color: white; border: none; border-radius: 10px; cursor: pointer;">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>New Users (7D)</h3>
            <span class="value" id="newUsers7">0</span>
            <span class="sub-text">Acquisition in last 7 days</span>
        </div>
        <div class="stat-card">
            <h3>Orders Today</h3>
            <span class="value" id="ordersToday">0</span>
            <span class="sub-text">Completed or Successful</span>
        </div>
        <div class="stat-card revenue-card">
            <h3>Today's Net Profit (4%)</h3>
            <span class="value" id="revenueToday" style="color: var(--success-green);">GH₵ 0.00</span>
            <span class="sub-text" id="grossSales">Gross: GH₵ 0.00</span>
        </div>
        <div class="stat-card warning-card">
            <h3>System Liabilities</h3>
            <span class="value" id="totalLiabilities" style="color: var(--warning-orange);">GH₵ 0.00</span>
            <span class="sub-text" id="circulatingMain">Main Wallets: GH₵ 0.00</span>
        </div>
    </div>

    <div class="admin-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin:0;">User Management</h3>
            <div id="totalUserCount" style="font-size: 12px; font-weight: bold; background: #eee; padding: 5px 12px; border-radius: 20px;">0 Users Total</div>
        </div>
        <div class="search-box">
            <input type="text" id="userSearchInput" placeholder="Search by name or email...">
        </div>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Email</th>
                        <th>Ref Balance</th>
                        <th>Main Wallet</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <tr><td colspan="5" style="text-align:center;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBmiippVd5uyAb51U9upNNpSvJk0lXSNg4",
            authDomain: "gigantic-data.firebaseapp.com",
            databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
            projectId: "gigantic-data",
            storageBucket: "gigantic-data.firebasestorage.app",
            messagingSenderId: "727845403550",
            appId: "1:727845403550:web:e3c3a40ce615aaaca9748f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const ADMIN_EMAIL = 'alenacloft0@gmail.com';

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ADMIN_EMAIL) {
                document.getElementById('loadingOverlay').style.display = 'none';
                loadAdminData();
            } else {
                alert("Unauthorized");
                window.location.href = "dashboard.html"; 
            }
        });

        function loadAdminData() {
            // Get Start of Today (local time)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const startOfTodayTimestamp = today.getTime();
            const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);

            // 1. Process Users
            onValue(ref(db, 'users'), (snapshot) => {
                const users = snapshot.val() || {};
                let userList = [];
                let newUserCount = 0;
                let totalRefDebt = 0;
                let totalMainDebt = 0;

                Object.values(users).forEach(u => {
                    const refBal = parseFloat(u.referralBonus || 0);
                    const mainBal = parseFloat(u.wallet || 0);
                    if (u.createdAt && u.createdAt > sevenDaysAgo) newUserCount++;
                    totalRefDebt += refBal;
                    totalMainDebt += mainBal;

                    userList.push({
                        fullName: u.fullName || 'User',
                        email: u.email || 'N/A',
                        refBal: refBal,
                        mainBal: mainBal,
                        status: u.status || 'User'
                    });
                });

                document.getElementById('newUsers7').innerText = newUserCount;
                document.getElementById('totalUserCount').innerText = `${userList.length} Users`;
                document.getElementById('totalLiabilities').innerText = `GH₵ ${totalRefDebt.toFixed(2)}`;
                document.getElementById('circulatingMain').innerText = `Main Wallets: GH₵ ${totalMainDebt.toFixed(2)}`;
                renderUserTable(userList);
                setupSearch(userList);
            });

            // 2. Process Orders (Fixed Logic)
            onValue(ref(db, 'orders'), (snapshot) => {
                const orders = snapshot.val() || {};
                let dailyCount = 0;
                let dailySales = 0;

                Object.values(orders).forEach(order => {
                    // Normalize Status to uppercase for comparison
                    const status = (order.status || "").toUpperCase();
                    const orderTime = order.timestamp || 0;

                    // If order is today AND (Successful OR Completed)
                    if (orderTime >= startOfTodayTimestamp && (status === 'SUCCESSFUL' || status === 'COMPLETED')) {
                        dailyCount++;
                        dailySales += parseFloat(order.amount || 0);
                    }
                });

                const netProfit = dailySales * 0.04;
                document.getElementById('ordersToday').innerText = dailyCount;
                document.getElementById('revenueToday').innerText = `GH₵ ${netProfit.toFixed(2)}`;
                document.getElementById('grossSales').innerText = `Gross: GH₵ ${dailySales.toFixed(2)}`;
                
                console.log("Admin Log:", { dailyCount, dailySales, startOfTodayTimestamp });
            });
        }

        function renderUserTable(data) {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = data.map(u => `
                <tr>
                    <td><b>${u.fullName}</b></td>
                    <td>${u.email}</td>
                    <td style="color: #ff8c00; font-weight: 700;">GH₵ ${u.refBal.toFixed(2)}</td>
                    <td style="font-weight: 600;">GH₵ ${u.mainBal.toFixed(2)}</td>
                    <td><span class="badge ${u.status === 'Agent' ? 'badge-agent' : 'badge-user'}">${u.status}</span></td>
                </tr>
            `).join('');
        }

        function setupSearch(data) {
            const input = document.getElementById('userSearchInput');
            input.oninput = () => {
                const val = input.value.toLowerCase();
                const filtered = data.filter(u => 
                    u.fullName.toLowerCase().includes(val) || 
                    u.email.toLowerCase().includes(val)
                );
                renderUserTable(filtered);
            };
        }
    </script>
</body>
</html>
