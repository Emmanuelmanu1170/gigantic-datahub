<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchant Hub Pro â€” GiganticDataHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --primary: #003366; 
            --merchant-green: #10b981; 
            --gold: #fbbf24; 
            --bg: #f4f7fe; 
            --white: #ffffff; 
            --text-main: #1e293b;
            --text-gray: #64748b;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding-bottom: 100px; color: var(--text-main); }
        
        /* HEADER */
        .merchant-header {
            background: linear-gradient(135deg, var(--primary) 0%, #001a33 100%); 
            color: white; padding: 40px 20px 80px;
            border-bottom-left-radius: 40px; border-bottom-right-radius: 40px;
            text-align: center;
        }
        .shop-title { font-size: 1.5rem; font-weight: 900; letter-spacing: -0.5px; }
        .badge-agent { background: var(--gold); color: #000; padding: 5px 15px; border-radius: 20px; font-size: 11px; font-weight: 900; display: inline-block; margin-top: 10px; }

        /* STATS CARDS */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: -50px 20px 20px; }
        .stat-card {
            background: var(--white); padding: 22px 15px; border-radius: 24px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.06); text-align: center;
            border: 1px solid rgba(255,255,255,0.8);
        }
        .stat-card b { display: block; font-size: 22px; color: var(--primary); margin-bottom: 4px; }
        .stat-card span { font-size: 10px; color: #64748b; text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; }

        /* PROFIT CALCULATOR */
        .profit-calculator {
            background: var(--white); margin: 0 20px 25px; padding: 20px; 
            border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.06);
        }
        .calc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calc-header h4 { margin: 0; font-size: 13px; color: #64748b; }
        .profit-display { font-size: 24px; font-weight: 900; color: var(--merchant-green); margin-bottom: 15px; }
        
        .toggle-group { display: flex; background: #f1f5f9; padding: 5px; border-radius: 12px; gap: 5px; }
        .toggle-btn { 
            flex: 1; border: none; padding: 8px; border-radius: 8px; 
            font-size: 12px; font-weight: 800; cursor: pointer; background: transparent; 
            color: #64748b; transition: 0.3s;
        }
        .toggle-btn.active { background: var(--white); color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        /* TOOLS GRID */
        .section { padding: 0 20px; margin-bottom: 30px; }
        .section-header { margin-bottom: 15px; font-size: 12px; font-weight: 900; color: #64748b; text-transform: uppercase; letter-spacing: 1px; }
        
        .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .tool-box {
            background: var(--white); padding: 20px; border-radius: 20px; 
            text-align: center; text-decoration: none; color: inherit;
            border: 1px solid #edf2f7; transition: 0.3s;
        }
        .tool-box:active { transform: scale(0.95); }
        .tool-box i { font-size: 24px; margin-bottom: 10px; display: block; }
        .tool-box b { font-size: 13px; }

        /* RECEIPT CARDS FOR HISTORY */
        .order-card {
            background: var(--white);
            border-radius: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            padding: 20px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .order-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1.5px dashed #e2e8f0; padding-bottom: 15px; margin-bottom: 15px;
        }
        .network-icon {
            width: 40px; height: 40px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 12px; color: white;
        }
        .mtn-bg { background: #FFCC00; color: #000; }
        .tel-bg { background: #E60000; }
        .air-bg { background: #0052CC; }

        .order-details { display: flex; flex-direction: column; gap: 6px; }
        .detail-row { display: flex; justify-content: space-between; align-items: center; }
        .detail-row span { font-size: 11px; color: var(--text-gray); }
        .detail-row b { font-size: 12px; color: var(--text-main); }

        .order-footer {
            margin-top: 12px; padding-top: 12px; border-top: 1.5px dashed #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .amount-paid { font-size: 16px; font-weight: 900; color: var(--primary); }
        .status-pill {
            font-size: 9px; font-weight: 800; padding: 4px 10px;
            border-radius: 30px; text-transform: uppercase;
        }
        .status-completed { background: #ecfdf5; color: #047857; }
        .status-pending { background: #fffbeb; color: #b45309; }

        /* NAV */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: var(--white);
            display: flex; justify-content: space-around; padding: 15px 0;
            border-top: 1px solid #eee; z-index: 1000;
        }
        .nav-item { text-align: center; color: #94a3b8; text-decoration: none; font-size: 11px; font-weight: 700; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); }
    </style>
</head>
<body>

<div class="merchant-header">
    <div class="shop-title"><i class="fas fa-store-alt"></i> Merchant Terminal</div>
    <span class="badge-agent">CERTIFIED VENDOR PARTNER</span>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <b id="agentWallet">â‚µ0.00</b>
        <span>Wallet Bal</span>
    </div>
    <div class="stat-card">
        <b id="lifetimeSales">0</b>
        <span>Lifetime Sales</span>
    </div>
</div>

<div class="profit-calculator">
    <div class="calc-header">
        <h4>Est. Profit (Today)</h4>
        <i class="fas fa-chart-line" style="color: var(--merchant-green)"></i>
    </div>
    <div class="profit-display" id="profitDisplay">â‚µ0.00</div>
    <div class="toggle-group">
        <button class="toggle-btn" onclick="setProfitMargin(0.3, this)">30%</button>
        <button class="toggle-btn active" onclick="setProfitMargin(0.4, this)">40%</button>
        <button class="toggle-btn" onclick="setProfitMargin(0.5, this)">50%</button>
    </div>
</div>

<div class="section">
    <div class="section-header">Business Terminal</div>
    <div class="tools-grid">
        <a href="order.html" class="tool-box">
            <i class="fas fa-wifi" style="color: #3b82f6;"></i>
            <b>Buy Data</b>
        </a>
        <a href="agent_tools.html" class="tool-box">
            <i class="fas fa-tools" style="color: #a855f7;"></i>
            <b>Agent Tools</b>
        </a>
        <a href="receipt.html" class="tool-box">
            <i class="fas fa-file-invoice-dollar" style="color: #10b981;"></i>
            <b>Receipts</b>
        </a>
        <div class="tool-box" onclick="shareMarketingKit()" style="cursor:pointer;">
            <i class="fab fa-whatsapp" style="color: #25d366;"></i>
            <b>Marketing</b>
        </div>
    </div>
</div>

<div class="section">
    <div class="section-header">Recent Business History</div>
    <div id="historyContainer">
        <p style="text-align: center; font-size: 12px; color: #94a3b8; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Syncing transactions...</p>
    </div>
</div>

<nav class="bottom-nav">
    <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i>Home</a>
    <a href="agent_shop.html" class="nav-item active"><i class="fas fa-store"></i>Shop</a>
    <a href="order_history.html" class="nav-item"><i class="fas fa-history"></i>History</a>
    <a href="profile.html" class="nav-item"><i class="fas fa-user-tie"></i>Profile</a>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyBmiippVd5uyAb51U9upNNpSvJk0lXSNg4", 
        authDomain: "gigantic-data.firebaseapp.com", 
        databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com", 
        projectId: "gigantic-data" 
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentMargin = 0.4;
    let todaySalesVolume = 0;

    onAuthStateChanged(auth, user => {
        if (user) {
            // 1. Sync Wallet & Status
            onValue(ref(db, `users/${user.uid}`), snap => {
                const data = snap.val() || {};
                document.getElementById('agentWallet').innerText = "â‚µ" + Number(data.wallet || 0).toFixed(2);
                if(data.status !== 'Agent' && data.userType !== 'agent') window.location.href = "dashboard.html";
            });

            // 2. Sync Correct Order History Path
            const orderRef = ref(db, `user_orders/${user.uid}`);
            onValue(orderRef, (snapshot) => {
                const container = document.getElementById('historyContainer');
                const data = snapshot.val();

                if (!data) {
                    container.innerHTML = `<div style="text-align:center; padding:30px; color:#94a3b8;"><i class="fas fa-receipt fa-2x" style="opacity:0.2;"></i><p>No transactions yet</p></div>`;
                    document.getElementById('lifetimeSales').innerText = "0";
                    document.getElementById('profitDisplay').innerText = "â‚µ0.00";
                    return;
                }

                let html = "";
                let totalOrdersCount = 0;
                let todayCost = 0;
                const startOfToday = new Date().setHours(0,0,0,0);

                // Sort and Process Data
                const entries = Object.entries(data).sort((a,b) => b[1].timestamp - a[1].timestamp);
                totalOrdersCount = entries.length;

                entries.forEach(([id, order]) => {
                    const amount = parseFloat(order.amount || 0);
                    const ts = order.timestamp || Date.now();
                    const dateObj = new Date(ts);
                    
                    if (ts >= startOfToday) todayCost += amount;

                    const network = (order.network || 'MTN').toUpperCase();
                    let netClass = 'mtn-bg';
                    if(network.includes('TELECEL')) netClass = 'tel-bg';
                    if(network.includes('AT') || network.includes('AIRTEL')) netClass = 'air-bg';

                    const status = order.status || 'Completed';
                    const statusClass = `status-${status.toLowerCase().replace(" ", "-")}`;

                    // Build Receipt Card HTML
                    html += `
                        <div class="order-card">
                            <div class="order-header">
                                <div class="network-icon ${netClass}">${network.substring(0,3)}</div>
                                <div style="text-align:right">
                                    <div style="font-size:10px; font-family:monospace; color:var(--text-gray);">#${id.slice(-8)}</div>
                                    <div style="font-size:9px; color:#94a3b8;">${dateObj.toLocaleString()}</div>
                                </div>
                            </div>
                            <div class="order-details">
                                <div class="detail-row"><span>Data Plan</span><b>${order.plan || 'N/A'}</b></div>
                                <div class="detail-row"><span>Recipient</span><b>${order.recipient || 'N/A'}</b></div>
                            </div>
                            <div class="order-footer">
                                <div class="amount-paid">â‚µ${amount.toFixed(2)}</div>
                                <span class="status-pill ${statusClass}">${status}</span>
                            </div>
                        </div>
                    `;
                });

                // Update Dashboard Metrics
                document.getElementById('lifetimeSales').innerText = totalOrdersCount;
                todaySalesVolume = todayCost;
                updateProfitDisplay();
                container.innerHTML = html;
            });
        } else {
            window.location.href = "login.html";
        }
    });

    window.setProfitMargin = (val, el) => {
        currentMargin = val;
        document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        updateProfitDisplay();
    };

    function updateProfitDisplay() {
        // Profit = Sales Volume * Selected Percentage
        const profit = todaySalesVolume * currentMargin;
        document.getElementById('profitDisplay').innerText = "â‚µ" + profit.toFixed(2);
    }

    window.shareMarketingKit = () => {
        const msg = `ðŸš€ *GIGANTIC DATA MERCHANT* ðŸš€\n\nOfficial agent dashboard active. Buy cheap data instantly!\n\nDM me now to save money! âš¡`;
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
    };
</script>
</body>
</html>
