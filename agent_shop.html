<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchant Hub Pro â€” GiganticDataHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { 
            --primary: #003366; 
            --merchant-green: #10b981; 
            --gold: #fbbf24; 
            --bg: #f4f7fe; 
            --white: #ffffff; 
            --text-main: #1e293b;
            --text-gray: #64748b;
        }
        [data-theme="dark"] {
            --bg: #02040a; --white: #0d1117; --text-main: #f0f6fc; --text-gray: #8b949e; --primary: #1f6feb;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding-bottom: 100px; color: var(--text-main); transition: 0.3s; }
        
        .merchant-header {
            background: linear-gradient(135deg, var(--primary) 0%, #001a33 100%); 
            color: white; padding: 30px 20px 70px;
            border-bottom-left-radius: 40px; border-bottom-right-radius: 40px;
            text-align: center;
        }
        .shop-title { font-size: 1.3rem; font-weight: 900; letter-spacing: -0.5px; margin-bottom: 5px; }
        .user-meta { font-size: 11px; opacity: 0.8; font-weight: 600; margin-bottom: 10px; display: block; }
        .badge-agent { background: var(--gold); color: #000; padding: 5px 15px; border-radius: 20px; font-size: 10px; font-weight: 900; display: inline-block; text-transform: uppercase; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: -40px 20px 20px; }
        .stat-card {
            background: var(--white); padding: 22px 15px; border-radius: 24px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.06); text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-card b { display: block; font-size: 20px; color: var(--primary); margin-bottom: 4px; }
        .stat-card span { font-size: 10px; color: var(--text-gray); text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; }

        .profit-calculator {
            background: var(--white); margin: 0 20px 25px; padding: 20px; 
            border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.06);
        }
        .calc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calc-header h4 { margin: 0; font-size: 13px; color: var(--text-gray); }
        .profit-display { font-size: 24px; font-weight: 900; color: var(--merchant-green); margin-bottom: 15px; }
        
        .toggle-group { display: flex; background: #f1f5f9; padding: 5px; border-radius: 12px; gap: 5px; }
        [data-theme="dark"] .toggle-group { background: #161b22; }
        .toggle-btn { 
            flex: 1; border: none; padding: 8px; border-radius: 8px; 
            font-size: 12px; font-weight: 800; cursor: pointer; background: transparent; 
            color: var(--text-gray); transition: 0.3s;
        }
        .toggle-btn.active { background: var(--white); color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        .section { padding: 0 20px; margin-bottom: 30px; }
        .section-header { margin-bottom: 15px; font-size: 12px; font-weight: 900; color: var(--text-gray); text-transform: uppercase; letter-spacing: 1px; }
        
        .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .tool-box {
            background: var(--white); padding: 20px; border-radius: 20px; 
            text-align: center; text-decoration: none; color: inherit;
            border: 1px solid rgba(0,0,0,0.05); transition: 0.3s;
        }
        .tool-box i { font-size: 24px; margin-bottom: 10px; display: block; }
        .tool-box b { font-size: 13px; }

        .order-card {
            background: var(--white); border-radius: 20px; margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; border: 1px solid rgba(0,0,0,0.05);
        }
        .order-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1.5px dashed #e2e8f0; padding-bottom: 15px; margin-bottom: 15px;
        }
        .network-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 12px; color: white; }
        .mtn-bg { background: #FFCC00; color: #000; }
        .tel-bg { background: #E60000; }
        .air-bg { background: #0052CC; }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--white); display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid rgba(0,0,0,0.05); z-index: 1000; }
        .nav-item { text-align: center; color: #94a3b8; text-decoration: none; font-size: 11px; font-weight: 700; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); }
    </style>
</head>
<body>

<div id="authGuard" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:9999; display:flex; align-items:center; justify-content:center;">
    <div style="text-align:center;">
        <i class="fas fa-shield-alt fa-spin" style="font-size:40px; color:var(--primary);"></i>
        <p style="margin-top:15px; font-weight:800; color:var(--primary); font-size:11px; letter-spacing: 1px;">SYNCING MERCHANT TERMINAL...</p>
    </div>
</div>

<div class="merchant-header">
    <div class="shop-title"><i class="fas fa-store-alt"></i> Merchant Terminal</div>
    <span class="user-meta" id="userEmail">Loading...</span>
    <span class="badge-agent" id="userStatus">Verified Agent</span>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <b id="agentWallet">â‚µ0.00</b>
        <span>Real Balance</span>
    </div>
    <div class="stat-card">
        <b id="lifetimeSales">0</b>
        <span>Orders</span>
    </div>
</div>

<div class="profit-calculator">
    <div class="calc-header">
        <h4>Today's Est. Profit</h4>
        <i class="fas fa-chart-line" style="color: var(--merchant-green)"></i>
    </div>
    <div class="profit-display" id="profitDisplay">â‚µ0.00</div>
    <div class="toggle-group">
        <button class="toggle-btn" onclick="setProfitMargin(0.3, this)">30%</button>
        <button class="toggle-btn active" onclick="setProfitMargin(0.4, this)">40%</button>
        <button class="toggle-btn" onclick="setProfitMargin(0.5, this)">50%</button>
    </div>
</div>

<div class="section">
    <div class="section-header">Sales Operations</div>
    <div class="tools-grid">
        <a href="order.html" class="tool-box"><i class="fas fa-wifi" style="color: #3b82f6;"></i><b>New Sale</b></a>
        <a href="receipt.html" class="tool-box"><i class="fas fa-receipt" style="color: #a855f7;"></i><b>Ledger</b></a>
        <a href="agent_tools.html" class="tool-box"><i class="fas fa-id-card" style="color: #10b981;"></i><b>tools</b></a>
        <div class="tool-box" onclick="shareMarketingKit()" style="cursor:pointer;"><i class="fab fa-whatsapp" style="color: #25d366;"></i><b>Share Ads</b></div>
    </div>
</div>

<div class="section">
    <div class="section-header">Business Ledger</div>
    <div id="historyContainer">
        <p style="text-align: center; font-size: 11px; color: #94a3b8; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Reconciling History...</p>
    </div>
</div>

<nav class="bottom-nav">
    <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i>Home</a>
    <a href="agent_shop.html" class="nav-item active"><i class="fas fa-store"></i>Shop</a>
    <a href="transaction.html" class="nav-item"><i class="fas fa-history"></i>History</a>
    <a href="profile.html" class="nav-item"><i class="fas fa-user-tie"></i>Profile</a>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBmu4xukuT0Z7oD_vA9QroeO-1ZuaK8JgA",
        authDomain: "gigantic-data.firebaseapp.com",
        databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
        projectId: "gigantic-data"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentMargin = 0.4;
    let todaySalesVolume = 0;

    onAuthStateChanged(auth, user => {
        if (user) {
            document.getElementById('userEmail').innerText = user.email;
            syncTerminal(user);
        } else {
            window.location.replace("login.html");
        }
    });

    function syncTerminal(user) {
        document.getElementById('authGuard').style.display = 'none';

        // MASTER BALANCE SYNC (REVEALS REAL-TIME LIQUIDITY)
        onValue(ref(db, `users/${user.uid}`), snap => {
            const data = snap.val() || {};
            
            // Check both nodes to handle any legacy desync
            const bal = Number(data.balance || 0);
            const wal = Number(data.wallet || 0);
            const realBalance = Math.max(bal, wal);
            
            document.getElementById('agentWallet').innerText = "â‚µ" + realBalance.toFixed(2);
            
            const userStatus = data.userType || data.status || "Normal User";
            document.getElementById('userStatus').innerText = userStatus.toUpperCase();
        });

        // MERCHANT SALES HISTORY
        onValue(ref(db, `user_orders/${user.uid}`), (snapshot) => {
            const container = document.getElementById('historyContainer');
            const data = snapshot.val();
            if (!data) {
                container.innerHTML = `<p style="text-align:center; padding:30px; color:#94a3b8;">No records found.</p>`;
                return;
            }

            let html = "";
            let todayCost = 0;
            const startOfToday = new Date().setHours(0,0,0,0);
            const entries = Object.entries(data).sort((a,b) => (b[1].timestamp || 0) - (a[1].timestamp || 0));

            entries.slice(0, 10).forEach(([id, order]) => {
                const amount = parseFloat(order.amount || 0);
                const ts = order.timestamp || Date.now();
                if (ts >= startOfToday) todayCost += amount;

                const network = (order.network || 'MTN').toUpperCase();
                let netClass = network.includes('TEL') ? 'tel-bg' : (network.includes('AT') || network.includes('AIR') ? 'air-bg' : 'mtn-bg');

                html += `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="network-icon ${netClass}">${network.substring(0,3)}</div>
                            <div style="text-align:right">
                                <div style="font-size:9px; color:var(--text-gray); font-family: monospace;">#${id.slice(-8)}</div>
                                <div style="font-size:8px; color:var(--text-gray);">${new Date(ts).toLocaleTimeString()}</div>
                            </div>
                        </div>
                        <div style="font-size:12px; font-weight:700;">${order.plan} â†’ ${order.recipient}</div>
                        <div style="display:flex; justify-content:space-between; margin-top:10px; align-items:center;">
                            <div style="font-weight:900; color:var(--primary);">â‚µ${amount.toFixed(2)}</div>
                            <span style="font-size:9px; color:var(--merchant-green); font-weight:800;">${(order.status || 'Successful').toUpperCase()}</span>
                        </div>
                    </div>`;
            });

            document.getElementById('lifetimeSales').innerText = entries.length;
            todaySalesVolume = todayCost;
            updateProfitDisplay();
            container.innerHTML = html;
        });
    }

    window.setProfitMargin = (val, el) => {
        currentMargin = val;
        document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        updateProfitDisplay();
    };

    function updateProfitDisplay() {
        const profit = todaySalesVolume * currentMargin;
        document.getElementById('profitDisplay').innerText = "â‚µ" + profit.toFixed(2);
    }

    window.shareMarketingKit = () => {
        const msg = `ðŸš€ *CHEAP DATA DISPATCH* ðŸš€\nI'm now an official Merchant at GiganticDataHub!\nGet instant MTN, AT & Telecel data at low rates.\nDM for price list! âš¡`;
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
    };
</script>
</body>
</html>
