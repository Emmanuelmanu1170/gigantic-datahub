<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchant Hub Pro â€” GiganticDataHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --primary: #003366; 
            --merchant-green: #10b981; 
            --gold: #fbbf24; 
            --bg: #f4f7fe; 
            --white: #ffffff; 
            --text-main: #1e293b;
            --text-gray: #64748b;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding-bottom: 100px; color: var(--text-main); }
        
        /* HEADER */
        .merchant-header {
            background: linear-gradient(135deg, var(--primary) 0%, #001a33 100%); 
            color: white; padding: 30px 20px 70px;
            border-bottom-left-radius: 40px; border-bottom-right-radius: 40px;
            text-align: center;
        }
        .shop-title { font-size: 1.3rem; font-weight: 900; letter-spacing: -0.5px; margin-bottom: 5px; }
        .user-meta { font-size: 11px; opacity: 0.8; font-weight: 600; margin-bottom: 10px; display: block; }
        .badge-agent { background: var(--gold); color: #000; padding: 5px 15px; border-radius: 20px; font-size: 10px; font-weight: 900; display: inline-block; text-transform: uppercase; }

        /* STATS CARDS */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: -40px 20px 20px; }
        .stat-card {
            background: var(--white); padding: 22px 15px; border-radius: 24px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.06); text-align: center;
            border: 1px solid rgba(255,255,255,0.8);
        }
        .stat-card b { display: block; font-size: 20px; color: var(--primary); margin-bottom: 4px; }
        .stat-card span { font-size: 10px; color: #64748b; text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; }

        /* PROFIT CALCULATOR */
        .profit-calculator {
            background: var(--white); margin: 0 20px 25px; padding: 20px; 
            border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.06);
        }
        .calc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calc-header h4 { margin: 0; font-size: 13px; color: #64748b; }
        .profit-display { font-size: 24px; font-weight: 900; color: var(--merchant-green); margin-bottom: 15px; }
        
        .toggle-group { display: flex; background: #f1f5f9; padding: 5px; border-radius: 12px; gap: 5px; }
        .toggle-btn { 
            flex: 1; border: none; padding: 8px; border-radius: 8px; 
            font-size: 12px; font-weight: 800; cursor: pointer; background: transparent; 
            color: #64748b; transition: 0.3s;
        }
        .toggle-btn.active { background: var(--white); color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        .section { padding: 0 20px; margin-bottom: 30px; }
        .section-header { margin-bottom: 15px; font-size: 12px; font-weight: 900; color: #64748b; text-transform: uppercase; letter-spacing: 1px; }
        
        .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .tool-box {
            background: var(--white); padding: 20px; border-radius: 20px; 
            text-align: center; text-decoration: none; color: inherit;
            border: 1px solid #edf2f7; transition: 0.3s;
        }
        .tool-box:active { transform: scale(0.95); }
        .tool-box i { font-size: 24px; margin-bottom: 10px; display: block; }
        .tool-box b { font-size: 13px; }

        .order-card {
            background: var(--white); border-radius: 20px; margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; border: 1px solid rgba(0,0,0,0.05);
        }
        .order-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1.5px dashed #e2e8f0; padding-bottom: 15px; margin-bottom: 15px;
        }
        .network-icon {
            width: 40px; height: 40px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 12px; color: white;
        }
        .mtn-bg { background: #FFCC00; color: #000; }
        .tel-bg { background: #E60000; }
        .air-bg { background: #0052CC; }

        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: var(--white);
            display: flex; justify-content: space-around; padding: 15px 0;
            border-top: 1px solid #eee; z-index: 1000;
        }
        .nav-item { text-align: center; color: #94a3b8; text-decoration: none; font-size: 11px; font-weight: 700; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); }
    </style>
</head>
<body>

<div id="authGuard" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:9999; display:flex; align-items:center; justify-content:center;">
    <div style="text-align:center;">
        <i class="fas fa-shield-alt fa-spin" style="font-size:40px; color:var(--primary);"></i>
        <p style="margin-top:15px; font-weight:800; color:var(--primary); font-size:12px;">ESTABLISHING CONNECTION...</p>
    </div>
</div>

<div class="merchant-header">
    <div class="shop-title"><i class="fas fa-store-alt"></i> Merchant Terminal</div>
    <span class="user-meta" id="userEmail">Loading profile...</span>
    <span class="badge-agent" id="userStatus">SYNCING</span>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <b id="agentWallet">â‚µ0.00</b>
        <span>Wallet Bal</span>
    </div>
    <div class="stat-card">
        <b id="lifetimeSales">0</b>
        <span>Lifetime Sales</span>
    </div>
</div>

<div class="profit-calculator">
    <div class="calc-header">
        <h4>Est. Profit (Today)</h4>
        <i class="fas fa-chart-line" style="color: var(--merchant-green)"></i>
    </div>
    <div class="profit-display" id="profitDisplay">â‚µ0.00</div>
    <div class="toggle-group">
        <button class="toggle-btn" onclick="setProfitMargin(0.3, this)">30%</button>
        <button class="toggle-btn active" onclick="setProfitMargin(0.4, this)">40%</button>
        <button class="toggle-btn" onclick="setProfitMargin(0.5, this)">50%</button>
    </div>
</div>

<div class="section">
    <div class="section-header">Business Terminal</div>
    <div class="tools-grid">
        <a href="order.html" class="tool-box"><i class="fas fa-wifi" style="color: #3b82f6;"></i><b>Buy Data</b></a>
        <a href="agent_tools.html" class="tool-box"><i class="fas fa-tools" style="color: #a855f7;"></i><b>Agent Tools</b></a>
        <a href="receipt.html" class="tool-box"><i class="fas fa-file-invoice-dollar" style="color: #10b981;"></i><b>Receipts</b></a>
        <div class="tool-box" onclick="shareMarketingKit()" style="cursor:pointer;"><i class="fab fa-whatsapp" style="color: #25d366;"></i><b>Marketing</b></div>
    </div>
</div>

<div class="section">
    <div class="section-header">Recent Business History</div>
    <div id="historyContainer">
        <p style="text-align: center; font-size: 11px; color: #94a3b8; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Initializing ledger...</p>
    </div>
</div>

<nav class="bottom-nav">
    <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i>Home</a>
    <a href="agent_shop.html" class="nav-item active"><i class="fas fa-store"></i>Shop</a>
    <a href="order_history.html" class="nav-item"><i class="fas fa-history"></i>History</a>
    <a href="profile.html" class="nav-item"><i class="fas fa-user-tie"></i>Profile</a>
</nav>



<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCLl30c9nc09dZrkodA80hj5KSe9_B_aho",
        authDomain: "gigantic-data.firebaseapp.com",
        databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
        projectId: "gigantic-data",
        storageBucket: "gigantic-data.firebasestorage.app",
        messagingSenderId: "727845403550",
        appId: "1:727845403550:web:56d06c9389993153a9748f",
        measurementId: "G-10F198VFE6"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentMargin = 0.4;
    let todaySalesVolume = 0;

    // Persist login and handle session
    setPersistence(auth, browserLocalPersistence).then(() => {
        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('userEmail').innerText = user.email;
                syncTerminal(user);
            } else {
                // If user is null, we stay on page (No Redirect)
                console.warn("No active session found. Redirect inhibited.");
                document.getElementById('authGuard').innerHTML = '<p style="color:red; font-weight:800;">SESSION ERROR: PLEASE LOGIN</p>';
            }
        });
    });

    function syncTerminal(user) {
        // Show terminal UI
        document.getElementById('authGuard').style.display = 'none';

        onValue(ref(db, `users/${user.uid}`), snap => {
            const data = snap.val() || {};
            document.getElementById('agentWallet').innerText = "â‚µ" + Number(data.wallet || data.balance || 0).toFixed(2);
            
            const status = (data.status || data.userType || "Member");
            document.getElementById('userStatus').innerText = status.toUpperCase();
            
            // Note: Automated redirect to dashboard.html removed here.
        });

        onValue(ref(db, `user_orders/${user.uid}`), (snapshot) => {
            const container = document.getElementById('historyContainer');
            const data = snapshot.val();
            if (!data) {
                container.innerHTML = `<p style="text-align:center; padding:30px; color:#94a3b8;">No records found.</p>`;
                return;
            }

            let html = "";
            let todayCost = 0;
            const startOfToday = new Date().setHours(0,0,0,0);
            const entries = Object.entries(data).sort((a,b) => b[1].timestamp - a[1].timestamp);

            entries.forEach(([id, order]) => {
                const amount = parseFloat(order.amount || 0);
                const ts = order.timestamp || Date.now();
                if (ts >= startOfToday) todayCost += amount;

                const network = (order.network || 'MTN').toUpperCase();
                let netClass = network.includes('TELECEL') ? 'tel-bg' : (network.includes('AT') ? 'air-bg' : 'mtn-bg');

                html += `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="network-icon ${netClass}">${network.substring(0,3)}</div>
                            <div style="text-align:right"><div style="font-size:9px; color:var(--text-gray);">#${id.slice(-8)}</div></div>
                        </div>
                        <div style="font-size:12px; font-weight:700;">${order.plan} â†’ ${order.recipient}</div>
                        <div class="order-footer">
                            <div class="amount-paid">â‚µ${amount.toFixed(2)}</div>
                            <span style="font-size:9px; color:var(--merchant-green); font-weight:800;">${order.status || 'Success'}</span>
                        </div>
                    </div>`;
            });

            document.getElementById('lifetimeSales').innerText = entries.length;
            todaySalesVolume = todayCost;
            updateProfitDisplay();
            container.innerHTML = html;
        });
    }

    window.setProfitMargin = (val, el) => {
        currentMargin = val;
        document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        updateProfitDisplay();
    };

    function updateProfitDisplay() {
        const profit = todaySalesVolume * currentMargin;
        document.getElementById('profitDisplay').innerText = "â‚µ" + profit.toFixed(2);
    }

    window.shareMarketingKit = () => {
        const msg = `ðŸš€ *GIGANTIC DATA MERCHANT* ðŸš€\nPortal: GiganticDataHub\nUser: ${auth.currentUser.email}\nCheap data instantly! âš¡`;
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
    };
</script>
</body>
</html>
