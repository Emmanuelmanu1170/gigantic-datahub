<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin — All User Orders</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --deep-blue: #003366;
            --primary-blue: #0052cc;
            --orange-gradient: linear-gradient(135deg, #ff8c00 0%, #ff4500 100%);
            --light-bg: #f4f7fe;
            --white: #ffffff;
            --text-main: #1e293b;
            --success: #10b981;
            --pending: #f59e0b;
            --info: #3b82f6;
            --danger: #ef4444;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        body { background: var(--light-bg); color: var(--text-main); min-height: 100vh; }

        header {
            background: var(--deep-blue);
            color: white;
            padding: 15px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        header h1 { font-size: 1.1rem; font-weight: 800; letter-spacing: 0.5px; }

        .back-btn {
            background: rgba(255,255,255,0.15);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 700;
            transition: 0.3s;
        }

        .container { padding: 30px 5%; }

        .controls-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .control-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 0.7rem; font-weight: 800; color: var(--deep-blue); text-transform: uppercase; letter-spacing: 0.5px; }

        input, select {
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            font-size: 0.85rem;
            outline: none;
        }

        .table-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        table { width: 100%; border-collapse: collapse; min-width: 1000px; }

        th {
            background: #f8fafc;
            color: #64748b;
            font-size: 0.65rem;
            font-weight: 800;
            text-transform: uppercase;
            padding: 15px;
            text-align: left;
        }

        td { padding: 15px; font-size: 0.85rem; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }

        .order-meta b { color: var(--deep-blue); display: block; font-size: 0.9rem; }
        .order-meta span { font-size: 11px; color: #94a3b8; }

        .status-badge {
            font-size: 10px;
            font-weight: 800;
            padding: 4px 10px;
            border-radius: 20px;
            text-transform: uppercase;
        }

        .status-Pending { background: #fffbeb; color: #b45309; border: 1px solid #fde68a; }
        .status-Completed { background: #ecfdf5; color: #047857; border: 1px solid #a7f3d0; }
        .status-Canceled { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
        .status-In-Progress { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }

        .status-updater {
            padding: 6px;
            border-radius: 8px;
            font-size: 0.75rem;
            border: 1px solid #cbd5e1;
            background: #f8fafc;
            cursor: pointer;
            width: 130px;
        }

        .delete-btn {
            background: #fff;
            color: #94a3b8;
            border: 1px solid #e2e8f0;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
        }

        .delete-btn:hover { color: var(--danger); border-color: var(--danger); background: #fef2f2; }
    </style>
</head>
<body>

<header>
    <h1><i class="fas fa-tasks"></i> ADMIN ORDER CONTROL</h1>
    <a href="admin_dashboard.html" class="back-btn"><i class="fas fa-arrow-left"></i> Dashboard</a>
</header>

<div class="container">
    <div class="controls-card">
        <div class="control-group">
            <label>Search Users/Orders</label>
            <input type="text" id="searchInput" placeholder="Search Email, ID or Recipient...">
        </div>
        <div class="control-group">
            <label>Filter Status</label>
            <select id="statusFilter">
                <option value="all">All Statuses</option>
                <option value="Pending">Pending</option>
                <option value="In-Progress">In-Progress</option>
                <option value="Completed">Completed</option>
                <option value="Canceled">Canceled</option>
            </select>
        </div>
    </div>

    <div class="table-card">
        <div style="overflow-x: auto;">
            <table id="ordersTable">
                <thead>
                    <tr>
                        <th>Order ID & Date</th>
                        <th>Network/Plan</th>
                        <th>Amount</th>
                        <th>Recipient</th>
                        <th>Customer Email</th>
                        <th>Status</th>
                        <th style="text-align:right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="7" style="text-align:center; padding:50px;">Syncing Order Database...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getDatabase, ref, onValue, update, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBmiippVd5uyAb51U9upNNpSvJk0lXSNg4",
  authDomain: "gigantic-data.firebaseapp.com",
  databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
  projectId: "gigantic-data",
  storageBucket: "gigantic-data.firebasestorage.app",
  messagingSenderId: "727845403550",
  appId: "1:727845403550:web:e3c3a40ce615aaaca9748f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const tbody = document.querySelector("#ordersTable tbody");
const searchInput = document.getElementById("searchInput");
const statusFilter = document.getElementById("statusFilter");

let allOrders = [];
let userEmailMap = {}; // Local cache for UID -> Email mapping

onAuthStateChanged(auth, user => {
  if(user && user.email === "alenacloft0@gmail.com"){
    loadUsersAndOrders();
  } else {
    window.location.href = "login.html";
  }
});

// Step 1: Map UIDs to Emails to ensure customer identification is accurate
async function loadUsersAndOrders() {
    const usersRef = ref(db, "users");
    onValue(usersRef, (snapshot) => {
        const usersData = snapshot.val() || {};
        userEmailMap = {};
        Object.entries(usersData).forEach(([uid, info]) => {
            userEmailMap[uid] = info.email || "No Email";
        });
        listenAllOrders();
    });
}

// Step 2: Listen to orders and apply email logic
function listenAllOrders(){
  const ordersRef = ref(db, "user_orders");
  onValue(ordersRef, snapshot => {
    const data = snapshot.val() || {};
    allOrders = [];

    Object.entries(data).forEach(([uid, userOrders])=>{
      Object.entries(userOrders).forEach(([orderId, order])=>{
            let displayStatus = order.status || "Pending";
            if(displayStatus.toLowerCase() === "in progress") displayStatus = "In-Progress";

            // Email Logic: 1. Check order data, 2. Check user map, 3. Fallback
            const customerEmail = order.userEmail || order.email || userEmailMap[uid] || "Guest/Unknown";

            allOrders.push({
                network: order.network || "N/A",
                plan: order.plan || "N/A",
                amount: order.amount || 0,
                recipient: order.recipient || "N/A",
                email: customerEmail, 
                status: displayStatus,
                timestamp: order.timestamp || Date.now(),
                id: orderId,
                uid: uid
            });
      });
    });
    renderTable();
  });
}

function renderTable(){
  let entries = [...allOrders];
  const statusVal = statusFilter.value;
  const searchText = searchInput.value.toLowerCase();

  if(statusVal !== "all") entries = entries.filter(o => o.status === statusVal);

  if(searchText) {
    entries = entries.filter(o => 
        o.email.toLowerCase().includes(searchText) || 
        o.recipient.toLowerCase().includes(searchText) ||
        o.id.toLowerCase().includes(searchText)
    );
  }

  entries.sort((a,b)=> b.timestamp - a.timestamp);
  tbody.innerHTML = "";

  if(entries.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px;">No matching records found.</td></tr>`;
      return;
  }

  entries.forEach(order=>{
    const dateObj = new Date(order.timestamp);
    const dateStr = dateObj.toLocaleDateString();
    const timeStr = dateObj.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    const statusClass = order.status.replace(" ", "-");

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="order-meta"><b>#${order.id.slice(-6)}</b> <span>${dateStr} ${timeStr}</span></td>
      <td class="order-meta"><b>${order.network}</b> <span>${order.plan}</span></td>
      <td style="font-weight:700;">₵${parseFloat(order.amount).toFixed(2)}</td>
      <td>${order.recipient}</td>
      <td style="font-size:12px; font-weight:700; color:var(--deep-blue);">${order.email}</td>
      <td><span class="status-badge status-${statusClass}">${order.status}</span></td>
      <td style="text-align:right">
        <div style="display:flex; gap:5px; justify-content:flex-end;">
            <select class="status-updater" onchange="updateOrderStatus('${order.id}', this.value, '${order.uid}')">
                <option value="" disabled selected>Update</option>
                <option value="Pending">Pending</option>
                <option value="In-Progress">In-Progress</option>
                <option value="Completed">Completed</option>
                <option value="Canceled">Canceled</option>
            </select>
            <button class="delete-btn" onclick="deleteOrderRecord('${order.id}','${order.uid}')">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

window.updateOrderStatus = function(orderId, newStatus, uid){
    const updates = {};
    updates[`user_orders/${uid}/${orderId}/status`] = newStatus;
    updates[`orders/${orderId}/status`] = newStatus; // Updates global tracker if used

    update(ref(db), updates)
    .then(() => console.log("Success"))
    .catch((err) => alert("Update Error: " + err.message));
};

window.deleteOrderRecord = function(orderId, uid){
  if(confirm("Permanently delete this order record?")){
    const updates = {};
    updates[`user_orders/${uid}/${orderId}`] = null;
    updates[`orders/${orderId}`] = null;
    update(ref(db), updates);
  }
};

searchInput.addEventListener("input", renderTable);
statusFilter.addEventListener("change", renderTable);
</script>

</body>
</html>
