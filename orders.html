<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gigantic Admin â€” Real-Time Fulfillment</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --deep-blue: #003366; --primary-blue: #0052cc;
            --light-bg: #f4f7fe; --white: #ffffff; --text-main: #1e293b;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: -apple-system, sans-serif; }
        body { background: var(--light-bg); color: var(--text-main); min-height: 100vh; }
        header { background: var(--deep-blue); color: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        
        .container { padding: 30px 5%; }
        .api-banner { background: #0f172a; color: #4ade80; padding: 10px 5%; font-family: monospace; font-size: 11px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #1e293b; }
        .pulse { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; display: inline-block; margin-right: 5px; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        
        .table-card { background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: #f8fafc; color: #64748b; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; padding: 15px; text-align: left; }
        td { padding: 15px; font-size: 0.85rem; border-bottom: 1px solid #f1f5f9; }
        
        .status-badge { font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 20px; text-transform: uppercase; }
        .status-Pending { background: #fffbeb; color: #b45309; }
        .status-Completed { background: #ecfdf5; color: #047857; }
        .status-Processing { background: #eff6ff; color: #1e40af; }
        .status-Failed { background: #fdf2f2; color: #ef4444; }
        
        .log-card { background: #1e293b; color: #94a3b8; padding: 20px; border-radius: 15px; font-family: monospace; font-size: 12px; height: 180px; overflow-y: auto; border: 1px solid #334155; }
        .log-entry { border-bottom: 1px solid #334155; padding: 5px 0; }
        .log-success { color: #4ade80; }
        .log-err { color: #ef4444; }
    </style>
</head>
<body>

<div class="api-banner">
    <div><span class="pulse"></span> GIGANTIC AUTO-FULFILLMENT ENGINE: ONLINE</div>
    <div id="apiClock">00:00:00</div>
</div>

<header>
    <h1><i class="fas fa-microchip"></i> COMMAND CENTER</h1>
    <a href="admin_dashboard.html" style="color:white; text-decoration:none; font-weight:bold; font-size:13px;"><i class="fas fa-home"></i> Dashboard</a>
</header>

<div class="container">
    <div class="table-card">
        <div style="overflow-x: auto;">
            <table id="ordersTable">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Network</th>
                        <th>Recipient</th>
                        <th>Plan</th>
                        <th>User</th>
                        <th>Status</th>
                        <th style="text-align:right">Action</th>
                    </tr>
                </thead>
                <tbody id="orderTbody">
                    <tr><td colspan="7" style="text-align:center; padding:50px;">Listening for new orders...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="log-card" id="logConsole">
        <div id="logEntries"></div>
    </div>
</div>

<script>
// --- CORE CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyBmu4xukuT0Z7oD_vA9QroeO-1ZuaK8JgA",
    authDomain: "gigantic-data.firebaseapp.com",
    databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
    projectId: "gigantic-data"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const PROXY = "https://corsproxy.io/?";
const API_URL = "https://idatagh.com/wp-json/custom/v1/place-order";

let userCache = {};
let processedOrders = new Set(); // Prevents duplicate loops in the same session

// --- AUTH GUARD ---
auth.onAuthStateChanged(user => {
    if(user && user.email === "alenacloft0@gmail.com"){
        writeLog("Security Handshake Successful. Engine Ready.", true);
        initAutomation();
    } else { 
        window.location.href = "login.html"; 
    }
});

function writeLog(msg, isSuccess = false, isError = false) {
    const logDiv = document.getElementById("logEntries");
    const time = new Date().toLocaleTimeString();
    const style = isSuccess ? 'log-success' : (isError ? 'log-err' : '');
    logDiv.innerHTML = `<div class="log-entry ${style}">[${time}] ${msg}</div>` + logDiv.innerHTML;
}

function initAutomation() {
    // 1. Sync User Directory
    db.ref("users").on("value", snap => { userCache = snap.val() || {}; });

    // 2. Listen to Orders node - Triggers on any change
    db.ref("user_orders").on("value", snapshot => {
        const rootData = snapshot.val() || {};
        let tableData = [];

        Object.entries(rootData).forEach(([uid, orders]) => {
            Object.entries(orders).forEach(([orderId, order]) => {
                const fullOrder = { orderId, uid, ...order, email: userCache[uid]?.email || "User" };
                tableData.push(fullOrder);

                // AUTOMATIC TRIGGER: If status is Pending, send to API immediately
                if (order.status === "Pending" && !processedOrders.has(orderId)) {
                    processedOrders.add(orderId); // Lock order for processing
                    processOrder(fullOrder);
                }
            });
        });
        renderTable(tableData);
    });
}

async function processOrder(order) {
    writeLog(`NEW ORDER DETECTED: #${order.orderId.slice(-6)} for ${order.recipient}`);
    updateStatus(order.uid, order.orderId, "Processing");

    try {
        // Fetch API Key from your Secure Node
        const keySnap = await db.ref('admin_settings/idata_key').get();
        const apiKey = keySnap.val();

        if (!apiKey) {
            writeLog("CRITICAL: API Key missing in DB!", false, true);
            return;
        }

        // Format Network
        let net = order.network.toLowerCase();
        if (net.includes("at")) net = "at";
        else if (net.includes("telecel")) net = "telecel";
        else net = "mtn";

        // Extract numeric Plan ID (Logic: 1GB -> 1, 5GB -> 5)
        const planID = parseInt(order.plan.replace(/[^0-9]/g, '')) || 1;

        const payload = {
            "network": net,
            "beneficiary": order.recipient.toString().trim(),
            "pa_data-bundle-packages": planID
        };

        const response = await fetch(PROXY + encodeURIComponent(API_URL), {
            method: 'POST',
            headers: { 
                'Authorization': `Bearer ${apiKey}`, 
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        
        if (response.ok || result.status === "success") {
            writeLog(`FULFILLED: Order #${order.orderId.slice(-6)} Success.`, true);
            updateStatus(order.uid, order.orderId, "Completed");
        } else {
            writeLog(`REJECTED: ${result.message || 'Check iData Balance'}`, false, true);
            updateStatus(order.uid, order.orderId, "Failed");
        }
    } catch (err) {
        writeLog("CONNECTION ERROR: Proxy or API unreachable.", false, true);
        updateStatus(order.uid, order.orderId, "Failed");
    }
}

function updateStatus(uid, orderId, status) {
    const updates = {};
    updates[`user_orders/${uid}/${orderId}/status`] = status;
    updates[`orders/${orderId}/status`] = status; // Keep master list in sync
    db.ref().update(updates);
}

function renderTable(data) {
    const tbody = document.getElementById("orderTbody");
    tbody.innerHTML = "";
    
    // Show newest orders on top
    data.sort((a,b) => b.timestamp - a.timestamp).forEach(o => {
        const timeStr = new Date(o.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        tbody.innerHTML += `
            <tr>
                <td><small>${timeStr}</small></td>
                <td><b>${o.network.toUpperCase()}</b></td>
                <td><b>${o.recipient}</b></td>
                <td>${o.plan}</td>
                <td style="font-size:10px;">${o.email}</td>
                <td><span class="status-badge status-${o.status}">${o.status}</span></td>
                <td style="text-align:right">
                    <button onclick="deleteRow('${o.orderId}', '${o.uid}')" style="background:none; border:none; color:#cbd5e1; cursor:pointer;"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `;
    });
}

window.deleteRow = (oid, uid) => {
    if(confirm("Delete record?")) {
        db.ref(`user_orders/${uid}/${oid}`).remove();
        db.ref(`orders/${oid}`).remove();
    }
};

setInterval(() => { document.getElementById('apiClock').innerText = new Date().toLocaleTimeString(); }, 1000);
</script>
</body>
</html>
