<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin — Auto-API Order Control</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --deep-blue: #003366; --primary-blue: #0052cc; --orange-gradient: linear-gradient(135deg, #ff8c00 0%, #ff4500 100%);
            --light-bg: #f4f7fe; --white: #ffffff; --text-main: #1e293b; --success: #10b981;
            --pending: #f59e0b; --info: #3b82f6; --danger: #ef4444;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: -apple-system, sans-serif; }
        body { background: var(--light-bg); color: var(--text-main); min-height: 100vh; }
        header { background: var(--deep-blue); color: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .back-btn { background: rgba(255,255,255,0.15); color: white; padding: 8px 16px; border-radius: 8px; text-decoration: none; font-size: 0.8rem; font-weight: 700; }
        .container { padding: 30px 5%; }
        
        .api-banner { background: #0f172a; color: #4ade80; padding: 10px 5%; font-family: monospace; font-size: 11px; display: flex; justify-content: space-between; align-items: center; }
        .pulse { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; display: inline-block; margin-right: 5px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .controls-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
        .control-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 0.7rem; font-weight: 800; color: var(--deep-blue); text-transform: uppercase; }
        input, select { padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0; font-size: 0.85rem; outline: none; }

        .table-card { background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: #f8fafc; color: #64748b; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; padding: 15px; text-align: left; }
        td { padding: 15px; font-size: 0.85rem; border-bottom: 1px solid #f1f5f9; }
        .status-badge { font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 20px; text-transform: uppercase; border: 1px solid transparent; }
        .status-Pending { background: #fffbeb; color: #b45309; border-color: #fde68a; }
        .status-Completed { background: #ecfdf5; color: #047857; border-color: #a7f3d0; }
        .status-Flagged { background: #fef2f2; color: #b91c1c; border-color: #fecaca; font-weight: 900; }
        .status-Processing { background: #eff6ff; color: #1e40af; border-color: #bfdbfe; }
        .delete-btn { color: #94a3b8; border: 1px solid #e2e8f0; padding: 8px 10px; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>

<div class="api-banner">
    <div><span class="pulse"></span> iDataGH AUTO-DISPATCH ACTIVE - SECURE SYNC</div>
    <div id="apiClock">00:00:00</div>
</div>

<header>
    <h1><i class="fas fa-robot"></i> API ORDER CONTROL</h1>
    <a href="admin_dashboard.html" class="back-btn"><i class="fas fa-arrow-left"></i> Dashboard</a>
</header>

<div class="container">
    <div class="controls-card">
        <div class="control-group"><label>Search Orders</label><input type="text" id="searchInput" placeholder="Recipient or Email..."></div>
        <div class="control-group">
            <label>Filter Status</label>
            <select id="statusFilter">
                <option value="all">All Statuses</option>
                <option value="Pending">Pending</option>
                <option value="Completed">Completed</option>
                <option value="Flagged">Flagged</option>
            </select>
        </div>
    </div>

    <div class="table-card">
        <div style="overflow-x: auto;">
            <table id="ordersTable">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Network/Plan</th>
                        <th>Amount</th>
                        <th>Recipient</th>
                        <th>User Email</th>
                        <th>Status</th>
                        <th style="text-align:right">Actions</th>
                    </tr>
                </thead>
                <tbody id="orderTbody">
                    <tr><td colspan="7" style="text-align:center; padding:50px;">Connecting to Secure Nodes...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getDatabase, ref, onValue, update, get, push } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBmiippVd5uyAb51U9upNNpSvJk0lXSNg4",
    authDomain: "gigantic-data.firebaseapp.com",
    databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
    projectId: "gigantic-data"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// API CREDENTIALS
const API_KEY = "Tera_live_95abf76d96984f4612153a4869e43d3e";
const API_URL = "https://idatagh.com/wp-json/custom/v1/place-order";

let allOrders = [];
let userEmailMap = {};

onAuthStateChanged(auth, user => {
    if(user && user.email === "alenacloft0@gmail.com"){
        startEngine();
    } else { window.location.href = "login.html"; }
});

async function startEngine() {
    onValue(ref(db, "users"), snap => {
        const data = snap.val() || {};
        Object.entries(data).forEach(([uid, info]) => { userEmailMap[uid] = info.email; });
    });

    onValue(ref(db, "user_orders"), snapshot => {
        const data = snapshot.val() || {};
        allOrders = [];
        Object.entries(data).forEach(([uid, orders]) => {
            Object.entries(orders).forEach(([id, order]) => {
                const orderObj = { id, uid, ...order, email: userEmailMap[uid] || order.email };
                allOrders.push(orderObj);
                
                // AUTOMATED FULFILLMENT TRIGGER
                if (order.status === "Pending") {
                    securityAudit(orderObj);
                }
            });
        });
        renderTable();
    });
}

// SECURITY & ANTI-HACKER LOGIC
async function securityAudit(order) {
    try {
        const historySnap = await get(ref(db, `user_orders/${order.uid}`));
        const history = Object.values(historySnap.val() || {});
        const recent = history.filter(o => (Date.now() - o.timestamp) < 60000);

        if (recent.length > 2) {
            handleFlag(order, "Velocity Check: Too many orders");
            return;
        }

        const userSnap = await get(ref(db, `users/${order.uid}`));
        const userData = userSnap.val();
        // Check for balance bypass/negative wallet trick
        const currentWallet = parseFloat(userData.wallet || userData.balance || 0);
        if (currentWallet < 0) {
            handleFlag(order, "Integrity Check: Balance Bypass");
            return;
        }

        fulfillOrder(order);
    } catch (e) { console.error("Security Audit Fail", e); }
}

async function handleFlag(order, reason) {
    const updates = {};
    updates[`user_orders/${order.uid}/${order.id}/status`] = "Flagged";
    updates[`orders/${order.id}/status`] = "Flagged";
    await update(ref(db), updates);
    push(ref(db, "admin_settings/financial_guard"), { email: order.email, uid: order.uid, reason: reason, date: Date.now() });
}

// FULFILLMENT ENGINE
async function fulfillOrder(order) {
    // 1. Mark as Processing to prevent loops
    const processUpdate = {};
    processUpdate[`user_orders/${order.uid}/${order.id}/status`] = "Processing";
    await update(ref(db), processUpdate);

    // 2. Format Network for Provider
    let net = order.network.toLowerCase();
    if (net.includes("mtn")) net = "mtn-gh";
    else if (net.includes("at") || net.includes("airtel")) net = "at-gh";
    else if (net.includes("telecel") || net.includes("vod")) net = "telecel-gh";

    // 3. Extract numeric Plan ID (API expects an ID, not just text)
    // Extracting digits from "5GB" -> 5
    const planID = parseInt(order.plan.replace(/[^0-9]/g, '')) || 1;

    // 4. API PAYLOAD
    const payload = {
        "network": net,
        "beneficiary": order.recipient.trim(),
        "pa_data-bundle-packages": planID
    };

    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${API_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        // 5. Handle Provider Response
        if (result.status === "success" || response.ok) {
            updateStatus(order, "Completed");
        } else {
            updateStatus(order, "Failed: " + (result.message || "Provider Error"));
        }
    } catch (err) {
        updateStatus(order, "Network Error");
    }
}

function updateStatus(order, status) {
    const updates = {};
    updates[`user_orders/${order.uid}/${order.id}/status`] = status;
    updates[`orders/${order.id}/status`] = status;
    update(ref(db), updates);
}

function renderTable() {
    const tbody = document.getElementById("orderTbody");
    const search = document.getElementById("searchInput").value.toLowerCase();
    const filter = document.getElementById("statusFilter").value;
    
    let entries = allOrders.sort((a,b) => b.timestamp - a.timestamp);
    if(filter !== 'all') entries = entries.filter(o => o.status === filter);
    if(search) entries = entries.filter(o => o.recipient.includes(search) || o.email.toLowerCase().includes(search));

    tbody.innerHTML = "";
    entries.forEach(o => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td><b>#${o.id.slice(-6)}</b><br><small>${new Date(o.timestamp).toLocaleString()}</small></td>
            <td><b>${o.network.toUpperCase()}</b><br><span>${o.plan}</span></td>
            <td style="font-weight:700;">₵${parseFloat(o.amount).toFixed(2)}</td>
            <td>${o.recipient}</td>
            <td style="font-size:11px; font-weight:700; color:var(--primary-blue);">${o.email}</td>
            <td><span class="status-badge status-${o.status}">${o.status}</span></td>
            <td style="text-align:right">
                <button class="delete-btn" onclick="delRec('${o.id}','${o.uid}')"><i class="fas fa-trash"></i></button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

window.delRec = (id, uid) => {
    if(confirm("Delete record permanently?")){
        const up = {};
        up[`user_orders/${uid}/${id}`] = null;
        up[`orders/${id}`] = null;
        update(ref(db), up);
    }
}

setInterval(() => { document.getElementById('apiClock').innerText = new Date().toLocaleTimeString(); }, 1000);
document.getElementById('searchInput').addEventListener('input', renderTable);
document.getElementById('statusFilter').addEventListener('change', renderTable);
</script>
</body>
</html>
