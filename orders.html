<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin — Command Center</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --deep-blue: #003366; --primary-blue: #0052cc;
            --light-bg: #f4f7fe; --white: #ffffff; --text-main: #1e293b;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: -apple-system, sans-serif; }
        body { background: var(--light-bg); color: var(--text-main); min-height: 100vh; }
        header { background: var(--deep-blue); color: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .back-btn { background: rgba(255,255,255,0.15); color: white; padding: 8px 16px; border-radius: 8px; text-decoration: none; font-size: 0.8rem; font-weight: 700; }
        .container { padding: 30px 5%; }
        .api-banner { background: #0f172a; color: #4ade80; padding: 10px 5%; font-family: monospace; font-size: 11px; display: flex; justify-content: space-between; align-items: center; }
        .pulse { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; display: inline-block; margin-right: 5px; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        
        .table-card { background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: #f8fafc; color: #64748b; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; padding: 15px; text-align: left; }
        td { padding: 15px; font-size: 0.85rem; border-bottom: 1px solid #f1f5f9; }
        
        .status-badge { font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 20px; text-transform: uppercase; border: 1px solid transparent; }
        .status-Pending { background: #fffbeb; color: #b45309; border-color: #fde68a; }
        .status-Completed { background: #ecfdf5; color: #047857; border-color: #a7f3d0; }
        .status-Flagged { background: #fef2f2; color: #b91c1c; border-color: #fecaca; }
        .status-Processing { background: #eff6ff; color: #1e40af; border-color: #bfdbfe; }
        
        .status-select { padding: 6px; border-radius: 8px; font-size: 0.75rem; border: 1px solid #cbd5e1; outline: none; cursor: pointer; background: #f8fafc; color: var(--deep-blue); font-weight: 600; }
        .log-card { background: #1e293b; color: #94a3b8; padding: 20px; border-radius: 15px; font-family: monospace; font-size: 12px; height: 200px; overflow-y: auto; }
        .log-entry { border-bottom: 1px solid #334155; padding: 5px 0; }
        .log-err { color: #ef4444; }
    </style>

    <script defer src="/__/firebase/10.7.1/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/10.7.1/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/10.7.1/firebase-database-compat.js"></script>
    <script defer src="/__/firebase/init.js"></script>
</head>
<body>

<div class="api-banner">
    <div><span class="pulse"></span> MASTER COMMAND CENTER ACTIVE — SYSTEM SECURED</div>
    <div id="apiClock">00:00:00</div>
</div>

<header>
    <h1><i class="fas fa-user-shield"></i> MASTER CONTROL</h1>
    <a href="admin_dashboard.html" class="back-btn"><i class="fas fa-arrow-left"></i> Dashboard</a>
</header>

<div class="container">
    <div class="table-card">
        <div style="overflow-x: auto;">
            <table id="ordersTable">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Network/Plan</th>
                        <th>Amount</th>
                        <th>Recipient</th>
                        <th>User Email</th>
                        <th>Status</th>
                        <th style="text-align:right">Update / Delete</th>
                    </tr>
                </thead>
                <tbody id="orderTbody">
                    <tr><td colspan="7" style="text-align:center; padding:50px;">Authenticating Secure Connection...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="log-card" id="logConsole">
        <div id="logEntries"></div>
    </div>
</div>

<script>
// Wait for Firebase to load from the /__/ auto-inject scripts
window.onload = function() {
    if (typeof firebase !== 'undefined') {
        const auth = firebase.auth();
        const db = firebase.database();
        
        const API_URL = "https://idatagh.com/wp-json/custom/v1/place-order";
        const PROXY = "https://corsproxy.io/?";

        let allOrders = [];
        let userEmailMap = {};

        auth.onAuthStateChanged(user => {
            // ONLY EMMANUEL ACCESS
            if(user && user.email === "alenacloft0@gmail.com"){
                writeLog("Secure Session Initiated.");
                startEngine(db);
            } else { window.location.href = "login.html"; }
        });

        function writeLog(msg, isError = false) {
            const logDiv = document.getElementById("logEntries");
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML = `<div class="log-entry ${isError ? 'log-err' : ''}">[${time}] ${msg}</div>` + logDiv.innerHTML;
        }

        async function startEngine(db) {
            db.ref("users").on("value", snap => {
                const data = snap.val() || {};
                Object.entries(data).forEach(([uid, info]) => { userEmailMap[uid] = info.email; });
            });

            db.ref("user_orders").on("value", snapshot => {
                const data = snapshot.val() || {};
                allOrders = [];
                Object.entries(data).forEach(([uid, orders]) => {
                    Object.entries(orders).forEach(([id, order]) => {
                        const orderObj = { id, uid, ...order, email: userEmailMap[uid] || order.email };
                        allOrders.push(orderObj);
                        
                        if (order.status === "Pending") {
                            securityAudit(db, orderObj);
                        }
                    });
                });
                renderTable(db);
            });
        }

        async function securityAudit(db, order) {
            try {
                const userSnap = await db.ref(`users/${order.uid}`).get();
                const userData = userSnap.val();
                const balance = parseFloat(userData.wallet || userData.balance || 0);
                
                if (balance < 0) {
                    handleFlag(db, order, "ALERT: Negative Balance");
                    return;
                }
                fulfillOrder(db, order);
            } catch (e) { writeLog("Audit Fail", true); }
        }

        async function fulfillOrder(db, order) {
            updateStatusInDb(db, order.uid, order.id, "Processing");
            writeLog(`Fetching API Key...`);

            // FETCH KEY PRIVATELY FROM DATABASE (NOT ON GITHUB)
            const keySnap = await db.ref('admin_settings/idata_key').get();
            const SECURE_API_KEY = keySnap.val();

            if (!SECURE_API_KEY) {
                writeLog("ERROR: API Key not found in admin_settings!", true);
                return;
            }

            let net = order.network.toLowerCase();
            if (net.includes("at")) net = "at";
            else if (net.includes("telecel")) net = "telecel";
            else net = "mtn";

            const planID = parseInt(order.plan.replace(/[^0-9]/g, '')) || 5;

            const payload = {
                "network": net,
                "beneficiary": order.recipient.toString().trim(),
                "pa_data-bundle-packages": planID
            };

            try {
                const response = await fetch(PROXY + encodeURIComponent(API_URL), {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${SECURE_API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if (result.status === "success" || response.ok) {
                    writeLog(`SUCCESS: #${order.id.slice(-6)}`);
                    updateStatusInDb(db, order.uid, order.id, "Completed");
                } else {
                    writeLog(`REJECTED: ${result.message}`, true);
                    updateStatusInDb(db, order.uid, order.id, "Failed");
                }
            } catch (err) {
                writeLog(`CONNECTION ERROR`, true);
                updateStatusInDb(db, order.uid, order.id, "Pending");
            }
        }

        function updateStatusInDb(db, uid, orderId, status) {
            const updates = {};
            updates[`user_orders/${uid}/${orderId}/status`] = status;
            updates[`orders/${orderId}/status`] = status;
            db.ref().update(updates);
        }

        window.manualStatusUpdate = function(uid, orderId, newStatus) {
            if(!newStatus) return;
            updateStatusInDb(db, uid, orderId, newStatus);
        };

        function renderTable(db) {
            const tbody = document.getElementById("orderTbody");
            tbody.innerHTML = "";
            allOrders.sort((a,b) => b.timestamp - a.timestamp).forEach(o => {
                const tr = document.createElement("tr");
                const sClass = (o.status || "Pending").replace(" ", "-");
                tr.innerHTML = `
                    <td><b>#${o.id.slice(-6)}</b></td>
                    <td><b>${(o.network || "").toUpperCase()}</b><br>${o.plan}</td>
                    <td>₵${parseFloat(o.amount || 0).toFixed(2)}</td>
                    <td>${o.recipient}</td>
                    <td>${o.email}</td>
                    <td><span class="status-badge status-${sClass}">${o.status}</span></td>
                    <td style="text-align:right">
                        <select class="status-select" onchange="manualStatusUpdate('${o.uid}', '${o.id}', this.value)">
                            <option value="" selected disabled>Update</option>
                            <option value="Completed">Completed</option>
                            <option value="Canceled">Canceled</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }
};
setInterval(() => { document.getElementById('apiClock').innerText = new Date().toLocaleTimeString(); }, 1000);
</script>
</body>
</html>
