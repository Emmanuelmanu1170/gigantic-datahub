<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gigantic Admin â€” Real-Time Fulfillment</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --deep-blue: #003366; --primary-blue: #0052cc;
            --light-bg: #f4f7fe; --white: #ffffff; --text-main: #1e293b;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: -apple-system, sans-serif; }
        body { background: var(--light-bg); color: var(--text-main); min-height: 100vh; }
        header { background: var(--deep-blue); color: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        
        .container { padding: 30px 5%; }
        .api-banner { background: #0f172a; color: #4ade80; padding: 10px 5%; font-family: monospace; font-size: 11px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #1e293b; }
        .pulse { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; display: inline-block; margin-right: 5px; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        
        .table-card { background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: #f8fafc; color: #64748b; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; padding: 15px; text-align: left; }
        td { padding: 15px; font-size: 0.85rem; border-bottom: 1px solid #f1f5f9; }
        
        .status-badge { font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 20px; text-transform: uppercase; display: inline-block; margin-bottom: 5px; }
        .status-Pending { background: #fffbeb; color: #b45309; }
        .status-Completed, .status-Successful { background: #ecfdf5; color: #047857; }
        .status-Processing { background: #eff6ff; color: #1e40af; }
        .status-Failed { background: #fdf2f2; color: #ef4444; }
        .status-Refunded { background: #f1f5f9; color: #475569; }
        
        .status-select { padding: 5px; font-size: 11px; border-radius: 5px; border: 1px solid #e2e8f0; background: #f8fafc; outline: none; cursor: pointer; display: block; width: 120px; }

        .log-card { background: #1e293b; color: #94a3b8; padding: 20px; border-radius: 15px; font-family: monospace; font-size: 12px; height: 180px; overflow-y: auto; border: 1px solid #334155; }
        .log-entry { border-bottom: 1px solid #334155; padding: 5px 0; }
        .log-success { color: #4ade80; }
        .log-err { color: #ef4444; }
        
        .admin-info { font-size: 10px; color: #94a3b8; font-weight: bold; }
        .user-info-cell { display: flex; flex-direction: column; gap: 2px; }
        .user-email { font-size: 10px; color: #64748b; }
        .action-btns { display: flex; align-items: center; justify-content: flex-end; gap: 15px; }
    </style>
</head>
<body>

<div class="api-banner">
    <div><span class="pulse"></span> GIGANTIC AUTO-FULFILLMENT ENGINE: ONLINE</div>
    <div class="admin-info" id="adminDisplay">Handshaking...</div>
    <div id="apiClock">00:00:00</div>
</div>

<header>
    <h1><i class="fas fa-microchip"></i> COMMAND CENTER</h1>
    <a href="admin_dashboard.html" style="color:white; text-decoration:none; font-weight:bold; font-size:13px;"><i class="fas fa-home"></i> Dashboard</a>
</header>

<div class="container">
    <div class="table-card">
        <div style="overflow-x: auto;">
            <table id="ordersTable">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Network</th>
                        <th>Recipient</th>
                        <th>Plan</th>
                        <th>Customer Details</th>
                        <th>Status Control</th>
                        <th style="text-align:right">Action</th>
                    </tr>
                </thead>
                <tbody id="orderTbody">
                    <tr><td colspan="7" style="text-align:center; padding:50px;">Syncing with Data nodes...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="log-card" id="logConsole">
        <div id="logEntries"></div>
    </div>
</div>

<script>
// --- CORE CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyBmu4xukuT0Z7oD_vA9QroeO-1ZuaK8JgA",
    authDomain: "gigantic-data.firebaseapp.com",
    databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
    projectId: "gigantic-data"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let userCache = {};

auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
    .then(() => {
        return auth.onAuthStateChanged(user => {
            if(user && user.email === "alenacloft0@gmail.com"){
                document.getElementById('adminDisplay').innerText = `ADMIN: ${user.email}`;
                writeLog(`Security cleared. Admin session active.`, true);
                initAutomation();
            } else { 
                writeLog("Unauthorized Access Attempt.", false, true);
                setTimeout(() => { window.location.href = "login.html"; }, 2000);
            }
        });
    });

function writeLog(msg, isSuccess = false, isError = false) {
    const logDiv = document.getElementById("logEntries");
    const time = new Date().toLocaleTimeString();
    const style = isSuccess ? 'log-success' : (isError ? 'log-err' : '');
    logDiv.innerHTML = `<div class="log-entry ${style}">[${time}] ${msg}</div>` + logDiv.innerHTML;
}

function initAutomation() {
    db.ref("users").on("value", snap => { 
        userCache = snap.val() || {}; 
        writeLog("User directory mapped.");
    });

    // Listen to Master Orders node primarily for history and status
    db.ref("orders").limitToLast(50).on("value", snapshot => {
        const ordersData = snapshot.val() || {};
        
        // Also check pending orders to ensure real-time visibility
        db.ref("pending_orders").once("value", pendingSnap => {
            const pendingData = pendingSnap.val() || {};
            let combinedData = [];

            // Add Master Orders
            Object.entries(ordersData).forEach(([oid, data]) => {
                combinedData.push({ ...data, orderId: oid });
            });

            // Add Pending if not in Master
            Object.entries(pendingData).forEach(([oid, data]) => {
                if(!ordersData[oid]) {
                    combinedData.push({ ...data, orderId: oid });
                }
            });

            renderTable(combinedData);
        });
    });
}

function renderTable(data) {
    const tbody = document.getElementById("orderTbody");
    tbody.innerHTML = "";
    
    data.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0)).forEach(o => {
        const timeStr = o.timestamp ? new Date(o.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A';
        const u = userCache[o.uid] || {};
        const userName = u.fullName || u.email || "Unknown User";
        const userEmail = u.email || "No Email";

        tbody.innerHTML += `
            <tr>
                <td><small>${timeStr}</small></td>
                <td><b>${o.network ? o.network.toUpperCase() : 'N/A'}</b></td>
                <td><b>${o.recipient || 'N/A'}</b></td>
                <td>${o.plan || 'N/A'}</td>
                <td>
                    <div class="user-info-cell">
                        <span style="font-weight:700">${userName}</span>
                        <span class="user-email">${userEmail}</span>
                    </div>
                </td>
                <td>
                    <span class="status-badge status-${o.status}">${o.status}</span>
                    <select class="status-select" onchange="changeStatus('${o.orderId}', '${o.uid}', this.value)">
                        <option value="" disabled selected>Change Status</option>
                        <option value="Pending" ${o.status === 'Pending' ? 'selected' : ''}>Pending</option>
                        <option value="Processing" ${o.status === 'Processing' ? 'selected' : ''}>Processing</option>
                        <option value="Successful" ${o.status === 'Successful' ? 'selected' : ''}>Successful</option>
                        <option value="Failed" ${o.status === 'Failed' ? 'selected' : ''}>Failed</option>
                        <option value="Refunded" ${o.status === 'Refunded' ? 'selected' : ''}>Refunded</option>
                    </select>
                </td>
                <td style="text-align:right">
                    <div class="action-btns">
                        <button onclick="deleteRecord('${o.orderId}', '${o.uid}')" style="background:none; border:none; color:#cbd5e1; cursor:pointer;"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            </tr>
        `;
    });
}

window.changeStatus = (oid, uid, newStatus) => {
    if(!uid || uid === "undefined") {
        writeLog(`Error: Missing UID for Order #${oid}`, false, true);
        return;
    }
    
    // IMPORTANT: Atomic update across all relevant nodes
    const updates = {};
    updates[`orders/${oid}/status`] = newStatus;
    updates[`user_orders/${uid}/${oid}/status`] = newStatus;
    
    // If the status is finalized, remove it from the trigger node
    if(newStatus === "Successful" || newStatus === "Failed" || newStatus === "Refunded") {
        updates[`pending_orders/${oid}`] = null;
    } else {
        // Keep it in pending_orders if still processing or pending
        db.ref(`pending_orders/${oid}`).once('value', snap => {
            if(snap.exists()) {
                db.ref(`pending_orders/${oid}`).update({ status: newStatus });
            }
        });
    }

    db.ref().update(updates).then(() => {
        writeLog(`STATUS CHANGED: Order #${oid.slice(-6)} is now ${newStatus}`, true);
    }).catch(err => {
        writeLog(`Status update failed: ${err.message}`, false, true);
    });
};

window.deleteRecord = (oid, uid) => {
    if(confirm("Permanently delete this order record?")) {
        const updates = {};
        updates[`orders/${oid}`] = null;
        updates[`user_orders/${uid}/${oid}`] = null;
        updates[`pending_orders/${oid}`] = null;
        db.ref().update(updates).then(() => writeLog(`Record #${oid.slice(-6)} deleted.`));
    }
};

setInterval(() => { document.getElementById('apiClock').innerText = new Date().toLocaleTimeString(); }, 1000);
</script>
</body>
</html>
