<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gigantic Admin — Real-Time Fulfillment</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --deep-blue: #003366; --primary-blue: #0052cc;
            --light-bg: #f4f7fe; --white: #ffffff; --text-main: #1e293b;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: -apple-system, sans-serif; }
        body { background: var(--light-bg); color: var(--text-main); min-height: 100vh; }
        header { background: var(--deep-blue); color: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        
        .container { padding: 30px 5%; }
        .api-banner { background: #0f172a; color: #4ade80; padding: 10px 5%; font-family: monospace; font-size: 11px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #1e293b; }
        .pulse { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; display: inline-block; margin-right: 5px; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        
        .table-card { background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: #f8fafc; color: #64748b; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; padding: 15px; text-align: left; }
        td { padding: 15px; font-size: 0.85rem; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        
        .status-badge { font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 20px; text-transform: uppercase; display: inline-block; margin-bottom: 5px; }
        .status-Pending { background: #fffbeb; color: #b45309; }
        .status-Successful { background: #ecfdf5; color: #047857; }
        .status-Processing { background: #eff6ff; color: #1e40af; animation: pulse 1.5s infinite; }
        .status-Failed { background: #fdf2f2; color: #ef4444; }
        .status-Refunded { background: #f1f5f9; color: #475569; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .status-select { padding: 6px; font-size: 11px; border-radius: 8px; border: 1px solid #e2e8f0; background: #f8fafc; outline: none; cursor: pointer; display: block; width: 130px; font-weight: 600; }

        .log-card { background: #1e293b; color: #94a3b8; padding: 20px; border-radius: 15px; font-family: monospace; font-size: 12px; height: 180px; overflow-y: auto; border: 1px solid #334155; }
        .log-entry { border-bottom: 1px solid #334155; padding: 5px 0; }
        .log-success { color: #4ade80; }
        .log-err { color: #ef4444; }
        
        .data-label { font-size: 10px; color: #94a3b8; display: block; text-transform: uppercase; font-weight: 700; margin-bottom: 2px; }
        .data-value { font-weight: 700; color: var(--text-main); }
        .price-tag { color: var(--primary-blue); font-weight: 900; }

        .purge-btn { background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 8px; font-size: 11px; font-weight: 900; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        .purge-btn:hover { background: #b91c1c; transform: scale(1.05); }
    </style>
</head>
<body>

<div class="api-banner">
    <div><span class="pulse"></span> GIGANTIC MASTER ENGINE: DATABASE SYNC ACTIVE</div>
    <div class="admin-info" id="adminDisplay">Connecting...</div>
    <div id="apiClock">00:00:00</div>
</div>

<header>
    <h1><i class="fas fa-terminal"></i> COMMAND CENTER</h1>
    <div style="display:flex; gap:15px; align-items:center;">
        <button class="purge-btn" onclick="purgeAllOrders()">
            <i class="fas fa-radiation"></i> PURGE ALL ORDERS
        </button>
        <a href="admin_dashboard.html" style="color:white; text-decoration:none; font-weight:bold; font-size:13px;">
            <i class="fas fa-home"></i> Home
        </a>
    </div>
</header>

<div class="container">
    <div class="table-card">
        <div style="overflow-x: auto;">
            <table id="ordersTable">
                <thead>
                    <tr>
                        <th>Order Identity</th>
                        <th>Network & Plan</th>
                        <th>Recipient Details</th>
                        <th>Price (GHS)</th>
                        <th>Customer Info</th>
                        <th>Status Control</th>
                        <th style="text-align:right">Purge</th>
                    </tr>
                </thead>
                <tbody id="orderTbody">
                    <tr><td colspan="7" style="text-align:center; padding:50px;">Initializing secure handshake...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="log-card" id="logConsole">
        <div id="logEntries"></div>
    </div>
</div>

<script>
// --- CORE CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyBmu4xukuT0Z7oD_vA9QroeO-1ZuaK8JgA",
    authDomain: "gigantic-data.firebaseapp.com",
    databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
    projectId: "gigantic-data"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let userCache = {};
let currentOrdersList = [];

auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {
    return auth.onAuthStateChanged(user => {
        if(user && user.email === "alenacloft0@gmail.com"){
            document.getElementById('adminDisplay').innerText = `MASTER ADMIN: ${user.email}`;
            writeLog(`System Ready. Admin authenticated.`, true);
            initAutomation();
        } else { 
            window.location.href = "login.html";
        }
    });
});

function writeLog(msg, isSuccess = false, isError = false) {
    const logDiv = document.getElementById("logEntries");
    const time = new Date().toLocaleTimeString();
    const style = isSuccess ? 'log-success' : (isError ? 'log-err' : '');
    logDiv.innerHTML = `<div class="log-entry ${style}">[${time}] ${msg}</div>` + logDiv.innerHTML;
}

function initAutomation() {
    db.ref("users").on("value", snap => { userCache = snap.val() || {}; });

    db.ref("orders").orderByChild("timestamp").limitToLast(100).on("value", snapshot => {
        const ordersData = snapshot.val() || {};
        
        db.ref("pending_orders").once("value", pendingSnap => {
            const pendingData = pendingSnap.val() || {};
            let combined = [];

            Object.entries(ordersData).forEach(([oid, val]) => {
                combined.push({ ...val, orderId: oid });
            });

            Object.entries(pendingData).forEach(([oid, val]) => {
                if(!ordersData[oid]) combined.push({ ...val, orderId: oid });
            });

            // Sort descending by time
            currentOrdersList = combined.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
            renderTable(currentOrdersList);
        });
    });
}

function renderTable(data) {
    const tbody = document.getElementById("orderTbody");
    tbody.innerHTML = "";
    
    data.forEach(o => {
        const ts = o.timestamp ? new Date(o.timestamp).toLocaleString() : 'N/A';
        const user = userCache[o.uid] || {};
        const amount = parseFloat(o.amount || 0).toFixed(2);

        tbody.innerHTML += `
            <tr id="row-${o.orderId}">
                <td>
                    <span class="data-label">ORDER ID / TIME</span>
                    <span class="data-value" style="font-family:monospace; color:#6366f1">#${o.orderId.slice(-8)}</span>
                    <div style="font-size:9px; color:#94a3b8; margin-top:4px">${ts}</div>
                </td>
                <td>
                    <span class="data-label">NETWORK / BUNDLE</span>
                    <span class="data-value">${(o.network || 'N/A').toUpperCase()}</span>
                    <div style="font-size:11px; font-weight:bold; color:#0052cc">${o.plan || 'N/A'}</div>
                </td>
                <td>
                    <span class="data-label">RECIPIENT NUMBER</span>
                    <span class="data-value" style="letter-spacing:1px">${o.recipient || 'N/A'}</span>
                </td>
                <td class="price-tag">₵${amount}</td>
                <td>
                    <span class="data-label">USER: ${user.fullName || 'Unknown'}</span>
                    <span class="user-email" style="font-size:10px">${user.email || 'N/A'}</span>
                    <div style="font-size:8px; font-family:monospace; margin-top:3px">UID: ${o.uid}</div>
                </td>
                <td>
                    <span class="status-badge status-${o.status}">${o.status}</span>
                    <select class="status-select" onchange="changeStatus('${o.orderId}', '${o.uid}', this.value)">
                        <option value="" disabled selected>SET STATUS</option>
                        <option value="Pending">Pending</option>
                        <option value="Processing">Processing</option>
                        <option value="Successful">Successful</option>
                        <option value="Failed">Failed</option>
                        <option value="Refunded">Refunded</option>
                    </select>
                </td>
                <td style="text-align:right">
                    <button onclick="deleteRecord('${o.orderId}', '${o.uid}')" style="background:none; border:none; color:#cbd5e1; cursor:pointer; font-size:14px;">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            </tr>
        `;
    });
}

window.changeStatus = async (oid, uid, newStatus) => {
    if(!uid || uid === "undefined") {
        writeLog(`Crit Error: UID missing for order #${oid}`, false, true);
        return;
    }
    
    let updates = {};
    
    // CASCADE LOGIC: If set to Successful, apply to all orders BELOW it in the sorted list
    if (newStatus === "Successful") {
        const targetIndex = currentOrdersList.findIndex(item => item.orderId === oid);
        if (targetIndex !== -1) {
            const affectedOrders = currentOrdersList.slice(targetIndex);
            
            affectedOrders.forEach(order => {
                updates[`orders/${order.orderId}/status`] = "Successful";
                updates[`user_orders/${order.uid}/${order.orderId}/status`] = "Successful";
                updates[`pending_orders/${order.orderId}`] = null;
            });
            writeLog(`Cascade Sync: #${oid.slice(-6)} and ${affectedOrders.length - 1} following orders set to Successful`, true);
        }
    } else {
        // Normal Single Update
        updates[`orders/${oid}/status`] = newStatus;
        updates[`user_orders/${uid}/${oid}/status`] = newStatus;
        if(["Failed", "Refunded"].includes(newStatus)) {
            updates[`pending_orders/${oid}`] = null;
        } else {
            updates[`pending_orders/${oid}/status`] = newStatus;
        }
        writeLog(`Update Verified: #${oid.slice(-6)} set to ${newStatus}`, true);
    }

    db.ref().update(updates).catch(err => {
        writeLog(`Database Error: ${err.message}`, false, true);
    });
};

window.deleteRecord = (oid, uid) => {
    if(confirm(`Purge order #${oid} from all nodes? This cannot be undone.`)) {
        const updates = {};
        updates[`orders/${oid}`] = null;
        updates[`user_orders/${uid}/${oid}`] = null;
        updates[`pending_orders/${oid}`] = null;
        db.ref().update(updates).then(() => writeLog(`Purge Complete: #${oid}`, true));
    }
};

window.purgeAllOrders = () => {
    const pass = prompt("DANGER ZONE: Type 'DELETE ALL' to clear order history.");
    if(pass === "DELETE ALL") {
        writeLog("Initiating Global Purge...", false, true);
        const updates = {
            "orders": null,
            "pending_orders": null,
            "user_orders": null
        };
        db.ref().update(updates)
          .then(() => writeLog("GLOBAL DATABASE PURGE SUCCESSFUL", true))
          .catch(err => writeLog(`Purge Failed: ${err.message}`, false, true));
    }
};

setInterval(() => { document.getElementById('apiClock').innerText = new Date().toLocaleTimeString(); }, 1000);
</script>
</body>
</html>
