<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Top-up | Gigantic Data Hub</title>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #4f46e5; --dark: #0f172a; --bg: #f8fafc; }
        body { background: var(--bg); font-family: 'Inter', sans-serif; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; width: 100%; max-width: 400px; border-radius: 28px; padding: 30px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .input-group { margin: 20px 0; }
        input { width: 100%; padding: 15px; border: 2px solid #f1f5f9; border-radius: 12px; font-size: 1.1rem; outline: none; box-sizing: border-box; }
        .pay-btn { width: 100%; background: var(--primary); color: white; border: none; padding: 18px; border-radius: 15px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .pay-btn:active { transform: scale(0.98); }
    </style>
</head>
<body>

<div class="card">
    <h2 style="text-align:center"><i class="fas fa-wallet"></i> Fund Wallet</h2>
    <div class="input-group">
        <label style="font-size: 0.8rem; font-weight: 700; color: #64748b;">AMOUNT (GHS)</label>
        <input type="number" id="amount" placeholder="0.00">
    </div>

    <button class="pay-btn" id="mainPayBtn" onclick="payWithPaystack()">SECURE TOP-UP</button>

    <a href="https://wa.me/233549055308" style="display:block; text-align:center; margin-top:20px; color:#25D366; text-decoration:none; font-weight:700;">
        <i class="fab fa-whatsapp"></i> Need Help? Chat Admin
    </a>
</div>

<script type="module">
    // Make sure your Firebase initialization is here
    import { auth } from './firebase-config.js'; 

    window.payWithPaystack = function() {
        const amt = document.getElementById('amount').value;
        const btn = document.getElementById('mainPayBtn');

        // Check if user is logged in
        const user = auth.currentUser;
        if (!user) {
            alert("Error: You must be logged in to top up.");
            return;
        }

        if (!amt || amt < 1) {
            alert("Please enter a valid amount.");
            return;
        }

        // SAFETY CHECK: Is Paystack loaded?
        if (typeof PaystackPop === 'undefined') {
            alert("Gateway is still loading. Please refresh or check your internet.");
            return;
        }

        btn.innerText = "Opening Gateway...";
        btn.disabled = true;

        const handler = PaystackPop.setup({
            key: 'pk_live_faecdb3166144fadebd8269829343698dd43de63',
            email: user.email,
            amount: Math.round(amt * 100), // Converts GHS to Pesewas
            currency: 'GHS',
            metadata: { 
                uid: user.uid, 
                real_amount: amt 
            },
            callback: function(response) {
                // This part just confirms the browser saw the success
                // The actual money is added by your Cloud Function Webhook
                alert("Payment complete! Reference: " + response.reference);
                window.location.href = "dashboard.html";
            },
            onClose: function() {
                btn.innerText = "SECURE TOP-UP";
                btn.disabled = false;
                alert("Window closed.");
            }
        });

        handler.openIframe();
    };
</script>
</body>
</html>
