<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top-up Wallet — Giganticdata</title>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --deep-blue: #0a0e27;
            --primary-blue: #0052cc;
            --orange-gradient: linear-gradient(135deg, #f06529 0%, #c02425 100%);
            --light-bg: #f4f7fe;
            --success: #10b981;
        }

        body {
            margin: 0; font-family: sans-serif; background: var(--light-bg); color: #1e293b;
        }

        .header {
            background: var(--deep-blue); color: white; padding: 20px;
            display: flex; align-items: center; gap: 15px;
        }

        .container { padding: 20px; max-width: 500px; margin: 0 auto; }

        .card {
            background: white; padding: 25px; border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 20px;
        }

        .wallet-mini {
            background: var(--deep-blue); color: white; padding: 15px;
            border-radius: 15px; margin-bottom: 25px; display: flex;
            justify-content: space-between; align-items: center;
        }

        label { display: block; font-weight: 700; font-size: 13px; margin-bottom: 8px; color: var(--deep-blue); }

        .input-group { position: relative; margin-bottom: 20px; }
        .input-group span { position: absolute; left: 15px; top: 12px; font-weight: 700; color: #64748b; }
        input {
            width: 100%; padding: 12px 12px 12px 50px; border: 2px solid #e2e8f0;
            border-radius: 12px; font-size: 16px; box-sizing: border-box;
            outline: none;
        }
        input:focus { border-color: var(--primary-blue); }

        .fee-box {
            background: #f8fafc; border-radius: 12px; padding: 15px;
            font-size: 14px; line-height: 2; border: 1px dashed #cbd5e1;
        }

        .fee-item { display: flex; justify-content: space-between; }
        .total-row { border-top: 1px solid #e2e8f0; margin-top: 10px; padding-top: 10px; font-weight: 800; color: #f06529; }

        .pay-btn {
            width: 100%; background: var(--orange-gradient); color: white;
            border: none; padding: 16px; border-radius: 12px; font-weight: 700;
            font-size: 16px; margin-top: 20px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(240, 101, 41, 0.3);
        }

        .verify-section {
            border-top: 2px solid #e2e8f0;
            margin-top: 10px;
            padding-top: 20px;
        }

        .verify-input { padding-left: 15px !important; margin-bottom: 10px; }
        
        .verify-btn {
            width: 100%; background: #1e293b; color: white;
            border: none; padding: 12px; border-radius: 10px; font-weight: 600;
            font-size: 14px; cursor: pointer;
        }

        .pay-btn:disabled, .verify-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        a { text-decoration: none; }
    </style>
</head>
<body>

    <div class="header">
        <a href="dashboard.html" style="color: white;"><i class="fas fa-arrow-left"></i></a>
        <b style="letter-spacing: 1px;">FUND WALLET</b>
    </div>

    <div class="container">
        <div class="card">
            <div class="wallet-mini">
                <span>Current Balance</span>
                <b id="currBal">GH₵ 0.00</b>
            </div>

            <label>Amount to Deposit</label>
            <div class="input-group">
                <span>GH₵</span>
                <input type="number" id="amount" placeholder="0.00" step="0.01">
            </div>

            <div class="fee-box">
                <div class="fee-item">
                    <span>Deposit Amount</span>
                    <span id="dispAmt">GH₵ 0.00</span>
                </div>
                <div class="fee-item">
                    <span>Paystack Fee (2.5%)</span>
                    <span id="dispFee">GH₵ 0.00</span>
                </div>
                <div class="total-row">
                    <span>Total to Pay</span>
                    <span id="dispTotal">GH₵ 0.00</span>
                </div>
            </div>

            <button class="pay-btn" id="payBtn" onclick="payWithPaystack()">PROCEED TO PAYMENT</button>

            <div class="verify-section">
                <label><i class="fas fa-magnifying-glass"></i> Having issues? Verify Reference</label>
                <input type="text" id="refInput" class="verify-input" placeholder="Enter Paystack Reference (e.g. T12345...)">
                <button class="verify-btn" id="verifyBtn" onclick="manualVerify()">VERIFY & CREDIT</button>
            </div>
        </div>

        <p style="font-size: 11px; color: #64748b; text-align: center;">
            <i class="fas fa-lock"></i> Secured by Paystack. Wallet updates automatically.
        </p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getDatabase, ref, onValue, push, set, runTransaction, get } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBmiippVd5uyAb51U9upNNpSvJk0lXSNg4",
            authDomain: "gigantic-data.firebaseapp.com",
            databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
            projectId: "gigantic-data",
            storageBucket: "gigantic-data.firebasestorage.app",
            messagingSenderId: "727845403550",
            appId: "1:727845403550:web:e3c3a40ce615aaaca9748f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let userEmail = "";
        let userId = "";

        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                userEmail = user.email;
                onValue(ref(db, `users/${user.uid}`), snap => {
                    const d = snap.val() || {};
                    // Check for both 'wallet' and 'balance' to match rules
                    const balance = d.wallet !== undefined ? d.wallet : (d.balance || 0);
                    document.getElementById('currBal').innerText = `GH₵ ${Number(balance).toFixed(2)}`;
                });
            } else {
                window.location.href = "login.html";
            }
        });

        const amountInput = document.getElementById('amount');
        amountInput.addEventListener('input', updateFees);

        function updateFees() {
            const amt = parseFloat(amountInput.value) || 0;
            let fee = amt * 0.025;
            const total = amt + fee;

            document.getElementById('dispAmt').innerText = `GH₵ ${amt.toFixed(2)}`;
            document.getElementById('dispFee').innerText = `GH₵ ${fee.toFixed(2)}`;
            document.getElementById('dispTotal').innerText = `GH₵ ${total.toFixed(2)}`;
        }

        window.payWithPaystack = function() {
            const amt = parseFloat(amountInput.value);
            if (!amt || amt < 1) return alert("Enter a valid amount (Min GH₵ 1)");

            let fee = amt * 0.025;
            const finalTotal = (amt + fee) * 100; 

            const handler = PaystackPop.setup({
                key: 'pk_live_faecdb3166144fadebd8269829343698dd43de63',
                email: userEmail,
                amount: Math.round(finalTotal),
                currency: "GHS",
                callback: function(response) {
                    processCredit(amt, fee, response.reference);
                },
                onClose: function() {
                    alert('Transaction cancelled.');
                }
            });
            handler.openIframe();
        }

        async function processCredit(amt, fee, reference) {
            const globalPaymentRef = ref(db, `allSuccessfulPayments/${reference}`);
            
            try {
                // Check if reference used
                const check = await get(globalPaymentRef);
                if (check.exists()) {
                    return alert("This payment has already been claimed.");
                }

                // First, claim the reference (Write to allSuccessfulPayments)
                // This will fail if someone else tries to use the same reference simultaneously
                await set(globalPaymentRef, {
                    uid: userId,
                    amount: amt,
                    timestamp: Date.now()
                });

                // Second, update wallet balance
                const walletPath = `users/${userId}/wallet`; // Or 'balance' based on your schema
                const walletRef = ref(db, walletPath);
                
                await runTransaction(walletRef, (currentValue) => {
                    return (currentValue || 0) + amt;
                });

                // Third, log to history (topupNotes)
                const historyRef = push(ref(db, `topupNotes/${userId}`));
                await set(historyRef, {
                    amount: amt,
                    fee: fee,
                    total_paid: amt + fee,
                    reference: reference,
                    status: "success",
                    timestamp: Date.now()
                });

                alert("Verification Successful! GH₵ " + amt + " added to wallet.");
                window.location.href = "dashboard.html";

            } catch (e) {
                console.error(e);
                alert("Payment verification error. If money was deducted, contact admin with ref: " + reference);
            }
        }

        window.manualVerify = async function() {
            const refID = document.getElementById('refInput').value.trim();
            if (!refID) return alert("Please enter your Paystack reference.");

            const verifyBtn = document.getElementById('verifyBtn');
            verifyBtn.disabled = true;
            verifyBtn.innerText = "Verifying...";

            try {
                const checkUsed = await get(ref(db, `allSuccessfulPayments/${refID}`));
                
                if (checkUsed.exists()) {
                    alert("This transaction was already credited.");
                } else {
                    const confirmAmt = parseFloat(prompt("Enter the exact amount you paid (excluding fees):"));
                    if (!isNaN(confirmAmt) && confirmAmt > 0) {
                        await processCredit(confirmAmt, confirmAmt * 0.025, refID);
                    } else {
                        alert("Invalid amount entered.");
                    }
                }
            } catch (err) {
                alert("Permission denied or Network error. Ensure you are logged in.");
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.innerText = "VERIFY & CREDIT";
            }
        }
    </script>
</body>
</html>
