<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secure Wallet Top-Up</title>
<script src="https://js.paystack.co/v1/inline.js"></script>

<style>
body { font-family:Poppins,sans-serif; background:#f8fafc; padding:20px; }
.card { background:white; padding:25px; border-radius:20px; box-shadow:0 10px 25px rgba(0,0,0,.1); max-width:420px; margin:auto; }
button { width:100%; padding:15px; background:#4f46e5; color:white; border:none; border-radius:12px; font-weight:bold; }
input { width:100%; padding:14px; border-radius:12px; border:1px solid #ccc; font-size:16px; }
#modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); align-items:center; justify-content:center; }
.modal-box { background:white; padding:30px; border-radius:20px; text-align:center; width:300px; }
</style>
</head>

<body>

<div class="card">
<h3>Top-Up Wallet</h3>
<input type="number" id="amount" placeholder="Enter Amount (GHS)">
<br><br>
<button id="payBtn">Pay Securely</button>
</div>

<div id="modal">
  <div class="modal-box">
    <h3>Payment Received</h3>
    <p>Wallet will be credited automatically.</p>
    <button onclick="location.href='dashboard.html'">Go Dashboard</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

// üî• Firebase Config
const firebaseConfig = {
 apiKey: "AIzaSyBmiippVd5uyAb51U9upNNpSvJk0lXSNg4",
 authDomain: "gigantic-data.firebaseapp.com",
 databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
 projectId: "gigantic-data"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let user = null;

// Ensure login
onAuthStateChanged(auth, u => {
  if(!u) location.href="login.html";
  user = u;
});

// PAYSTACK PAYMENT
document.getElementById("payBtn").onclick = () => {
  const amt = parseFloat(document.getElementById("amount").value);
  if(!amt || amt < 1) return alert("Enter valid amount");

  const fee = amt * 0.025;
  const total = Math.round((amt + fee) * 100);

  const handler = PaystackPop.setup({
    key: "pk_live_faecdb3166144fadebd8269829343698dd43de63",
    email: user.email,
    amount: total,
    currency: "GHS",

    metadata: {
      uid: user.uid,
      expected_amount: amt
    },

    callback: async (res) => {
      const refCode = res.reference;

      // Save reference for server verification
      await set(ref(db, `pending_topups/${refCode}`), {
        uid: user.uid,
        email: user.email,
        amount: amt,
        timestamp: Date.now(),
        status: "waiting"
      });

      // Show success UI
      document.getElementById("modal").style.display = "flex";

      // AUTO CHECK CREDIT AFTER 30 SECONDS
      setTimeout(() => checkCredit(refCode), 30000);
    }
  });

  handler.openIframe();
};


// üîç CHECK IF WALLET CREDITED
async function checkCredit(refCode) {
  const snap = await get(ref(db, `verified_payments/${refCode}`));

  if (!snap.exists()) {
    // REPORT TO ADMIN (AUTO FRAUD REPORT)
    await set(ref(db, `admin_reports/${refCode}`), {
      uid: user.uid,
      email: user.email,
      reference: refCode,
      reason: "Payment received but not credited",
      timestamp: Date.now()
    });

    alert("Payment detected but not credited yet. Admin notified automatically.");
  }
}
</script>
</body>
</html>