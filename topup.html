<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wallet Top-Up | Gigantic Data</title>
<script src="https://js.paystack.co/v1/inline.js"></script>

<style>
body {
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(135deg,#4f46e5,#06b6d4);
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  margin:0;
}

.card {
  background:white;
  width:420px;
  padding:30px;
  border-radius:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.2);
}

h2 {
  text-align:center;
  color:#111827;
  margin-bottom:10px;
}

p {
  text-align:center;
  color:#6b7280;
  font-size:14px;
}

input {
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid #d1d5db;
  font-size:16px;
  margin-top:15px;
}

button {
  width:100%;
  padding:15px;
  background:#4f46e5;
  color:white;
  border:none;
  border-radius:14px;
  font-size:16px;
  font-weight:bold;
  margin-top:20px;
  cursor:pointer;
}

button:hover {
  background:#4338ca;
}

#status {
  margin-top:15px;
  font-size:14px;
  text-align:center;
  color:#16a34a;
}

#modal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:flex;
  align-items:center;
  justify-content:center;
}

.modal-box {
  background:white;
  padding:25px;
  border-radius:18px;
  width:320px;
  text-align:center;
  box-shadow:0 10px 30px rgba(0,0,0,.3);
}
</style>
</head>

<body>

<div class="card">
<h2>ðŸ’° Wallet Top-Up</h2>
<p>Enter amount. Paystack fees will be added automatically.</p>

<input type="number" id="amount" placeholder="Enter Amount (GHS)">
<button id="payBtn">Pay Securely</button>
<div id="status"></div>
</div>

<div id="modal">
  <div class="modal-box">
    <h3>âœ… Payment Received</h3>
    <p>Your wallet will be credited automatically after verification.</p>
    <button onclick="location.href='dashboard.html'">Go Dashboard</button>
  </div>
</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

// ðŸ”¥ Firebase Config
const firebaseConfig = {
 apiKey: "AIzaSyBmiippVd5uyAb51U9upNNpSvJk0lXSNg4",
 authDomain: "gigantic-data.firebaseapp.com",
 databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
 projectId: "gigantic-data"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let user = null;

// Ensure login
onAuthStateChanged(auth, u => {
  if(!u) location.href="login.html";
  user = u;
});

// PAY BUTTON
document.getElementById("payBtn").onclick = () => {
  const amt = parseFloat(document.getElementById("amount").value);
  if(!amt || amt < 1) return alert("Enter valid amount");

  // Paystack fee 2.5%
  const fee = amt * 0.025;
  const total = Math.round((amt + fee) * 100);

  const handler = PaystackPop.setup({
    key: "pk_live_faecdb3166144fadebd8269829343698dd43de63",
    email: user.email,
    amount: total,
    currency: "GHS",

    metadata: {
      uid: user.uid,
      real_amount: amt
    },

    callback: async (res) => {
      const refCode = res.reference;
      document.getElementById("status").innerHTML = "Verifying payment...";

      // Save pending payment
      await set(ref(db, `pending_topups/${refCode}`), {
        uid: user.uid,
        email: user.email,
        amount: amt,
        total_paid: total/100,
        timestamp: Date.now(),
        status: "pending"
      });

      // Show UI
      document.getElementById("modal").style.display="flex";

      // Check credit after 30s
      setTimeout(()=>checkCredit(refCode),30000);
    }
  });

  handler.openIframe();
};


// CHECK CREDIT STATUS
async function checkCredit(refCode){
  const snap = await get(ref(db, `verified_payments/${refCode}`));

  if(!snap.exists()){
    // Auto report admin
    await set(ref(db, `admin_reports/${refCode}`), {
      uid: user.uid,
      email: user.email,
      reference: refCode,
      reason: "Payment received but not credited",
      timestamp: Date.now()
    });

    alert("âš  Payment not credited yet. Admin notified.");
  } else {
    document.getElementById("status").innerHTML = "âœ… Wallet credited successfully!";
  }
}
</script>

</body>
</html>