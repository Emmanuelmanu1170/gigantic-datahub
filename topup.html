<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund Wallet - GiganticDataHub</title>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --deep: #0f172a;
            --primary: #4f46e5;
            --success: #10b981;
            --white: #ffffff;
            --slate: #64748b;
        }
        body { margin:0; font-family:'Poppins', sans-serif; background:#f8fafc; color:var(--deep); overflow-x:hidden; }
        .header { background:var(--deep); color:white; padding:20px; display:flex; align-items:center; gap:15px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
        .container { padding:20px; max-width:450px; margin:auto; }
        .card { background:var(--white); border-radius:28px; padding:25px; box-shadow:0 15px 35px rgba(0,0,0,0.05); margin-bottom:20px; border:1px solid #e2e8f0; position:relative; }
        
        .balance-card { 
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); 
            color: white; padding: 22px; border-radius: 22px; margin-bottom: 25px; 
            text-align: center; border: 1px solid rgba(255,255,255,0.1);
        }

        label { display:block; font-weight:700; font-size:12px; margin-bottom:10px; color:var(--slate); text-transform:uppercase; letter-spacing:1px; }
        .input-group { position:relative; margin-bottom:20px; }
        .input-group span { position:absolute; left:18px; top:14px; font-weight:800; color:var(--deep); font-size:1.1rem; }
        
        input { 
            width:100%; padding:16px 16px 16px 60px; border:2px solid #f1f5f9; 
            border-radius:18px; font-size:1.2rem; outline:none; transition:0.3s; 
            box-sizing:border-box; font-weight:600; 
        }
        input:focus { border-color:var(--primary); background:#fff; box-shadow:0 0 0 4px rgba(79,70,229,0.1); }

        .fee-info { background:#f8fafc; border-radius:18px; padding:18px; font-size:0.9rem; border:1px dashed #cbd5e1; margin-bottom:15px; }
        .fee-row { display:flex; justify-content:space-between; margin-bottom:8px; color:var(--slate); }
        .total-row { border-top:2px solid #e2e8f0; padding-top:12px; margin-top:12px; font-weight:800; color:var(--primary); font-size:1.1rem; }

        .pay-btn { 
            width:100%; background:var(--primary); color:white; border:none; padding:20px; 
            border-radius:20px; font-weight:700; font-size:1rem; margin-top:25px; 
            cursor:pointer; transition:0.3s; box-shadow:0 10px 25px rgba(79,70,229,0.3); 
            text-transform:uppercase; letter-spacing:1px;
        }
        .pay-btn:disabled { background:#94a3b8; cursor:not-allowed; box-shadow:none; }

        #status-modal { 
            position:fixed; inset:0; background:rgba(15,23,42,0.85); 
            display:none; align-items:center; justify-content:center; 
            z-index:2000; backdrop-filter:blur(10px);
        }
        .modal-content { 
            background:white; width:85%; max-width:380px; padding:40px 30px; 
            border-radius:32px; text-align:center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .success-icon-wrapper {
            width: 80px; height: 80px; background: #f0fdf4; color: var(--success);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 40px; margin: 0 auto 20px; border: 2px solid #dcfce7;
        }
        .modal-title { font-size: 1.5rem; font-weight: 800; color: var(--deep); margin-bottom: 10px; }
        .modal-text { color: var(--slate); font-size: 0.9rem; line-height: 1.5; margin-bottom: 25px; }
        .done-btn { width: 100%; background: var(--deep); color: white; border: none; padding: 16px; border-radius: 16px; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>

<div id="status-modal">
    <div class="modal-content">
        <div class="success-icon-wrapper"><i class="fas fa-check"></i></div>
        <div class="modal-title">Payment Received</div>
        <div class="modal-text">Your payment is being verified. Your wallet will be updated automatically in a few moments once the network confirms.</div>
        <button class="done-btn" onclick="window.location.href='dashboard.html'">Return to Dashboard</button>
    </div>
</div>

<div class="header">
    <a href="dashboard.html" style="color:white;"><i class="fas fa-arrow-left"></i></a>
    <b style="margin-left:10px">FUND WALLET</b>
</div>

<div class="container">
    <div class="card">
        <div class="balance-card">
            <p style="margin:0; font-size:0.75rem; opacity:0.7; font-weight:600;">AVAILABLE BALANCE</p>
            <h1 id="displayBal" style="margin:8px 0 0; font-size:2.2rem;">GH₵ 0.00</h1>
        </div>

        <label>Amount to Top-up</label>
        <div class="input-group">
            <span>GH₵</span>
            <input type="number" id="amtInput" placeholder="Min: 1.00" step="0.01">
        </div>

        <div class="fee-info">
            <div class="fee-row"><span>Subtotal</span> <span id="subTotal">GH₵ 0.00</span></div>
            <div class="fee-row"><span>Service Fee (2.5%)</span> <span id="feeTotal">GH₵ 0.00</span></div>
            <div class="total-row"><span>Total Payable</span> <span id="totalPay">GH₵ 0.00</span></div>
        </div>

        <button class="pay-btn" id="payBtn" disabled>SECURE TOP-UP NOW</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBmiippVd5uyAb51U9upNNpSvJk0lXSNg4",
        authDomain: "gigantic-data.firebaseapp.com",
        databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
        projectId: "gigantic-data"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;

    // AUTH & BALANCE SYNC
    onAuthStateChanged(auth, user => {
        if (!user) location.href = "login.html";
        currentUser = user;

        onValue(ref(db, `users/${user.uid}/wallet`), s => {
            document.getElementById("displayBal").innerText = "GH₵ " + Number(s.val() || 0).toFixed(2);
        });

        document.getElementById("payBtn").disabled = false;
        document.getElementById("payBtn").onclick = payNow;
    });

    // REAL-TIME FEE CALCULATION
    const input = document.getElementById("amtInput");
    input.oninput = () => {
        const v = Number(input.value || 0);
        const fee = v * 0.025;
        const total = v + fee;
        document.getElementById("subTotal").innerText = `GH₵ ${v.toFixed(2)}`;
        document.getElementById("feeTotal").innerText = `GH₵ ${fee.toFixed(2)}`;
        document.getElementById("totalPay").innerText = `GH₵ ${total.toFixed(2)}`;
    };

    // INITIATE PAYSTACK
    function payNow() {
        const amt = Number(input.value);
        if (!amt || amt < 1) return alert("Please enter a valid amount (Min GH₵ 1)");

        const totalToPay = Math.round((amt * 1.025) * 100); // Amount in Pesewas

        const handler = PaystackPop.setup({
            key: "pk_live_faecdb3166144fadebd8269829343698dd43de63",
            email: currentUser.email,
            amount: totalToPay,
            currency: "GHS",
            metadata: {
                uid: currentUser.uid,
                real_amount: amt
            },
            callback: async (res) => {
                const refCode = res.reference;

                // 1. Record the intent in database (Safety Log)
                // Browser DOES NOT credit wallet. Webhook handles that.
                await set(ref(db, `pending_topups/${refCode}`), {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    amount: amt,
                    totalPaid: totalToPay / 100,
                    status: "waiting_for_webhook",
                    time: Date.now()
                });

                document.getElementById("status-modal").style.display = "flex";

                // 2. Safety Check: Verify if webhook worked after 25 seconds
                setTimeout(() => verifyWebhookSuccess(refCode), 25000);
            },
            onClose: () => {
                console.log("Window closed");
            }
        });
        handler.openIframe();
    }

    // WEBHOOK VERIFICATION (Read-Only Check)
    async function verifyWebhookSuccess(refCode) {
        // We check a node that only the Webhook can write to (e.g., verified_payments)
        const snap = await get(ref(db, `verified_payments/${refCode}`));

        if (!snap.exists()) {
            // If still not credited, alert admin via database
            await set(ref(db, `admin_alerts/${refCode}`), {
                uid: currentUser.uid,
                email: currentUser.email,
                reference: refCode,
                reason: "Webhook Delay / Payment Pending Verification",
                time: Date.now()
            });
            alert("Verification is taking longer than usual. If your wallet isn't updated in 5 mins, please contact support.");
        }
    }
</script>
</body>
</html>
