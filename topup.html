<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund Wallet - GiganticDataHub</title>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --deep-blue: #0f172a;
            --primary: #4f46e5;
            --success: #10b981;
            --error: #ef4444;
            --white: #ffffff;
            --glass: rgba(255, 255, 255, 0.9);
        }

        body { margin: 0; font-family: 'Poppins', sans-serif; background: #f1f5f9; color: var(--deep-blue); }
        .header { background: var(--deep-blue); color: white; padding: 20px; display: flex; align-items: center; gap: 15px; }
        .container { padding: 20px; max-width: 480px; margin: auto; }

        .card {
            background: var(--white); border-radius: 24px; padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }

        .balance-box {
            background: var(--deep-blue); color: white; padding: 15px;
            border-radius: 18px; margin-bottom: 20px; text-align: center;
        }

        label { display: block; font-weight: 700; font-size: 13px; margin-bottom: 10px; color: #64748b; text-transform: uppercase; }
        .input-group { position: relative; margin-bottom: 20px; }
        .input-group span { position: absolute; left: 15px; top: 12px; font-weight: 800; color: var(--deep-blue); }
        input {
            width: 100%; padding: 14px 14px 14px 55px; border: 2px solid #f1f5f9;
            border-radius: 14px; font-size: 1.1rem; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--primary); }

        .fee-info { background: #f8fafc; border-radius: 14px; padding: 15px; font-size: 0.85rem; border: 1px dashed #cbd5e1; }
        .fee-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .total-row { border-top: 2px solid #e2e8f0; padding-top: 10px; margin-top: 10px; font-weight: 800; color: var(--primary); font-size: 1rem; }

        .pay-btn {
            width: 100%; background: var(--primary); color: white; border: none;
            padding: 18px; border-radius: 16px; font-weight: 700; font-size: 1rem;
            margin-top: 25px; cursor: pointer; transition: 0.3s;
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2);
        }

        .whatsapp-note {
            background: #f0fdf4; border: 1px solid #bbf7d0; padding: 15px;
            border-radius: 16px; margin-top: 20px; font-size: 0.8rem;
            display: flex; align-items: center; gap: 12px;
        }
        .wa-link { color: #16a34a; font-weight: 800; text-decoration: underline; cursor: pointer; }

        /* Professional Success Popup */
        #status-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: white; width: 90%; max-width: 350px; padding: 30px;
            border-radius: 24px; text-align: center;
        }
        .success-icon { font-size: 60px; color: var(--success); margin-bottom: 15px; }
    </style>
</head>
<body>

    <div id="status-modal">
        <div class="modal-content">
            <i class="fas fa-check-circle success-icon"></i>
            <h2 style="margin:0">Payment Recorded</h2>
            <p style="color:#64748b; font-size: 13px;">Security verification is active. Your balance will be updated automatically in a few moments.</p>
            <button class="pay-btn" onclick="window.location.href='dashboard.html'">Back to Dashboard</button>
        </div>
    </div>

    <div class="header">
        <a href="dashboard.html" style="color: white;"><i class="fas fa-arrow-left"></i></a>
        <b style="letter-spacing: 1px;">FUND WALLET</b>
    </div>

    <div class="container">
        <div class="card">
            <div class="balance-box">
                <p style="margin:0; font-size:0.7rem; opacity:0.8">WALLET BALANCE</p>
                <h2 id="displayBal" style="margin:5px 0 0">GH₵ 0.00</h2>
            </div>

            <label>Amount to Deposit</label>
            <div class="input-group">
                <span>GH₵</span>
                <input type="number" id="amtInput" placeholder="Minimum 1.00">
            </div>

            <div class="fee-info">
                <div class="fee-row"><span>Subtotal</span> <span id="subTotal">GH₵ 0.00</span></div>
                <div class="fee-row"><span>Admin Fee (2.5%)</span> <span id="feeTotal">GH₵ 0.00</span></div>
                <div class="total-row"><span>Total Payable</span> <span id="totalPay">GH₵ 0.00</span></div>
            </div>

            <button class="pay-btn" id="payBtn" onclick="initiatePayment()">AUTHENTIC TOP-UP</button>
        </div>

        <div class="whatsapp-note">
            <i class="fab fa-whatsapp" style="font-size: 24px; color: #16a34a;"></i>
            <div>
                <b>Account not credited?</b><br>
                Chat Admin with receipt: <span class="wa-link" onclick="window.location.href='https://wa.me/233549055308'">0549055308</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getDatabase, ref, onValue, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyBmiippVd5uyAb51U9upNNpSvJk0lXSNg4", authDomain: "gigantic-data.firebaseapp.com", databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com", projectId: "gigantic-data" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let userDetails = {};

        onAuthStateChanged(auth, user => {
            if (user) {
                userDetails = { uid: user.uid, email: user.email };
                onValue(ref(db, `users/${user.uid}/wallet`), s => {
                    document.getElementById('displayBal').innerText = `GH₵ ${Number(s.val() || 0).toFixed(2)}`;
                });
            } else { window.location.href = "login.html"; }
        });

        const input = document.getElementById('amtInput');
        input.addEventListener('input', () => {
            const val = parseFloat(input.value) || 0;
            const fee = val * 0.025;
            document.getElementById('subTotal').innerText = `GH₵ ${val.toFixed(2)}`;
            document.getElementById('feeTotal').innerText = `GH₵ ${fee.toFixed(2)}`;
            document.getElementById('totalPay').innerText = `GH₵ ${(val + fee).toFixed(2)}`;
        });

        window.initiatePayment = function() {
            const amtRequested = parseFloat(input.value);
            if (amtRequested < 1 || isNaN(amtRequested)) return alert("Minimum GH₵ 1.00");

            const finalAmt = Math.round((amtRequested * 1.025) * 100);

            const handler = PaystackPop.setup({
                key: 'pk_live_faecdb3166144fadebd8269829343698dd43de63',
                email: userDetails.email,
                amount: finalAmt,
                currency: "GHS",
                callback: (res) => {
                    // SECURE HANDSHAKE: Write proof of payment
                    const proofRef = ref(db, `verified_payments/${res.reference}`);
                    set(proofRef, {
                        uid: userDetails.uid,
                        email: userDetails.email,
                        amount: amtRequested,
                        timestamp: serverTimestamp(),
                        status: "awaiting_sync"
                    }).then(() => {
                        document.getElementById('status-modal').style.display = 'flex';
                    });
                }
            });
            handler.openIframe();
        };
    </script>
</body>
</html>
