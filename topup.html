<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund Wallet - GiganticDataHub</title>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --deep: #0f172a; --primary: #4f46e5; --success: #10b981; --bg: #f8fafc; --white: #ffffff; --slate: #64748b; }
        body { margin:0; font-family:'Poppins', sans-serif; background:var(--bg); color:var(--deep); }
        .header { background:var(--deep); color:white; padding:20px; display:flex; align-items:center; gap:15px; }
        .container { padding:20px; max-width:450px; margin:auto; }
        .card { background:var(--white); border-radius:28px; padding:25px; box-shadow:0 15px 35px rgba(0,0,0,0.05); border:1px solid #e2e8f0; }
        .balance-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; padding: 22px; border-radius: 22px; text-align: center; margin-bottom: 25px; }
        .input-group { position:relative; margin-bottom:20px; }
        .input-group span { position:absolute; left:18px; top:14px; font-weight:800; color:var(--deep); }
        input { width:100%; padding:16px 16px 16px 60px; border:2px solid #f1f5f9; border-radius:18px; font-size:1.2rem; outline:none; box-sizing:border-box; }
        .fee-info { background:#f8fafc; border-radius:18px; padding:18px; font-size:0.9rem; border:1px dashed #cbd5e1; margin-bottom:15px; }
        .pay-btn { width:100%; background:var(--primary); color:white; border:none; padding:20px; border-radius:20px; font-weight:700; cursor:pointer; }
        .pay-btn:disabled { background:#94a3b8; cursor:not-allowed; }
        #status-modal { position:fixed; inset:0; background:rgba(15,23,42,0.85); display:none; align-items:center; justify-content:center; z-index:2000; backdrop-filter:blur(10px); }
        .modal-content { background:white; width:85%; max-width:380px; padding:40px 30px; border-radius:32px; text-align:center; }
    </style>
</head>
<body>

<div id="status-modal">
    <div class="modal-content">
        <div style="font-size: 40px; color: var(--success); margin-bottom: 20px;"><i class="fas fa-check-circle"></i></div>
        <h2 style="margin-bottom:10px;">Payment Verified</h2>
        <p style="color:var(--slate); font-size:0.9rem; margin-bottom:25px;">Finalizing credit. Your wallet will update automatically once the Cloud Function confirms the payment.</p>
        <button onclick="window.location.href='dashboard.html'" style="width:100%; padding:15px; border-radius:16px; border:none; background:var(--deep); color:white; font-weight:700;">Back to Dashboard</button>
    </div>
</div>

<div class="header">
    <a href="dashboard.html" style="color:white;"><i class="fas fa-arrow-left"></i></a>
    <b>FUND WALLET</b>
</div>

<div class="container">
    <div class="card">
        <div class="balance-card">
            <p style="font-size:0.75rem; opacity:0.7;">AVAILABLE BALANCE</p>
            <h1 id="displayBal">GH₵ 0.00</h1>
        </div>

        <div class="input-group">
            <span>GH₵</span>
            <input type="number" id="amtInput" placeholder="Min 1.00">
        </div>

        <div class="fee-info">
            <div style="display:flex; justify-content:space-between;"><span>Subtotal</span> <span id="subTotal">GH₵ 0.00</span></div>
            <div style="display:flex; justify-content:space-between; margin-top:8px;"><span>Fee (2.5%)</span> <span id="feeTotal">GH₵ 0.00</span></div>
            <div style="border-top:2px solid #e2e8f0; margin-top:12px; padding-top:12px; font-weight:800; color:var(--primary);">Total: <span id="totalPay">GH₵ 0.00</span></div>
        </div>

        <button class="pay-btn" id="payBtn" disabled>SECURE TOP-UP NOW</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBmiippVd5uyAb51U9upNNpSvJk0lXSNg4",
        authDomain: "gigantic-data.firebaseapp.com",
        databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
        projectId: "gigantic-data"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;

    onAuthStateChanged(auth, user => {
        if (!user) { window.location.href = "login.html"; return; }
        currentUser = user;

        onValue(ref(db, `users/${user.uid}/wallet`), s => {
            document.getElementById("displayBal").innerText = "GH₵ " + Number(s.val() || 0).toFixed(2);
        });

        const payBtn = document.getElementById("payBtn");
        payBtn.disabled = false;
        payBtn.onclick = payNow;
    });

    const input = document.getElementById("amtInput");
    input.oninput = () => {
        const v = Number(input.value || 0);
        const fee = v * 0.025;
        document.getElementById("subTotal").innerText = `GH₵ ${v.toFixed(2)}`;
        document.getElementById("feeTotal").innerText = `GH₵ ${fee.toFixed(2)}`;
        document.getElementById("totalPay").innerText = `GH₵ ${(v + fee).toFixed(2)}`;
    };

    function payNow() {
        const amt = Number(input.value);
        if (!amt || amt < 1) return alert("Min GH₵ 1.00");

        const payBtn = document.getElementById("payBtn");
        payBtn.disabled = true;
        payBtn.innerText = "PROCESSING...";

        // Explicitly use window.PaystackPop to ensure it is found globally
        if (typeof window.PaystackPop === 'undefined') {
            alert("Payment library not ready. Please refresh.");
            payBtn.disabled = false;
            payBtn.innerText = "SECURE TOP-UP NOW";
            return;
        }

        const handler = window.PaystackPop.setup({
            key: "pk_live_faecdb3166144fadebd8269829343698dd43de63",
            email: currentUser.email,
            amount: Math.round((amt * 1.025) * 100),
            currency: "GHS",
            metadata: { uid: currentUser.uid, real_amount: amt },
            callback: async (res) => {
                const refCode = res.reference;
                
                // 1. Record the intent (Used for admin verification)
                await set(ref(db, `pending_topups/${refCode}`), {
                    uid: currentUser.uid,
                    amount: amt,
                    status: "waiting_for_cloud_function",
                    time: Date.now()
                });

                // 2. Show Modal (The wallet will be updated by your Webhook)
                document.getElementById("status-modal").style.display = "flex";
                
                // Safety Verification Check
                setTimeout(async () => {
                    const snap = await get(ref(db, `verified_payments/${refCode}`));
                    if (!snap.exists()) {
                        alert("Cloud Function is still processing. Your wallet will update in a moment.");
                    }
                }, 20000);
            },
            onClose: () => {
                payBtn.disabled = false;
                payBtn.innerText = "SECURE TOP-UP NOW";
            }
        });
        handler.openIframe();
    }
</script>
</body>
</html>
