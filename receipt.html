<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Ledger & Receipts — GiganticDataHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #001a33; --accent: #ff8c00; --success: #10b981; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        
        /* RECEIPT DESIGN */
        #receiptArea {
            width: 100%; max-width: 360px; background: white; padding: 25px;
            border-radius: 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.08);
            position: relative; border-top: 8px solid var(--primary);
        }

        .receipt-header { text-align: center; border-bottom: 2px dashed #eee; padding-bottom: 20px; margin-bottom: 20px; }
        .receipt-header h2 { font-size: 14px; color: var(--primary); margin: 10px 0 5px; text-transform: uppercase; letter-spacing: 2px; }
        .logo-circ { width: 45px; height: 45px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-size: 20px; }

        .price-section { text-align: center; margin: 20px 0; }
        .price-section b { font-size: 36px; color: var(--primary); display: block; }
        .price-section span { font-size: 12px; color: var(--success); font-weight: 800; background: #dcfce7; padding: 4px 12px; border-radius: 20px; }

        .data-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .data-table th { text-align: left; font-size: 10px; color: #94a3b8; text-transform: uppercase; padding: 8px 0; }
        .data-table td { text-align: right; font-size: 13px; font-weight: 700; color: #1e293b; padding: 8px 0; }

        .barcode-mimic { height: 40px; background: repeating-linear-gradient(90deg, #333, #333 2px, #fff 2px, #fff 6px); opacity: 0.2; margin-top: 20px; }

        /* LEDGER BOOK SECTION */
        .ledger-container { width: 100%; max-width: 400px; margin-top: 40px; }
        .ledger-title { font-size: 12px; font-weight: 900; color: #64748b; text-transform: uppercase; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }

        .ledger-book { background: white; border-radius: 20px; overflow: hidden; border: 1px solid #e2e8f0; }
        .order-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s;
        }
        .order-row:hover { background: #f8fafc; }
        .order-row.active { border-left: 4px solid var(--accent); background: #fff7ed; }
        
        .row-info b { font-size: 13px; display: block; color: var(--primary); }
        .row-info span { font-size: 11px; color: #94a3b8; }
        .row-price { font-weight: 800; color: var(--primary); font-size: 14px; }

        /* BUTTONS */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 360px; margin-top: 25px; }
        .btn { padding: 15px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 13px; }
        .btn-dl { background: var(--primary); color: white; }
        .btn-wa { background: #25d366; color: white; }
    </style>
</head>
<body>

    <div id="receiptArea">
        <div class="receipt-header">
            <div class="logo-circ"><i class="fas fa-bolt"></i></div>
            <h2>Official Transaction Receipt</h2>
        </div>

        <div class="price-section">
            <b id="rAmount">₵0.00</b>
            <span>PAYMENT SUCCESSFUL</span>
        </div>

        <table class="data-table">
            <tr><th>Recipient Number</th><td id="rRecipient">---</td></tr>
            <tr><th>Service/Plan</th><td id="rPlan">---</td></tr>
            <tr><th>Network Type</th><td id="rNetwork">---</td></tr>
            <tr><th>Transaction ID</th><td id="rRef">---</td></tr>
            <tr><th>Date & Time</th><td id="rDate">---</td></tr>
        </table>

        <div style="text-align: center;">
            <p style="font-size: 10px; color: #94a3b8; margin: 0;">Verified by GiganticDataHub Systems</p>
            <div class="barcode-mimic"></div>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn btn-dl" onclick="downloadReceipt()"><i class="fas fa-file-download"></i> Save Proof</button>
        <button class="btn btn-wa" onclick="shareWhatsApp()"><i class="fab fa-whatsapp"></i> Share</button>
    </div>

    <div class="ledger-container">
        <div class="ledger-title"><i class="fas fa-book-open"></i> Daily Transaction Ledger</div>
        <div class="ledger-book" id="ledgerBody">
            <p style="text-align:center; padding:20px; color:#94a3b8; font-size:12px;"><i class="fas fa-spinner fa-spin"></i> Syncing business records...</p>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyBmiippVd5uyAb51U9upNNpSvJk0lXSNg4", 
        authDomain: "gigantic-data.firebaseapp.com", 
        databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com", 
        projectId: "gigantic-data" 
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let activeOrder = null;

    onAuthStateChanged(auth, user => {
        if (user) {
            // Path corrected to match your dashboard history path: user_orders/UID
            const orderRef = ref(db, `user_orders/${user.uid}`);
            
            onValue(orderRef, snap => {
                const ledger = document.getElementById('ledgerBody');
                ledger.innerHTML = "";
                
                if (!snap.exists()) {
                    ledger.innerHTML = `<p style="padding:20px; text-align:center; color:#94a3b8;">No business records found.</p>`;
                    return;
                }

                let orders = [];
                snap.forEach(child => { 
                    orders.push({ id: child.key, ...child.val() }); 
                });

                // Sort by timestamp (latest first)
                orders.sort((a,b) => b.timestamp - a.timestamp);

                orders.slice(0, 15).forEach((order, index) => {
                    const row = document.createElement('div');
                    row.className = `order-row ${index === 0 ? 'active' : ''}`;
                    row.onclick = () => selectOrder(order, row);
                    
                    row.innerHTML = `
                        <div class="row-info">
                            <b>${order.recipient}</b>
                            <span>${(order.network || 'N/A').toUpperCase()} • ${order.plan}</span>
                        </div>
                        <div class="row-price">₵${Number(order.amount || 0).toFixed(2)}</div>
                    `;
                    ledger.appendChild(row);
                    
                    // Automatically display the most recent receipt on load
                    if(index === 0) updateReceipt(order);
                });
            });
        } else {
            window.location.href = "login.html";
        }
    });

    function selectOrder(order, element) {
        document.querySelectorAll('.order-row').forEach(r => r.classList.remove('active'));
        element.classList.add('active');
        updateReceipt(order);
    }

    function updateReceipt(order) {
        activeOrder = order;
        document.getElementById('rAmount').innerText = `₵${Number(order.amount || 0).toFixed(2)}`;
        document.getElementById('rRecipient').innerText = order.recipient || 'N/A';
        document.getElementById('rPlan').innerText = order.plan || 'Data Plan';
        document.getElementById('rNetwork').innerText = (order.network || 'N/A').toUpperCase();
        document.getElementById('rRef').innerText = order.id.slice(-10).toUpperCase();
        document.getElementById('rDate').innerText = new Date(order.timestamp).toLocaleString();
    }

    window.downloadReceipt = () => {
        if(!activeOrder) return;
        const element = document.getElementById('receiptArea');
        html2canvas(element).then(canvas => {
            const link = document.createElement('a');
            link.download = `Receipt_${activeOrder.recipient}_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    };

    window.shareWhatsApp = () => {
        if(!activeOrder) return;
        const text = `*TRANSACTION SUCCESSFUL* ✅\n\n*Recipient:* ${activeOrder.recipient}\n*Plan:* ${activeOrder.plan}\n*Amount:* ₵${Number(activeOrder.amount).toFixed(2)}\n*Ref:* ${activeOrder.id.slice(-8).toUpperCase()}\n\n*Processed by GiganticDataHub* ⚡`;
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
    };
</script>
</body>
</html>
