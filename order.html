<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Checkout - Gigantic Data Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --accent: #6a5af9; --success: #10b981; --bg: #f8fafc; }
        body { background-color: var(--bg); font-family: 'Inter', sans-serif; }
        .order-card { background: white; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .info-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .price-box { background: #f5f3ff; border: 1px dashed var(--accent); border-radius: 16px; }
        
        #successOverlay {
            display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95);
            z-index: 1000; align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="max-w-md w-full order-card p-8">
        <div class="text-center mb-6">
            <i class="fas fa-shield-check text-4xl text-indigo-500"></i>
            <h2 class="text-2xl font-extrabold text-slate-800 mt-2">Confirm Order</h2>
        </div>

        <div class="space-y-1 mb-6" id="details">
            <p class="text-center text-slate-400 animate-pulse">Syncing Order Details...</p>
        </div>

        <div id="priceArea" class="price-box p-6 text-center mb-6"></div>

        <button id="confirmBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl transition-all shadow-lg active:scale-95">
            CONFIRM & PAY NOW
        </button>
    </div>

    <div id="successOverlay">
        <div class="bg-white rounded-3xl p-10 max-w-xs w-full text-center shadow-2xl">
            <div class="w-20 h-20 bg-emerald-500 text-white rounded-full flex items-center justify-center text-4xl mx-auto mb-6 shadow-lg shadow-emerald-200">
                <i class="fas fa-check"></i>
            </div>
            <h2 class="text-2xl font-black text-slate-800">Order Placed!</h2>
            <p class="text-slate-500 mt-3 mb-8">Data details have been recorded. Delivery is in progress.</p>
            <div class="flex items-center justify-center gap-2 text-emerald-600 font-bold text-sm">
                <i class="fas fa-spinner fa-spin"></i> Moving to History...
            </div>
        </div>
    </div>

    

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getDatabase, ref, onValue, update, push } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCLl30c9nc09dZrkodA80hj5KSe9_B_aho", 
            authDomain: "gigantic-data.firebaseapp.com", 
            databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com", 
            projectId: "gigantic-data"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const API_KEY = "tera_live_95abf76d96984f4612153a4869e43d3e";
        const API_URL = "https://idatagh.com/wp-json/custom/v1/place-order";

        // Admin Impersonation Support
        const impersonateUid = sessionStorage.getItem('impersonate_uid');
        const isImpersonating = sessionStorage.getItem('isAdminImpersonating');

        onAuthStateChanged(auth, (user) => {
            if (!user) { window.location.href = "login.html"; return; }

            const order = JSON.parse(localStorage.getItem('pendingOrder'));
            if (!order) { window.location.href = "order.html"; return; }

            // Decide whose wallet to use
            const activeUid = (isImpersonating === 'true' && impersonateUid) ? impersonateUid : user.uid;

            onValue(ref(db, `users/${activeUid}`), (snapshot) => {
                const userData = snapshot.val() || {};
                const wallet = parseFloat(userData.balance || userData.wallet || 0);
                const cost = parseFloat(order.amount);

                document.getElementById('details').innerHTML = `
                    <div class="info-item"><span class="text-slate-500">Network</span><span class="font-bold text-indigo-600">${order.network}</span></div>
                    <div class="info-item"><span class="text-slate-500">Plan</span><span class="font-bold">${order.plan}</span></div>
                    <div class="info-item"><span class="text-slate-500">Recipient</span><span class="font-bold">${order.recipient}</span></div>
                    <div class="info-item"><span class="text-slate-500">Wallet</span><span class="font-bold">₵${wallet.toFixed(2)}</span></div>
                `;

                document.getElementById('priceArea').innerHTML = `
                    <p class="text-xs font-bold uppercase text-indigo-400">Total Charge</p>
                    <h1 class="text-3xl font-black text-slate-800">GH₵ ${cost.toFixed(2)}</h1>
                `;

                document.getElementById('confirmBtn').onclick = async () => {
                    if (wallet < cost) { alert("Insufficient Balance!"); return; }

                    const btn = document.getElementById('confirmBtn');
                    btn.disabled = true;
                    btn.innerText = "Connecting to Gateway...";

                    try {
                        // 1. API Call to Provider
                        const response = await fetch(API_URL, {
                            method: "POST",
                            headers: { "Authorization": "Bearer " + API_KEY, "Content-Type": "application/json" },
                            body: JSON.stringify({
                                "network": order.network.toLowerCase().includes("mtn") ? "mtn" : (order.network.toLowerCase().includes("telecel") ? "telecel" : "at"),
                                "beneficiary": order.recipient.toString().trim(),
                                "pa_data-bundle-packages": order.plan 
                            })
                        });

                        const res = await response.json();
                        if (res.status === "error") throw new Error(res.message);

                        // 2. Prepare Database Update (Unified Deduction)
                        const orderId = "GID-" + Math.floor(Math.random() * 90000 + 10000);
                        const newBalance = parseFloat((wallet - cost).toFixed(2));
                        const txKey = push(ref(db, 'transactions')).key;

                        const fullOrderRecord = {
                            ...order,
                            orderId: orderId,
                            uid: activeUid,
                            status: "Successful",
                            provider_id: res.order_id || "N/A",
                            timestamp: Date.now(),
                            date: new Date().toLocaleString()
                        };

                        const updates = {};
                        // Balance Deduction (Rules allow this because it's a decrease)
                        updates[`users/${activeUid}/balance`] = newBalance;
                        updates[`users/${activeUid}/wallet`] = newBalance; 
                        
                        // Order Logging
                        updates[`orders/${orderId}`] = fullOrderRecord;
                        updates[`user_orders/${activeUid}/${orderId}`] = fullOrderRecord;
                        
                        // Transaction Ledger
                        updates[`transactions/${txKey}`] = {
                            uid: activeUid,
                            email: userData.email,
                            amount: cost,
                            type: "Deduct",
                            description: `Data: ${order.network} ${order.plan} to ${order.recipient}`,
                            timestamp: Date.now(),
                            newBalance: newBalance,
                            orderId: orderId
                        };

                        // Push all updates to Firebase
                        await update(ref(db), updates);
                        
                        // 3. Clear and Redirect
                        localStorage.removeItem('pendingOrder');
                        document.getElementById('successOverlay').style.display = 'flex';
                        setTimeout(() => window.location.href = "order_history.html", 3000);

                    } catch (err) {
                        console.error("GATEWAY_ERROR:", err);
                        alert("Error: " + err.message);
                        btn.disabled = false;
                        btn.innerText = "CONFIRM & PAY NOW";
                    }
                };
            }, { onlyOnce: true });
        });
    </script>
</body>
</html>
