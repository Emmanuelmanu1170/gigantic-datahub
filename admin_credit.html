<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Ledger — GiganticDataHub Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --navy: #0a192f; --accent: #6a5af9; }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-header { background: rgba(10, 25, 47, 0.95); backdrop-filter: blur(10px); }
        .table-container { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .badge-credit { background: #dcfce7; color: #15803d; }
        .badge-debit { background: #fee2e2; color: #b91c1c; }
        tr:hover { background-color: #f1f5f9; }
    </style>
</head>
<body>

    <header class="glass-header text-white p-6 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="admin_dashboard.html" class="text-slate-400 hover:text-white transition"><i class="fas fa-arrow-left text-xl"></i></a>
                <h1 class="text-xl font-black tracking-tight">SYSTEM MASTER LEDGER</h1>
            </div>
            <div class="text-sm font-bold text-indigo-400" id="adminEmail">Checking Auth...</div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                <p class="text-slate-500 text-xs font-bold uppercase tracking-widest">Total Volume</p>
                <h2 class="text-3xl font-black text-slate-800 mt-2" id="totalVol">₵ 0.00</h2>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                <p class="text-slate-500 text-xs font-bold uppercase tracking-widest text-emerald-500">Total Credits</p>
                <h2 class="text-3xl font-black text-emerald-600 mt-2" id="totalCredits">₵ 0.00</h2>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                <p class="text-slate-500 text-xs font-bold uppercase tracking-widest text-rose-500">Total Debits</p>
                <h2 class="text-3xl font-black text-rose-600 mt-2" id="totalDebits">₵ 0.00</h2>
            </div>
        </div>

        <div class="mb-6 flex flex-wrap gap-4 items-center justify-between">
            <div class="relative w-full max-w-md">
                <i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i>
                <input type="text" id="logSearch" placeholder="Search Email, UID, or Description..." 
                    class="w-full pl-12 pr-4 py-3 rounded-2xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500 transition">
            </div>
            <button onclick="exportToCSV()" class="bg-slate-800 text-white px-6 py-3 rounded-2xl font-bold hover:bg-black transition flex items-center gap-2">
                <i class="fas fa-file-export"></i> Export CSV
            </button>
        </div>

        <div class="table-container overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50 text-slate-400 text-xs uppercase tracking-tighter">
                            <th class="p-5">Date/Time</th>
                            <th class="p-5">User Account</th>
                            <th class="p-5">Type</th>
                            <th class="p-5">Description</th>
                            <th class="p-5 text-right">Amount</th>
                            <th class="p-5 text-right">Balance After</th>
                        </tr>
                    </thead>
                    <tbody id="ledgerBody" class="text-sm text-slate-700 font-medium">
                        </tbody>
                </table>
            </div>
            <div id="loader" class="p-20 text-center text-slate-400">
                <i class="fas fa-circle-notch fa-spin text-3xl mb-4"></i>
                <p>Synchronizing with Firebase Transaction Streams...</p>
            </div>
        </div>
    </main>

    

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCLl30c9nc09dZrkodA80hj5KSe9_B_aho", 
            authDomain: "gigantic-data.firebaseapp.com", 
            databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com", 
            projectId: "gigantic-data"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const ADMIN_EMAIL = "alenacloft0@gmail.com";
        let allLogs = [];

        onAuthStateChanged(auth, (user) => {
            if (!user || user.email !== ADMIN_EMAIL) {
                window.location.href = "admin_login.html";
                return;
            }
            document.getElementById('adminEmail').innerText = `Logged in as: ${user.email}`;
            loadMasterLedger();
        });

        function loadMasterLedger() {
            // Unified path: reading from the global transactions node
            onValue(ref(db, 'transactions'), (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    document.getElementById('loader').innerHTML = "No transactions found in system.";
                    return;
                }

                document.getElementById('loader').style.display = 'none';
                
                // Convert to array and sort by time descending
                allLogs = Object.entries(data).map(([id, val]) => ({
                    id, ...val
                })).sort((a, b) => b.timestamp - a.timestamp);

                renderLedger();
                calculateStats();
            });
        }

        function calculateStats() {
            let credits = 0;
            let debits = 0;
            allLogs.forEach(log => {
                const amt = parseFloat(log.amount || 0);
                if (log.type === "Credit") credits += amt;
                else debits += amt;
            });

            document.getElementById('totalCredits').innerText = `₵ ${credits.toFixed(2)}`;
            document.getElementById('totalDebits').innerText = `₵ ${debits.toFixed(2)}`;
            document.getElementById('totalVol').innerText = `₵ ${(credits + debits).toFixed(2)}`;
        }

        function renderLedger() {
            const body = document.getElementById('ledgerBody');
            const search = document.getElementById('logSearch').value.toLowerCase();
            body.innerHTML = "";

            const filtered = allLogs.filter(log => 
                (log.uid && log.uid.toLowerCase().includes(search)) ||
                (log.description && log.description.toLowerCase().includes(search)) ||
                (log.email && log.email.toLowerCase().includes(search))
            );

            filtered.forEach(log => {
                const date = new Date(log.timestamp).toLocaleString();
                const isCredit = log.type === "Credit";
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-5 text-slate-400 text-xs">${date}</td>
                    <td class="p-5">
                        <span class="block text-slate-800">${log.email || 'System User'}</span>
                        <span class="text-[10px] text-slate-400 font-mono">${log.uid || '---'}</span>
                    </td>
                    <td class="p-5">
                        <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase ${isCredit ? 'badge-credit' : 'badge-debit'}">
                            ${log.type}
                        </span>
                    </td>
                    <td class="p-5 text-slate-500 italic">${log.description || 'No description'}</td>
                    <td class="p-5 text-right font-black ${isCredit ? 'text-emerald-500' : 'text-rose-500'}">
                        ${isCredit ? '+' : '-'} ₵${parseFloat(log.amount).toFixed(2)}
                    </td>
                    <td class="p-5 text-right text-slate-800 font-bold">
                        ₵${parseFloat(log.newBalance || 0).toFixed(2)}
                    </td>
                `;
                body.appendChild(tr);
            });
        }

        document.getElementById('logSearch').addEventListener('input', renderLedger);

        window.exportToCSV = () => {
            let csv = "Date,User,UID,Type,Description,Amount,BalanceAfter\n";
            allLogs.forEach(l => {
                csv += `${new Date(l.timestamp).toLocaleString()},${l.email},${l.uid},${l.type},"${l.description}",${l.amount},${l.newBalance}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'Gigantic_Master_Ledger.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };
    </script>
</body>
</html>
