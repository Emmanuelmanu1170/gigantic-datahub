<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin: Master Ledger - GiganticData</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #4f46e5;
            --dark: #0f172a;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f8fafc;
        }
        body { margin:0; font-family:'Inter', sans-serif; background:var(--bg); color:var(--dark); }
        .container { padding: 30px; max-width: 1200px; margin: auto; }
        
        /* Header & Filters */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .filter-bar { display: flex; gap: 10px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .filter-btn { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.8rem; background: #f1f5f9; color: #64748b; transition: 0.3s; }
        .filter-btn.active { background: var(--primary); color: white; }

        /* Ledger Table */
        .ledger-card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #f8fafc; color: #64748b; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; }
        
        /* Badges */
        .type-pill { padding: 4px 8px; border-radius: 6px; font-weight: 800; font-size: 0.7rem; text-transform: uppercase; }
        .type-credit { background: #dcfce7; color: #166534; }
        .type-debit { background: #fee2e2; color: #991b1b; }
        
        .uid-link { color: var(--primary); font-family: monospace; cursor: pointer; text-decoration: none; }
        .uid-link:hover { text-decoration: underline; }
        
        .empty-state { text-align: center; padding: 50px; color: #94a3b8; }
    </style>
</head>
<body>

<div class="container">
    <div class="page-header">
        <div>
            <h1 style="font-size: 1.5rem; margin-bottom: 5px;">Master Transaction Ledger</h1>
            <p style="color: #64748b; font-size: 0.9rem;">Real-time monitoring of all user financial activity</p>
        </div>
        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterLedger('all', this)">All</button>
            <button class="filter-btn" onclick="filterLedger('topup', this)">Top-ups</button>
            <button class="filter-btn" onclick="filterLedger('data', this)">Data Purchases</button>
        </div>
    </div>

    <div class="ledger-card">
        
        <table id="ledgerTable">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>User ID</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Reference / Plan</th>
                    <th>Note</th>
                </tr>
            </thead>
            <tbody id="ledgerBody">
                </tbody>
        </table>
        <div id="emptyMsg" class="empty-state" style="display: none;">
            <i class="fas fa-search-dollar" style="font-size: 2rem; margin-bottom: 10px;"></i>
            <p>No transactions found for this filter.</p>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, query, onValue, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBmiippVd5uyAb51U9upNNpSvJk0lXSNg4",
    authDomain: "gigantic-data.firebaseapp.com",
    databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
    projectId: "gigantic-data"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let allTransactions = [];

onAuthStateChanged(auth, user => {
    if (!user || user.email !== 'alenacloft0@gmail.com') {
        window.location.href = "dashboard.html";
    } else {
        fetchTransactions();
    }
});

function fetchTransactions() {
    // Fetch last 100 transactions globally
    const txRef = query(ref(db, 'transactions'), limitToLast(100));
    
    onValue(txRef, (snapshot) => {
        const ledgerBody = document.getElementById('ledgerBody');
        ledgerBody.innerHTML = "";
        allTransactions = [];

        if (snapshot.exists()) {
            snapshot.forEach(child => {
                allTransactions.push({ id: child.key, ...child.val() });
            });
            
            // Reverse to show newest first
            renderTable(allTransactions.reverse());
        } else {
            document.getElementById('emptyMsg').style.display = "block";
        }
    });
}

function renderTable(data) {
    const tbody = document.getElementById('ledgerBody');
    const emptyMsg = document.getElementById('emptyMsg');
    tbody.innerHTML = "";
    
    if (data.length === 0) {
        emptyMsg.style.display = "block";
        return;
    }
    emptyMsg.style.display = "none";

    data.forEach(tx => {
        const date = new Date(tx.date).toLocaleString([], {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
        const typeClass = tx.type === "Credit" ? "type-credit" : "type-debit";
        const symbol = tx.type === "Credit" ? "+" : "-";

        tbody.innerHTML += `
            <tr>
                <td><small>${date}</small></td>
                <td><span class="uid-link" onclick="copyUid('${tx.uid}')" title="Click to copy UID">${tx.uid.substring(0,8)}...</span></td>
                <td><span class="type-pill ${typeClass}">${tx.type}</span></td>
                <td><b style="color: ${tx.type === 'Credit' ? '#166534' : '#991b1b'}">${symbol} â‚µ${tx.amount.toFixed(2)}</b></td>
                <td><small>${tx.reference || tx.plan || 'N/A'}</small></td>
                <td><span style="opacity: 0.7;">${tx.note || tx.category || ''}</span></td>
            </tr>
        `;
    });
}

window.filterLedger = function(category, btn) {
    // UI Update
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // Filtering logic
    if (category === 'all') {
        renderTable(allTransactions);
    } else {
        const filtered = allTransactions.filter(tx => tx.category === category);
        renderTable(filtered);
    }
};

window.copyUid = function(uid) {
    navigator.clipboard.writeText(uid);
    alert("UID Copied: " + uid);
};
</script>
</body>
</html>
