<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin: Audit & Credit - GiganticData</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #4f46e5;
            --dark: #0f172a;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f1f5f9;
        }
        body { margin:0; font-family:'Inter', sans-serif; background:var(--bg); color:var(--dark); }
        .wrapper { max-width: 1200px; margin: auto; padding: 20px; display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        
        .card { background:white; border-radius:20px; padding:25px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        h3 { margin-top: 0; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px; color: #64748b; margin-bottom: 20px;}

        /* Input Styles */
        .input-group { margin-bottom: 15px; position: relative; }
        label { display:block; font-weight:700; font-size:11px; color:#64748b; margin-bottom: 5px; }
        input { 
            width:100%; padding:12px; border:2px solid #f1f5f9; border-radius:10px; 
            font-size:0.9rem; outline:none; box-sizing:border-box; transition: 0.3s;
        }
        input:focus { border-color:var(--primary); }
        
        /* Reference Checker Badge */
        .ref-status { position: absolute; right: 10px; top: 32px; font-size: 0.7rem; font-weight: 800; padding: 4px 8px; border-radius: 6px; display: none;}
        
        .user-info { background: #f8fafc; padding: 15px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid var(--primary); display: none; }
        
        .btn-exec { 
            width:100%; background:var(--primary); color:white; border:none; 
            padding:16px; border-radius:12px; font-weight:700; cursor:pointer; 
        }

        /* Audit Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { text-align: left; padding: 12px; background: #f8fafc; color: #64748b; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; }
        
        .bal-pill { font-family: monospace; font-weight: 700; padding: 2px 6px; border-radius: 4px; background: #eee; }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }

        @media (max-width: 900px) { .wrapper { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="card">
        <h3><i class="fas fa-plus-circle"></i> Smart Credit</h3>
        
        <div class="input-group">
            <label>User UID</label>
            <input type="text" id="targetUid" placeholder="Paste UID..." oninput="checkUser(this.value)">
        </div>

        <div id="userBox" class="user-info">
            <div style="font-weight: 800;" id="uName">---</div>
            <div style="font-size: 0.8rem; opacity: 0.7;">Current Wallet: <span id="uWall">₵0.00</span></div>
        </div>

        <div class="input-group">
            <label>Paystack Reference</label>
            <input type="text" id="payRef" placeholder="T123456789..." oninput="verifyRef(this.value)">
            <span id="refBadge" class="ref-status"></span>
        </div>

        <div class="input-group">
            <label>Amount to Credit (₵)</label>
            <input type="number" id="amt" placeholder="0.00" step="0.01">
        </div>

        <button class="btn-exec" id="execBtn" onclick="runCredit()">APPROVE & UPDATE WALLET</button>
    </div>

    <div class="card">
        <h3><i class="fas fa-list-check"></i> Audit Trail (Manual Credits)</h3>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>User & Reference</th>
                        <th>Before</th>
                        <th>Credit</th>
                        <th>After</th>
                    </tr>
                </thead>
                <tbody id="auditBody">
                    <tr><td colspan="5" style="text-align:center">Loading audit logs...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, get, update, query, limitToLast, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBmiippVd5uyAb51U9upNNpSvJk0lXSNg4",
    authDomain: "gigantic-data.firebaseapp.com",
    databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
    projectId: "gigantic-data"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

onAuthStateChanged(auth, user => {
    if (!user || user.email !== 'alenacloft0@gmail.com') {
        window.location.href = "dashboard.html";
    } else {
        loadAuditTrail();
    }
});

// FEATURE: REAL-TIME REFERENCE CHECKER
window.verifyRef = async function(refStr) {
    const badge = document.getElementById('refBadge');
    if (refStr.length < 5) { badge.style.display = "none"; return; }
    
    const snap = await get(ref(db, `verified_references/${refStr}`));
    badge.style.display = "block";
    if (snap.exists()) {
        badge.innerText = "ALREADY USED";
        badge.style.background = "#fef2f2";
        badge.style.color = "#991b1b";
    } else {
        badge.innerText = "AVAILABLE";
        badge.style.background = "#ecfdf5";
        badge.style.color = "#065f46";
    }
};

// FEATURE: USER INFO PREVIEW
window.checkUser = async function(uid) {
    if (uid.length < 10) return;
    const snap = await get(ref(db, `users/${uid}`));
    const box = document.getElementById('userBox');
    if (snap.exists()) {
        const u = snap.val();
        document.getElementById('uName').innerText = u.name || u.email;
        document.getElementById('uWall').innerText = "₵" + (parseFloat(u.wallet) || 0).toFixed(2);
        box.style.display = "block";
    } else {
        box.style.display = "none";
    }
};

// FEATURE: AUDIT LOG WITH BEFORE/AFTER BALANCE
function loadAuditTrail() {
    const auditRef = query(ref(db, 'admin_deposit_logs'), limitToLast(20));
    onValue(auditRef, (snapshot) => {
        const tbody = document.getElementById('auditBody');
        tbody.innerHTML = "";
        if (snapshot.exists()) {
            const logs = [];
            snapshot.forEach(child => { logs.push(child.val()); });
            logs.reverse().forEach(log => {
                const date = new Date(log.date).toLocaleString([], {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
                tbody.innerHTML += `
                    <tr>
                        <td><small>${date}</small></td>
                        <td>
                            <b>${log.user_email || 'User'}</b><br>
                            <small style="color:#64748b">${log.ref}</small>
                        </td>
                        <td><span class="bal-pill">₵${log.oldBal.toFixed(2)}</span></td>
                        <td><b class="text-success">+₵${log.amt.toFixed(2)}</b></td>
                        <td><span class="bal-pill" style="background:var(--primary); color:white">₵${log.newBal.toFixed(2)}</span></td>
                    </tr>
                `;
            });
        }
    });
}

window.runCredit = async function() {
    const uid = document.getElementById('targetUid').value.trim();
    const refStr = document.getElementById('payRef').value.trim();
    const amount = parseFloat(document.getElementById('amt').value);

    if (!uid || !refStr || isNaN(amount) || amount <= 0) return alert("Fill all fields correctly");

    const btn = document.getElementById('execBtn');
    btn.disabled = true;

    try {
        // Final Security Check
        const refSnap = await get(ref(db, `verified_references/${refStr}`));
        if (refSnap.exists()) throw new Error("Reference already used!");

        const userSnap = await get(ref(db, `users/${uid}`));
        if (!userSnap.exists()) throw new Error("User not found!");

        const userData = userSnap.val();
        const oldBalance = parseFloat(userData.wallet || 0);
        const newBalance = oldBalance + amount;
        const timestamp = Date.now();
        const txId = "MANUAL-" + timestamp;

        const updates = {};
        updates[`users/${uid}/wallet`] = newBalance;
        updates[`verified_references/${refStr}`] = { uid, amount, date: timestamp };
        
        // Comprehensive Audit Record
        updates[`admin_deposit_logs/${txId}`] = {
            uid,
            user_email: userData.email || "N/A",
            amt: amount,
            ref: refStr,
            oldBal: oldBalance,
            newBal: newBalance,
            date: timestamp,
            admin: auth.currentUser.email
        };

        await update(ref(db), updates);
        alert(`Successfully Credited! Wallet moved from ₵${oldBalance.toFixed(2)} to ₵${newBalance.toFixed(2)}`);
        
        // Reset UI
        document.getElementById('targetUid').value = "";
        document.getElementById('payRef').value = "";
        document.getElementById('amt').value = "";
        document.getElementById('userBox').style.display = "none";

    } catch (err) {
        alert(err.message);
    } finally {
        btn.disabled = false;
    }
};
</script>
</body>
</html>
