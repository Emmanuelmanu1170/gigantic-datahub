<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Security Audit — GiganticDataHub Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .audit-card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .history-pill { font-size: 10px; padding: 2px 8px; border-radius: 4px; font-weight: 700; }
        .credit { background: #dcfce7; color: #15803d; }
        .debit { background: #fee2e2; color: #b91c1c; }
        .btn-login { background: #6366f1; color: white; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; transition: 0.2s; }
        .btn-login:hover { background: #4f46e5; transform: scale(1.05); }
        .font-mono-tight { font-family: monospace; letter-spacing: -0.5px; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-wrap justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-2xl font-black text-slate-800 tracking-tight">User Security Audit</h1>
                <p class="text-slate-500 text-sm">Real-Time Master Access: Database Sync Active</p>
            </div>
            <div class="flex items-center gap-3">
                <input type="text" id="userSearch" placeholder="Search by email..." 
                    class="px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-slate-800 text-sm">
                <a href="admin_dashboard.html" class="bg-slate-800 text-white px-5 py-2.5 rounded-xl font-bold text-sm hover:bg-black transition">Back to Home</a>
            </div>
        </header>

        <div class="audit-card overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr class="text-slate-400 text-[10px] uppercase font-bold tracking-widest">
                            <th class="p-4">User Account</th>
                            <th class="p-4">Stored Password</th>
                            <th class="p-4">Recent History</th>
                            <th class="p-4">Actual Balance</th>
                            <th class="p-4 text-center">Admin Action</th>
                        </tr>
                    </thead>
                    <tbody id="auditBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
            <div id="loading" class="p-20 text-center text-slate-400">
                <i class="fas fa-circle-notch fa-spin text-2xl mb-2 text-slate-800"></i>
                <p class="font-bold">Fetching Live Data from Firebase...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // UNIFIED SECURE CONFIG (Matches Master Terminal)
        const firebaseConfig = { 
            apiKey: "AIzaSyBmu4xukuT0Z7oD_vA9QroeO-1ZuaK8JgA", 
            authDomain: "gigantic-data.firebaseapp.com", 
            databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com", 
            projectId: "gigantic-data"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const ADMIN_EMAIL = "alenacloft0@gmail.com";
        let allUsers = {};
        let allTransactions = [];

        onAuthStateChanged(auth, (user) => {
            if (!user || user.email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
                window.location.href = "admin_login.html";
                return;
            }
            startLiveAudit();
        });

        async function startLiveAudit() {
            // Initial fetch for transactions
            const txSnap = await get(ref(db, 'transactions'));
            allTransactions = txSnap.exists() ? Object.values(txSnap.val()) : [];

            // Continuous stream for users
            onValue(ref(db, 'users'), (snapshot) => {
                allUsers = snapshot.val() || {};
                renderAuditTable();
            });

            // Keep transactions updated in real-time
            onValue(ref(db, 'transactions'), (txSnapshot) => {
                allTransactions = txSnapshot.exists() ? Object.values(txSnapshot.val()) : [];
                renderAuditTable();
            });
        }

        function renderAuditTable() {
            const body = document.getElementById('auditBody');
            const search = document.getElementById('userSearch').value.toLowerCase();
            document.getElementById('loading').style.display = 'none';
            body.innerHTML = "";

            Object.entries(allUsers).forEach(([uid, userData]) => {
                const email = (userData.email || 'N/A').toLowerCase();
                if (email.includes(search)) {
                    const userHistory = allTransactions
                        .filter(tx => tx.uid === uid)
                        .sort((a, b) => (b.timestamp || b.date) - (a.timestamp || a.date))
                        .slice(0, 3);

                    let historyHtml = userHistory.map(h => `
                        <div class="flex items-center gap-2 mb-1">
                            <span class="history-pill ${h.type === 'Credit' ? 'credit' : 'debit'}">${h.type}</span>
                            <span class="text-[10px] font-bold">₵${parseFloat(h.amount).toFixed(2)}</span>
                        </div>
                    `).join('') || '<span class="text-slate-300 text-[10px]">No History Found</span>';

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 transition";
                    tr.innerHTML = `
                        <td class="p-4">
                            <div class="text-sm font-bold text-slate-800">${userData.email}</div>
                            <div class="text-[9px] font-mono-tight text-slate-400 uppercase">${uid}</div>
                        </td>
                        <td class="p-4">
                            <span class="bg-amber-50 text-amber-700 px-2 py-1 rounded text-xs font-mono border border-amber-200">
                                ${userData.password || 'Not Saved'}
                            </span>
                        </td>
                        <td class="p-4">${historyHtml}</td>
                        <td class="p-4">
                            <div class="text-sm font-black text-slate-800">₵ ${parseFloat(userData.balance || userData.wallet || 0).toFixed(2)}</div>
                        </td>
                        <td class="p-4 text-center">
                            <button class="btn-login" onclick="impersonateUser('${uid}', '${userData.email}')">
                                <i class="fas fa-user-secret mr-1"></i> Impersonate
                            </button>
                        </td>
                    `;
                    body.appendChild(tr);
                }
            });
        }

        window.impersonateUser = (uid, email) => {
            if (confirm(`Authorize Session Takeover for: ${email}?`)) {
                sessionStorage.setItem('impersonate_uid', uid);
                sessionStorage.setItem('impersonate_email', email);
                sessionStorage.setItem('isAdminImpersonating', 'true');
                window.location.href = "dashboard.html";
            }
        };

        document.getElementById('userSearch').addEventListener('input', renderAuditTable);
    </script>
</body>
</html>
