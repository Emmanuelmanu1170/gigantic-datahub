<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Ledger - Gigantic Data Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #001f3f; --accent: #ff8c00; --bg: #f8fafc;
            --success: #10b981; --danger: #ef4444; --card-bg: #ffffff;
        }
        [data-theme="dark"] {
            --bg: #0b0e14; --card-bg: #161b22; --primary: #010409;
        }
        body { background: var(--bg); color: #1e293b; font-family: 'Inter', sans-serif; transition: 0.3s; }
        [data-theme="dark"] body { color: #c9d1d9; }

        header { background: var(--primary); color: white; padding: 20px; position: sticky; top: 0; z-index: 100; }
        
        .auth-card {
            background: linear-gradient(135deg, var(--primary) 0%, #003366 100%);
            margin: 15px; padding: 15px; border-radius: 16px; color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .auth-label { font-size: 10px; font-weight: 800; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; }
        .auth-value { font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 6px; }

        .stats-ribbon { 
            background: var(--card-bg); padding: 15px; display: flex; justify-content: space-around; 
            border-bottom: 1px solid rgba(0,0,0,0.05); position: sticky; top: 68px; z-index: 90;
        }

        .container { padding: 10px 15px; max-width: 600px; margin: auto; }
        
        .tx-card { 
            background: var(--card-bg); border-radius: 18px; padding: 14px; margin-bottom: 10px; 
            display: flex; gap: 12px; align-items: center; border: 1px solid rgba(0,0,0,0.03);
        }

        .icon-box { width: 45px; height: 45px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .bg-deposit { background: #dcfce7; color: var(--success); }
        .bg-purchase { background: #fee2e2; color: var(--danger); }
        .bg-bonus { background: #e0f2fe; color: #0ea5e9; }

        .tx-info { flex: 1; min-width: 0; }
        .tx-info h4 { font-size: 0.85rem; font-weight: 800; margin-bottom: 2px; text-transform: uppercase; letter-spacing: -0.3px; }
        .sub-text { font-size: 10px; color: #64748b; font-weight: 600; }

        .date-divider { font-size: 0.7rem; font-weight: 900; color: #94a3b8; text-transform: uppercase; margin: 25px 0 12px 5px; letter-spacing: 1.5px; display: flex; align-items: center; gap: 10px; }
        .date-divider::after { content: ""; flex: 1; height: 1px; background: rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<header class="flex justify-between items-center">
    <div class="flex items-center gap-4">
        <a href="dashboard.html" class="text-white"><i class="fas fa-chevron-left"></i></a>
        <h3 id="pageHeader" class="font-black text-lg uppercase tracking-tighter">Finance Ledger</h3>
    </div>
    <div class="flex gap-4">
        <i class="fas fa-redo-alt cursor-pointer" onclick="location.reload()"></i>
    </div>
</header>

<div class="auth-card">
    <div class="flex justify-between items-center mb-3">
        <span class="auth-label">Secure Session</span>
        <i class="fas fa-shield-alt text-emerald-400"></i>
    </div>
    <div class="grid grid-cols-2 gap-4">
        <div>
            <p class="auth-label">Email Address</p>
            <p class="auth-value" id="authEmail">...</p>
        </div>
        <div>
            <p class="auth-label">Identity SID</p>
            <p class="auth-value" id="authUid">...</p>
        </div>
    </div>
</div>

<div class="stats-ribbon">
    <div class="text-center">
        <p class="text-[9px] font-black text-slate-400 uppercase">Cash Flow</p>
        <h2 id="totalFlow" class="text-xl font-black text-blue-600">₵0.00</h2>
    </div>
    <div class="text-center">
        <p class="text-[9px] font-black text-slate-400 uppercase">Records</p>
        <h2 id="recordCount" class="text-xl font-black text-orange-500">0</h2>
    </div>
</div>

<div class="container">
    <div id="loading" class="text-center py-20 text-slate-400">
        <i class="fas fa-circle-notch fa-spin fa-2x"></i>
        <p class="mt-4 text-xs font-bold uppercase tracking-widest">Reconciling Database...</p>
    </div>
    <div id="txList"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBmu4xukuT0Z7oD_vA9QroeO-1ZuaK8JgA",
    authDomain: "gigantic-data.firebaseapp.com",
    databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
    projectId: "gigantic-data"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const ADMIN_EMAIL = "alenacloft0@gmail.com";

onAuthStateChanged(auth, async (user) => {
    if (user) {
        document.getElementById('authEmail').innerText = user.email;
        const impersonateUid = sessionStorage.getItem('impersonate_uid');
        const isAuditing = sessionStorage.getItem('isAdminImpersonating') === 'true';
        const activeUid = isAuditing ? impersonateUid : user.uid;
        
        document.getElementById('authUid').innerText = activeUid.substring(0, 10) + "...";
        await setupLedger(user, activeUid, isAuditing);
    } else {
        window.location.href = "login.html";
    }
});

async function setupLedger(user, activeUid, isAuditing) {
    const isAdmin = user.email === ADMIN_EMAIL;
    document.getElementById('pageHeader').innerText = isAuditing ? "Audit Trace" : (isAdmin ? "Global Ledger" : "Transaction History");

    const dataPaths = [
        { path: 'transactions', type: 'purchase' },
        { path: 'topupNotes', type: 'deposit' },
        { path: 'allSuccessfulPayments', type: 'deposit' },
        { path: 'processed_payments', type: 'deposit' },
        { path: 'withdrawal_requests', type: 'bonus' }
    ];

    let combinedLogs = [];

    const fetchPromises = dataPaths.map(async (source) => {
        try {
            let dbRef;
            // Admin Global View vs User Personalized View
            if (isAdmin && !isAuditing) {
                dbRef = ref(db, source.path);
            } else {
                if (source.path === 'topupNotes') {
                    dbRef = ref(db, `topupNotes/${activeUid}`);
                } else {
                    dbRef = query(ref(db, source.path), orderByChild('uid'), equalTo(activeUid));
                }
            }

            const snapshot = await get(dbRef);
            if (snapshot.exists()) {
                const data = snapshot.val();
                
                // Process the raw data based on structure
                if (source.path === 'topupNotes' && isAdmin && !isAuditing) {
                    Object.entries(data).forEach(([uId, notes]) => {
                        Object.entries(notes).forEach(([key, val]) => {
                            combinedLogs.push(formatEntry(key, val, 'deposit', uId));
                        });
                    });
                } else {
                    Object.entries(data).forEach(([key, val]) => {
                        combinedLogs.push(formatEntry(key, val, source.type, val.uid || activeUid));
                    });
                }
            }
        } catch (e) {
            console.warn("Path skipped:", source.path, e.message);
        }
    });

    await Promise.all(fetchPromises);
    renderLogs(combinedLogs);
}

function formatEntry(id, val, type, uid) {
    // Ensure numeric parsing of the real value
    const amount = parseFloat(val.amount || 0);
    
    return {
        id, uid,
        amount: amount,
        desc: val.description || val.plan || val.network || val.method || (type === 'deposit' ? 'Wallet Deposit' : (type === 'bonus' ? 'Referral Reward' : 'Purchase')),
        ts: val.timestamp || val.date || Date.now(),
        ref: val.reference || val.orderId || id.substring(0, 12),
        type, 
        status: val.status || 'Success'
    };
}

function renderLogs(logs) {
    const listDiv = document.getElementById('txList');
    document.getElementById('loading').style.display = 'none';

    // Remove duplicates and sort by timestamp
    const uniqueLogs = Array.from(new Map(logs.map(item => [item.id, item])).values())
                            .sort((a, b) => b.ts - a.ts);

    if (uniqueLogs.length === 0) {
        listDiv.innerHTML = `<div class="text-center py-20 opacity-30"><i class="fas fa-receipt fa-4x mb-4"></i><p class="font-bold">NO RECORDS FOUND</p></div>`;
        return;
    }

    let totalVolume = 0;
    let lastDate = "";
    listDiv.innerHTML = "";

    uniqueLogs.forEach(log => {
        totalVolume += log.amount;
        const d = new Date(log.ts);
        const dateLabel = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        
        if (dateLabel !== lastDate) {
            listDiv.innerHTML += `<div class="date-divider">${dateLabel}</div>`;
            lastDate = dateLabel;
        }

        const typeClass = log.type === 'deposit' ? 'bg-deposit' : (log.type === 'bonus' ? 'bg-bonus' : 'bg-purchase');
        const iconClass = log.type === 'deposit' ? 'fa-arrow-up' : (log.type === 'bonus' ? 'fa-gift' : 'fa-arrow-down');
        const amountColor = (log.type === 'deposit' || log.type === 'bonus') ? 'text-emerald-500' : 'text-rose-500';
        const sign = (log.type === 'deposit' || log.type === 'bonus') ? '+' : '-';

        const time = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        listDiv.innerHTML += `
            <div class="tx-card">
                <div class="icon-box ${typeClass}">
                    <i class="fas ${iconClass}"></i>
                </div>
                <div class="tx-info">
                    <h4>${log.desc}</h4>
                    <p class="sub-text">${time} • REF: ${log.ref.toUpperCase()}</p>
                </div>
                <div class="text-right">
                    <span class="block font-black text-sm ${amountColor}">
                        ${sign}₵${log.amount.toFixed(2)}
                    </span>
                    <span class="text-[8px] font-black px-1.5 py-0.5 rounded bg-slate-100 text-slate-500 uppercase">${log.status}</span>
                </div>
            </div>`;
    });

    document.getElementById('recordCount').innerText = uniqueLogs.length;
    document.getElementById('totalFlow').innerText = `₵${totalVolume.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
}
</script>
</body>
</html>
