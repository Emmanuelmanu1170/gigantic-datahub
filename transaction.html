<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Ledger - Gigantic Data Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #001f3f; --accent: #ff8c00; --bg: #f8fafc;
            --success: #10b981; --danger: #ef4444; --card-bg: #ffffff;
        }
        [data-theme="dark"] {
            --bg: #0b0e14; --card-bg: #161b22; --primary: #010409;
        }
        body { background: var(--bg); color: #1e293b; font-family: 'Inter', sans-serif; }
        [data-theme="dark"] body { color: #c9d1d9; }

        header { background: var(--primary); color: white; padding: 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .stats-ribbon { 
            background: var(--card-bg); padding: 15px; display: flex; justify-content: space-around; 
            border-bottom: 1px solid rgba(0,0,0,0.05); position: sticky; top: 68px; z-index: 90;
        }

        .container { padding: 15px; max-width: 600px; margin: auto; }
        
        .tx-card { 
            background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 12px; 
            display: flex; gap: 12px; align-items: center; border: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .tx-card:hover { transform: translateY(-2px); }

        .icon-box { width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .bg-deposit { background: #dcfce7; color: var(--success); }
        .bg-purchase { background: #fee2e2; color: var(--danger); }

        .tx-info { flex: 1; min-width: 0; }
        .tx-info h4 { font-size: 0.85rem; font-weight: 800; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .uid-pill { font-family: monospace; font-size: 9px; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; color: #64748b; }
        [data-theme="dark"] .uid-pill { background: #30363d; color: #8b949e; }

        .date-divider { font-size: 0.7rem; font-weight: 900; color: #94a3b8; text-transform: uppercase; margin: 25px 0 10px 5px; letter-spacing: 1px; }
    </style>
</head>
<body>

<header class="flex justify-between items-center">
    <div class="flex items-center gap-4">
        <a href="dashboard.html" class="text-white"><i class="fas fa-arrow-left"></i></a>
        <h3 id="pageHeader" class="font-black text-lg">Activity Ledger</h3>
    </div>
    <i class="fas fa-sync-alt cursor-pointer" onclick="location.reload()"></i>
</header>

<div class="stats-ribbon">
    <div class="text-center">
        <p class="text-[10px] font-bold text-slate-400 uppercase">Cash Flow</p>
        <h2 id="totalFlow" class="font-black text-blue-600">₵0.00</h2>
    </div>
    <div class="text-center">
        <p class="text-[10px] font-bold text-slate-400 uppercase">Records</p>
        <h2 id="recordCount" class="font-black text-orange-500">0</h2>
    </div>
</div>

<div class="container">
    <div id="loading" class="text-center py-20 text-slate-400">
        <i class="fas fa-spinner fa-spin fa-2x"></i>
        <p class="mt-2 text-sm font-bold">Fetching Transactions...</p>
    </div>
    <div id="txList"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBmu4xukuT0Z7oD_vA9QroeO-1ZuaK8JgA",
    authDomain: "gigantic-data.firebaseapp.com",
    databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
    projectId: "gigantic-data"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const ADMIN_EMAIL = "alenacloft0@gmail.com";

onAuthStateChanged(auth, (user) => {
    if (user) {
        setupLedger(user);
    } else {
        window.location.href = "login.html";
    }
});

function setupLedger(user) {
    const isAdmin = user.email === ADMIN_EMAIL;
    const impersonateUid = sessionStorage.getItem('impersonate_uid');
    const isAuditing = sessionStorage.getItem('isAdminImpersonating') === 'true';

    let txRef;
    
    // DECISION ENGINE: What data are we allowed to see?
    if (isAdmin && !isAuditing) {
        document.getElementById('pageHeader').innerText = "Global Activity";
        txRef = ref(db, 'transactions'); // Admin sees everything
    } else {
        const targetUid = isAuditing ? impersonateUid : user.uid;
        document.getElementById('pageHeader').innerText = isAuditing ? "User Audit" : "My History";
        txRef = query(ref(db, 'transactions'), orderByChild('uid'), equalTo(targetUid));
    }

    onValue(txRef, (snap) => {
        const listDiv = document.getElementById('txList');
        document.getElementById('loading').style.display = 'none';
        
        if (!snap.exists()) {
            listDiv.innerHTML = `<div class="text-center py-20 opacity-50"><i class="fas fa-box-open fa-3x mb-4"></i><p>No transactions found</p></div>`;
            return;
        }

        const data = snap.val();
        let logs = Object.entries(data).map(([id, v]) => ({
            id, ...v, ts: v.timestamp || v.date || 0
        })).sort((a, b) => b.ts - a.ts);

        let totalVolume = 0;
        document.getElementById('recordCount').innerText = logs.length;
        listDiv.innerHTML = "";

        let lastDate = "";
        logs.forEach(log => {
            const amount = parseFloat(log.amount || 0);
            totalVolume += amount;

            const d = new Date(log.ts);
            const dateLabel = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            
            if (dateLabel !== lastDate) {
                listDiv.innerHTML += `<div class="date-divider">${dateLabel}</div>`;
                lastDate = dateLabel;
            }

            const isDeposit = log.type === "Credit" || log.type === "Top-up" || log.description?.toLowerCase().includes("top-up");
            const time = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            listDiv.innerHTML += `
                <div class="tx-card">
                    <div class="icon-box ${isDeposit ? 'bg-deposit' : 'bg-purchase'}">
                        <i class="fas ${isDeposit ? 'fa-wallet' : 'fa-shopping-bag'}"></i>
                    </div>
                    <div class="tx-info">
                        <h4>${log.description || (isDeposit ? 'Wallet Top-up' : 'Service Payment')}</h4>
                        <p class="text-[10px] text-slate-400 font-bold uppercase">${time} • REF: ${log.id.substring(0,10)}</p>
                        ${isAdmin && !isAuditing ? `<span class="uid-pill">UID: ${log.uid}</span>` : ''}
                    </div>
                    <div class="text-right">
                        <span class="block font-black text-sm" style="color: ${isDeposit ? '#10b981' : '#ef4444'}">
                            ${isDeposit ? '+' : '-'}₵${amount.toFixed(2)}
                        </span>
                        <span class="text-[9px] font-bold text-slate-400 uppercase">Success</span>
                    </div>
                </div>`;
        });

        document.getElementById('totalFlow').innerText = `₵${totalVolume.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
    }, (err) => {
        console.error(err);
        document.getElementById('txList').innerHTML = `<div class="p-10 text-center text-red-500 font-bold">Security Block: ${err.message}</div>`;
    });
}
</script>
</body>
</html>
