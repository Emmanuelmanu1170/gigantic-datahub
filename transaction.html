<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction History | GiganticDataHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #0f172a; --accent: #3b82f6; --bg: #f8fafc;
            --success: #10b981; --danger: #ef4444; --card-bg: #ffffff;
        }
        [data-theme="dark"] {
            --bg: #020617; --card-bg: #0f172a; --primary: #1e293b;
        }
        body { background: var(--bg); color: #1e293b; font-family: 'Inter', sans-serif; transition: 0.3s; }
        [data-theme="dark"] body { color: #f1f5f9; }

        header { background: var(--primary); color: white; padding: 20px; position: sticky; top: 0; z-index: 100; }
        
        .summary-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            margin: 15px; padding: 20px; border-radius: 24px; color: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .label { font-size: 10px; font-weight: 800; opacity: 0.5; text-transform: uppercase; letter-spacing: 1px; }

        .container { padding: 10px 15px; max-width: 600px; margin: auto; }
        
        .tx-card { 
            background: var(--card-bg); border-radius: 20px; padding: 16px; margin-bottom: 12px; 
            display: flex; gap: 14px; align-items: center; border: 1px solid rgba(0,0,0,0.03);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
        }

        .icon-box { width: 48px; height: 48px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .bg-credit { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .bg-debit { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        .tx-info { flex: 1; min-width: 0; }
        .tx-info h4 { font-size: 0.85rem; font-weight: 800; margin-bottom: 2px; text-transform: uppercase; color: var(--accent); }
        .sub-text { font-size: 10px; color: #64748b; font-weight: 600; font-family: monospace; }

        .date-divider { font-size: 10px; font-weight: 900; color: #94a3b8; text-transform: uppercase; margin: 30px 0 15px 5px; display: flex; align-items: center; gap: 10px; }
        .date-divider::after { content: ""; flex: 1; height: 1px; background: rgba(0,0,0,0.05); }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--card-bg); display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid rgba(0,0,0,0.05); }
    </style>
</head>
<body class="pb-24">

<header class="flex justify-between items-center">
    <div class="flex items-center gap-4">
        <a href="dashboard.html" class="text-white"><i class="fas fa-chevron-left"></i></a>
        <h3 class="font-black text-sm uppercase tracking-widest">Financial Ledger</h3>
    </div>
    <i class="fas fa-sync-alt cursor-pointer text-blue-400" onclick="location.reload()"></i>
</header>

<div class="summary-card">
    <div class="flex justify-between items-center mb-4">
        <span class="label">Reconciled Identity</span>
        <i class="fas fa-fingerprint text-blue-400"></i>
    </div>
    <p class="text-xs font-bold text-slate-400 mb-1" id="userEmail">Loading...</p>
    <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-white/5">
        <div>
            <p class="label">Total Inflow</p>
            <p id="totalIn" class="text-lg font-black text-emerald-400">₵0.00</p>
        </div>
        <div>
            <p class="label">Total Outflow</p>
            <p id="totalOut" class="text-lg font-black text-rose-400">₵0.00</p>
        </div>
    </div>
</div>

<div class="container">
    <div id="loading" class="text-center py-20">
        <i class="fas fa-circle-notch fa-spin fa-2x text-blue-500"></i>
        <p class="mt-4 text-[10px] font-black text-slate-500 uppercase tracking-widest">Syncing with Cloud Database...</p>
    </div>
    <div id="txList"></div>
</div>

<nav class="bottom-nav">
    <a href="dashboard.html" class="text-slate-400 text-center text-[10px] font-bold uppercase"><i class="fas fa-house block text-xl mb-1"></i>Home</a>
    <a href="order.html" class="text-slate-400 text-center text-[10px] font-bold uppercase"><i class="fas fa-plus-circle block text-xl mb-1"></i>New</a>
    <a href="transaction.html" class="text-blue-500 text-center text-[10px] font-bold uppercase"><i class="fas fa-history block text-xl mb-1"></i>Ledger</a>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBmu4xukuT0Z7oD_vA9QroeO-1ZuaK8JgA",
        authDomain: "gigantic-data.firebaseapp.com",
        databaseURL: "https://gigantic-data-default-rtdb.firebaseio.com",
        projectId: "gigantic-data"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            document.getElementById('userEmail').innerText = user.email;
            await loadTransactions(user.uid);
        } else {
            window.location.replace("login.html");
        }
    });

    async function loadTransactions(uid) {
        const paths = [
            { path: 'transactions', type: 'auto' },
            { path: `topupNotes/${uid}`, type: 'credit' },
            { path: `user_orders/${uid}`, type: 'debit' }
        ];

        let combined = [];

        for (let source of paths) {
            try {
                let snap;
                if (source.path === 'transactions') {
                    // Query global transactions node filtered by UID
                    const q = query(ref(db, source.path), orderByChild('uid'), equalTo(uid));
                    snap = await get(q);
                } else {
                    snap = await get(ref(db, source.path));
                }

                if (snap.exists()) {
                    Object.entries(snap.val()).forEach(([key, val]) => {
                        const amount = parseFloat(val.amount || val.price || 0);
                        if (amount > 0) {
                            // Determine type if not explicit
                            let finalType = source.type;
                            if (finalType === 'auto') {
                                finalType = (val.type === 'deposit' || val.type === 'credit') ? 'credit' : 'debit';
                            }

                            combined.push({
                                id: key,
                                amount,
                                type: finalType,
                                desc: val.description || val.plan || (finalType === 'credit' ? 'Wallet Top-up' : 'Data Purchase'),
                                ts: val.timestamp || Date.now(),
                                status: (val.status || 'Success').toUpperCase()
                            });
                        }
                    });
                }
            } catch (e) { console.warn("Node sync failed:", source.path); }
        }

        renderHistory(combined);
    }

    function renderHistory(logs) {
        const listDiv = document.getElementById('txList');
        document.getElementById('loading').style.display = 'none';

        // Sort by Newest and Remove Duplicates
        const sorted = Array.from(new Map(logs.map(item => [item.id, item])).values())
                            .sort((a, b) => b.ts - a.ts);

        if (sorted.length === 0) {
            listDiv.innerHTML = `<div class="text-center py-20 opacity-30 uppercase font-black text-xs tracking-widest"><i class="fas fa-folder-open fa-3x mb-4"></i><p>No Records Found</p></div>`;
            return;
        }

        let totalIn = 0, totalOut = 0, lastDate = "";
        listDiv.innerHTML = "";

        sorted.forEach(log => {
            if (log.type === 'credit') totalIn += log.amount; else totalOut += log.amount;

            const d = new Date(log.ts);
            const dateLabel = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            if (dateLabel !== lastDate) {
                listDiv.innerHTML += `<div class="date-divider">${dateLabel}</div>`;
                lastDate = dateLabel;
            }

            const isCredit = log.type === 'credit';
            listDiv.innerHTML += `
                <div class="tx-card">
                    <div class="icon-box ${isCredit ? 'bg-credit' : 'bg-debit'}">
                        <i class="fas ${isCredit ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                    </div>
                    <div class="tx-info">
                        <h4>${log.desc}</h4>
                        <p class="sub-text">${d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} • ID: ${log.id.slice(-8).toUpperCase()}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-black text-sm ${isCredit ? 'text-emerald-500' : 'text-rose-500'}">
                            ${isCredit ? '+' : '-'}₵${log.amount.toFixed(2)}
                        </p>
                        <span class="text-[8px] font-black px-2 py-0.5 rounded bg-slate-100 text-slate-500 uppercase">${log.status}</span>
                    </div>
                </div>`;
        });

        document.getElementById('totalIn').innerText = `₵${totalIn.toFixed(2)}`;
        document.getElementById('totalOut').innerText = `₵${totalOut.toFixed(2)}`;
    }
</script>
</body>
</html>
